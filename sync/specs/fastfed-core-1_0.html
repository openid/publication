<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>FastFed Core 1.0 - draft 03</title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
      /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
      a.info {
          /* This is the key. */
          position: relative;
          z-index: 24;
          text-decoration: none;
      }
      a.info:hover {
          z-index: 25;
          color: #FFF; background-color: #900;
      }
      a.info span { display: none; }
      a.info:hover span.info {
          /* The span will display just on :hover state. */
          display: block;
          position: absolute;
          font-size: smaller;
          top: 2em; left: -5em; width: 15em;
          padding: 2px; border: 1px solid #333;
          color: #900; background-color: #EEE;
          text-align: left;
      }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  max-width: 55em;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.1.1" rel="Chapter" title="1.1 Requirements Notation and Conventions">
<link href="#rfc.section.1.2" rel="Chapter" title="1.2 Terminology">
<link href="#rfc.section.2" rel="Chapter" title="2 Overview">
<link href="#rfc.section.2.1" rel="Chapter" title="2.1 Metadata">
<link href="#rfc.section.2.2" rel="Chapter" title="2.2 Endpoints">
<link href="#rfc.section.2.3" rel="Chapter" title="2.3 Endpoint Discovery">
<link href="#rfc.section.2.4" rel="Chapter" title="2.4 FastFed Handshake">
<link href="#rfc.section.2.5" rel="Chapter" title="2.5 User Schemas and Provisioning">
<link href="#rfc.section.2.5.1" rel="Chapter" title="2.5.1 Schema Selection">
<link href="#rfc.section.2.5.2" rel="Chapter" title="2.5.2 Attribute Filtering">
<link href="#rfc.section.3" rel="Chapter" title="3 Metadata">
<link href="#rfc.section.3.1" rel="Chapter" title="3.1 Metadata Serialization">
<link href="#rfc.section.3.2" rel="Chapter" title="3.2 Metadata Languages and Scripts">
<link href="#rfc.section.3.3" rel="Chapter" title="3.3 Provider Metadata">
<link href="#rfc.section.3.3.1" rel="Chapter" title="3.3.1 Capabilities">
<link href="#rfc.section.3.3.2" rel="Chapter" title="3.3.2 Display Settings">
<link href="#rfc.section.3.3.3" rel="Chapter" title="3.3.3 Provider Contact Information">
<link href="#rfc.section.3.3.4" rel="Chapter" title="3.3.4 Attribute Reference">
<link href="#rfc.section.3.3.4.1" rel="Chapter" title="3.3.4.1 Using the SCIM 2.0 Schema Grammar for Attribute References">
<link href="#rfc.section.3.3.5" rel="Chapter" title="3.3.5 Desired Attributes">
<link href="#rfc.section.3.3.6" rel="Chapter" title="3.3.6 User Attribute">
<link href="#rfc.section.3.3.7" rel="Chapter" title="3.3.7 Common Provider Metadata">
<link href="#rfc.section.3.3.8" rel="Chapter" title="3.3.8 Identity Provider Metadata">
<link href="#rfc.section.3.3.9" rel="Chapter" title="3.3.9 Application Provider Metadata">
<link href="#rfc.section.4" rel="Chapter" title="4 Metadata Endpoints">
<link href="#rfc.section.4.1" rel="Chapter" title="4.1 Provider Metadata Endpoint">
<link href="#rfc.section.4.1.1" rel="Chapter" title="4.1.1 Endpoint Validation">
<link href="#rfc.section.4.1.2" rel="Chapter" title="4.1.2 Endpoint Discovery">
<link href="#rfc.section.4.1.2.1" rel="Chapter" title="4.1.2.1 Email-based Discovery via WebFinger">
<link href="#rfc.section.4.1.2.1.1" rel="Chapter" title="4.1.2.1.1 WebFinger Endpoints">
<link href="#rfc.section.4.1.2.1.2" rel="Chapter" title="4.1.2.1.2 WebFinger Queries">
<link href="#rfc.section.4.1.2.2" rel="Chapter" title="4.1.2.2 Alternative Discovery Mechanisms">
<link href="#rfc.section.4.1.3" rel="Chapter" title="4.1.3 Read Request">
<link href="#rfc.section.4.1.4" rel="Chapter" title="4.1.4 Read Response">
<link href="#rfc.section.4.1.5" rel="Chapter" title="4.1.5 Metadata Refresh">
<link href="#rfc.section.5" rel="Chapter" title="5 Provider Compatibility Evaluation">
<link href="#rfc.section.5.1" rel="Chapter" title="5.1 Handling Empty Capabilities">
<link href="#rfc.section.6" rel="Chapter" title="6 Provider Authentication Methods">
<link href="#rfc.section.6.1" rel="Chapter" title="6.1 Key   Discovery">
<link href="#rfc.section.6.2" rel="Chapter" title="6.2 Key Rotation">
<link href="#rfc.section.6.3" rel="Chapter" title="6.3 Algorithm Selection">
<link href="#rfc.section.6.4" rel="Chapter" title="6.4 JWT Requirements">
<link href="#rfc.section.6.5" rel="Chapter" title="6.5 Protocol-specific Key Materials">
<link href="#rfc.section.6.6" rel="Chapter" title="6.6 OAuth 2.0 with JWT Profile">
<link href="#rfc.section.7" rel="Chapter" title="7 FastFed Handshake">
<link href="#rfc.section.7.1" rel="Chapter" title="7.1 Common Considerations">
<link href="#rfc.section.7.1.1" rel="Chapter" title="7.1.1 TLS Requirements">
<link href="#rfc.section.7.1.2" rel="Chapter" title="7.1.2 HTTP Redirects">
<link href="#rfc.section.7.1.3" rel="Chapter" title="7.1.3 Query String Serialization">
<link href="#rfc.section.7.1.4" rel="Chapter" title="7.1.4 Halting the Handshake">
<link href="#rfc.section.7.1.5" rel="Chapter" title="7.1.5 Handling Updates and Duplicates">
<link href="#rfc.section.7.2" rel="Chapter" title="7.2 Handshake Flow">
<link href="#rfc.section.7.2.1" rel="Chapter" title="7.2.1 Handshake Initiation at Application Provider">
<link href="#rfc.section.7.2.1.1" rel="Chapter" title="7.2.1.1 Prerequisites">
<link href="#rfc.section.7.2.1.2" rel="Chapter" title="7.2.1.2 Application Provider Reads Identity Provider Metadata">
<link href="#rfc.section.7.2.1.3" rel="Chapter" title="7.2.1.3 Application Provider Checks For Duplicates">
<link href="#rfc.section.7.2.1.4" rel="Chapter" title="7.2.1.4 Application Provider Verifies Compatibility with Identity Provider">
<link href="#rfc.section.7.2.1.5" rel="Chapter" title="7.2.1.5 Application Provider Obtains Confirmation from Administrator">
<link href="#rfc.section.7.2.1.6" rel="Chapter" title="7.2.1.6 Application Provider Whitelists the Identity Provider">
<link href="#rfc.section.7.2.1.7" rel="Chapter" title="7.2.1.7 Application Provider Sends Request to the Identity Provider">
<link href="#rfc.section.7.2.1.7.1" rel="Chapter" title="7.2.1.7.1 HTTP Redirect">
<link href="#rfc.section.7.2.1.7.2" rel="Chapter" title="7.2.1.7.2 Alternative Channel">
<link href="#rfc.section.7.2.2" rel="Chapter" title="7.2.2 Handshake Receipt by Identity Provider">
<link href="#rfc.section.7.2.2.1" rel="Chapter" title="7.2.2.1 Identity Provider Authenticates Administrator">
<link href="#rfc.section.7.2.2.2" rel="Chapter" title="7.2.2.2 Identity Provider Reads Application Provider Metadata">
<link href="#rfc.section.7.2.2.3" rel="Chapter" title="7.2.2.3 Identity Provider Verifies Compatibility">
<link href="#rfc.section.7.2.2.4" rel="Chapter" title="7.2.2.4 Identity Provider Checks For Duplicates and Updates">
<link href="#rfc.section.7.2.2.5" rel="Chapter" title="7.2.2.5 Identity Provider Obtains Confirmation from Administrator">
<link href="#rfc.section.7.2.3" rel="Chapter" title="7.2.3 Handshake Registration">
<link href="#rfc.section.7.2.3.1" rel="Chapter" title="7.2.3.1 Identity Provider Sends Registration Request">
<link href="#rfc.section.7.2.3.2" rel="Chapter" title="7.2.3.2 Application Provider Handles Registration Request">
<link href="#rfc.section.7.2.3.3" rel="Chapter" title="7.2.3.3 Application Provider Sends Registration Response">
<link href="#rfc.section.7.2.3.4" rel="Chapter" title="7.2.3.4 Identity Provider Handles Registration Response">
<link href="#rfc.section.7.2.4" rel="Chapter" title="7.2.4 Handshake Finalization">
<link href="#rfc.section.7.2.4.1" rel="Chapter" title="7.2.4.1 Identity Provider Sends Finalization Request">
<link href="#rfc.section.7.2.4.2" rel="Chapter" title="7.2.4.2 Application Provider Handles Finalization Request">
<link href="#rfc.section.7.2.4.3" rel="Chapter" title="7.2.4.3 Application Provider Sends Finalization Response">
<link href="#rfc.section.7.2.4.4" rel="Chapter" title="7.2.4.4 Identity Provider Handles Finalization Response">
<link href="#rfc.section.8" rel="Chapter" title="8 Security Considerations">
<link href="#rfc.section.8.1" rel="Chapter" title="8.1 Strong Authentication of Administrators">
<link href="#rfc.section.8.2" rel="Chapter" title="8.2 Protection from Unintended Approvals">
<link href="#rfc.section.8.3" rel="Chapter" title="8.3 Evaluating Trustworthiness of Applications">
<link href="#rfc.section.9" rel="Chapter" title="9 IANA Considerations">
<link href="#rfc.references" rel="Chapter" title="10 Normative References">
<link href="#rfc.appendix.A" rel="Chapter" title="A Acknowledgements">
<link href="#rfc.appendix.B" rel="Chapter" title="B Notices">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content="xml2rfc version 2.47.0 - https://tools.ietf.org/tools/xml2rfc" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />

  <meta name="dct.creator" content="McAdams, D." />
  <meta name="dct.identifier" content="urn:ietf:id:fastfed-core-1_0" />
  <meta name="dct.issued" scheme="ISO8601" content="2020-10-07" />
  <meta name="dct.abstract" content="FastFed simplifies the administrative effort to configure identity federation between an identity provider and a hosted application. The specification defines metadata documents, APIs, and flows to enable an administrator to quickly connect two providers that support common standards such as OpenID Connect, SAML, and SCIM, and allows configuration changes to be communicated directly between the identity provider and hosted application on a recurring basis.   " />
  <meta name="description" content="FastFed simplifies the administrative effort to configure identity federation between an identity provider and a hosted application. The specification defines metadata documents, APIs, and flows to enable an administrator to quickly connect two providers that support common standards such as OpenID Connect, SAML, and SCIM, and allows configuration changes to be communicated directly between the identity provider and hosted application on a recurring basis.   " />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left"></td>
<td class="right">D. McAdams</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">Amazon</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">October 7, 2020</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">FastFed Core 1.0 - draft 03<br />
  <span class="filename">fastfed-core-1_0</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>FastFed simplifies the administrative effort to configure identity federation between an identity provider and a hosted application. The specification defines metadata documents, APIs, and flows to enable an administrator to quickly connect two providers that support common standards such as OpenID Connect, SAML, and SCIM, and allows configuration changes to be communicated directly between the identity provider and hosted application on a recurring basis.  </p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<ul><li>1.1.   <a href="#rfc.section.1.1">Requirements Notation and Conventions</a>
</li>
<li>1.2.   <a href="#rfc.section.1.2">Terminology</a>
</li>
</ul><li>2.   <a href="#rfc.section.2">Overview</a>
</li>
<ul><li>2.1.   <a href="#rfc.section.2.1">Metadata</a>
</li>
<li>2.2.   <a href="#rfc.section.2.2">Endpoints</a>
</li>
<li>2.3.   <a href="#rfc.section.2.3">Endpoint Discovery</a>
</li>
<li>2.4.   <a href="#rfc.section.2.4">FastFed Handshake</a>
</li>
<li>2.5.   <a href="#rfc.section.2.5">User Schemas and Provisioning</a>
</li>
<ul><li>2.5.1.   <a href="#rfc.section.2.5.1">Schema Selection</a>
</li>
<li>2.5.2.   <a href="#rfc.section.2.5.2">Attribute Filtering</a>
</li>
</ul></ul><li>3.   <a href="#rfc.section.3">Metadata</a>
</li>
<ul><li>3.1.   <a href="#rfc.section.3.1">Metadata Serialization</a>
</li>
<li>3.2.   <a href="#rfc.section.3.2">Metadata Languages and Scripts</a>
</li>
<li>3.3.   <a href="#rfc.section.3.3">Provider Metadata</a>
</li>
<ul><li>3.3.1.   <a href="#rfc.section.3.3.1">Capabilities</a>
</li>
<li>3.3.2.   <a href="#rfc.section.3.3.2">Display Settings</a>
</li>
<li>3.3.3.   <a href="#rfc.section.3.3.3">Provider Contact Information</a>
</li>
<li>3.3.4.   <a href="#rfc.section.3.3.4">Attribute Reference</a>
</li>
<ul><li>3.3.4.1.   <a href="#rfc.section.3.3.4.1">Using the SCIM 2.0 Schema Grammar for Attribute References</a>
</li>
</ul><li>3.3.5.   <a href="#rfc.section.3.3.5">Desired Attributes</a>
</li>
<li>3.3.6.   <a href="#rfc.section.3.3.6">User Attribute</a>
</li>
<li>3.3.7.   <a href="#rfc.section.3.3.7">Common Provider Metadata</a>
</li>
<li>3.3.8.   <a href="#rfc.section.3.3.8">Identity Provider Metadata</a>
</li>
<li>3.3.9.   <a href="#rfc.section.3.3.9">Application Provider Metadata</a>
</li>
</ul></ul><li>4.   <a href="#rfc.section.4">Metadata Endpoints</a>
</li>
<ul><li>4.1.   <a href="#rfc.section.4.1">Provider Metadata Endpoint</a>
</li>
<ul><li>4.1.1.   <a href="#rfc.section.4.1.1">Endpoint Validation</a>
</li>
<li>4.1.2.   <a href="#rfc.section.4.1.2">Endpoint Discovery</a>
</li>
<ul><li>4.1.2.1.   <a href="#rfc.section.4.1.2.1">Email-based Discovery via WebFinger</a>
</li>
<ul><li>4.1.2.1.1.   <a href="#rfc.section.4.1.2.1.1">WebFinger Endpoints</a>
</li>
<li>4.1.2.1.2.   <a href="#rfc.section.4.1.2.1.2">WebFinger Queries</a>
</li>
</ul><li>4.1.2.2.   <a href="#rfc.section.4.1.2.2">Alternative Discovery Mechanisms</a>
</li>
</ul><li>4.1.3.   <a href="#rfc.section.4.1.3">Read Request</a>
</li>
<li>4.1.4.   <a href="#rfc.section.4.1.4">Read Response</a>
</li>
<li>4.1.5.   <a href="#rfc.section.4.1.5">Metadata Refresh</a>
</li>
</ul></ul><li>5.   <a href="#rfc.section.5">Provider Compatibility Evaluation</a>
</li>
<ul><li>5.1.   <a href="#rfc.section.5.1">Handling Empty Capabilities</a>
</li>
</ul><li>6.   <a href="#rfc.section.6">Provider Authentication Methods</a>
</li>
<ul><li>6.1.   <a href="#rfc.section.6.1">Key   Discovery</a>
</li>
<li>6.2.   <a href="#rfc.section.6.2">Key Rotation</a>
</li>
<li>6.3.   <a href="#rfc.section.6.3">Algorithm Selection</a>
</li>
<li>6.4.   <a href="#rfc.section.6.4">JWT Requirements</a>
</li>
<li>6.5.   <a href="#rfc.section.6.5">Protocol-specific Key Materials</a>
</li>
<li>6.6.   <a href="#rfc.section.6.6">OAuth 2.0 with JWT Profile</a>
</li>
</ul><li>7.   <a href="#rfc.section.7">FastFed Handshake</a>
</li>
<ul><li>7.1.   <a href="#rfc.section.7.1">Common Considerations</a>
</li>
<ul><li>7.1.1.   <a href="#rfc.section.7.1.1">TLS Requirements</a>
</li>
<li>7.1.2.   <a href="#rfc.section.7.1.2">HTTP Redirects</a>
</li>
<li>7.1.3.   <a href="#rfc.section.7.1.3">Query String Serialization</a>
</li>
<li>7.1.4.   <a href="#rfc.section.7.1.4">Halting the Handshake</a>
</li>
<li>7.1.5.   <a href="#rfc.section.7.1.5">Handling Updates and Duplicates</a>
</li>
</ul><li>7.2.   <a href="#rfc.section.7.2">Handshake Flow</a>
</li>
<ul><li>7.2.1.   <a href="#rfc.section.7.2.1">Handshake Initiation at Application Provider</a>
</li>
<ul><li>7.2.1.1.   <a href="#rfc.section.7.2.1.1">Prerequisites</a>
</li>
<li>7.2.1.2.   <a href="#rfc.section.7.2.1.2">Application Provider Reads Identity Provider Metadata</a>
</li>
<li>7.2.1.3.   <a href="#rfc.section.7.2.1.3">Application Provider Checks For Duplicates</a>
</li>
<li>7.2.1.4.   <a href="#rfc.section.7.2.1.4">Application Provider Verifies Compatibility with Identity Provider</a>
</li>
<li>7.2.1.5.   <a href="#rfc.section.7.2.1.5">Application Provider Obtains Confirmation from Administrator</a>
</li>
<li>7.2.1.6.   <a href="#rfc.section.7.2.1.6">Application Provider Whitelists the Identity Provider</a>
</li>
<li>7.2.1.7.   <a href="#rfc.section.7.2.1.7">Application Provider Sends Request to the Identity Provider</a>
</li>
<ul><li>7.2.1.7.1.   <a href="#rfc.section.7.2.1.7.1">HTTP Redirect</a>
</li>
<li>7.2.1.7.2.   <a href="#rfc.section.7.2.1.7.2">Alternative Channel</a>
</li>
</ul></ul><li>7.2.2.   <a href="#rfc.section.7.2.2">Handshake Receipt by Identity Provider</a>
</li>
<ul><li>7.2.2.1.   <a href="#rfc.section.7.2.2.1">Identity Provider Authenticates Administrator</a>
</li>
<li>7.2.2.2.   <a href="#rfc.section.7.2.2.2">Identity Provider Reads Application Provider Metadata</a>
</li>
<li>7.2.2.3.   <a href="#rfc.section.7.2.2.3">Identity Provider Verifies Compatibility</a>
</li>
<li>7.2.2.4.   <a href="#rfc.section.7.2.2.4">Identity Provider Checks For Duplicates and Updates</a>
</li>
<li>7.2.2.5.   <a href="#rfc.section.7.2.2.5">Identity Provider Obtains Confirmation from Administrator</a>
</li>
</ul><li>7.2.3.   <a href="#rfc.section.7.2.3">Handshake Registration</a>
</li>
<ul><li>7.2.3.1.   <a href="#rfc.section.7.2.3.1">Identity Provider Sends Registration Request</a>
</li>
<li>7.2.3.2.   <a href="#rfc.section.7.2.3.2">Application Provider Handles Registration Request</a>
</li>
<li>7.2.3.3.   <a href="#rfc.section.7.2.3.3">Application Provider Sends Registration Response</a>
</li>
<li>7.2.3.4.   <a href="#rfc.section.7.2.3.4">Identity Provider Handles Registration Response</a>
</li>
</ul><li>7.2.4.   <a href="#rfc.section.7.2.4">Handshake Finalization</a>
</li>
<ul><li>7.2.4.1.   <a href="#rfc.section.7.2.4.1">Identity Provider Sends Finalization Request</a>
</li>
<li>7.2.4.2.   <a href="#rfc.section.7.2.4.2">Application Provider Handles Finalization Request</a>
</li>
<li>7.2.4.3.   <a href="#rfc.section.7.2.4.3">Application Provider Sends Finalization Response</a>
</li>
<li>7.2.4.4.   <a href="#rfc.section.7.2.4.4">Identity Provider Handles Finalization Response</a>
</li>
</ul></ul></ul><li>8.   <a href="#rfc.section.8">Security Considerations</a>
</li>
<ul><li>8.1.   <a href="#rfc.section.8.1">Strong Authentication of Administrators</a>
</li>
<li>8.2.   <a href="#rfc.section.8.2">Protection from Unintended Approvals</a>
</li>
<li>8.3.   <a href="#rfc.section.8.3">Evaluating Trustworthiness of Applications</a>
</li>
</ul><li>9.   <a href="#rfc.section.9">IANA Considerations</a>
</li>
<li>10.   <a href="#rfc.references">Normative References</a>
</li>
<li>Appendix A.   <a href="#rfc.appendix.A">Acknowledgements</a>
</li>
<li>Appendix B.   <a href="#rfc.appendix.B">Notices</a>
</li>
<li><a href="#rfc.authors">Author's Address</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> <a href="#Introduction" id="Introduction">Introduction</a>
</h1>
<p id="rfc.section.1.p.1">Despite the existence of well-established standards, identity federation remains difficult to configure and maintain.  </p>
<p id="rfc.section.1.p.2">One source of difficulty arises from the fact that the existing standards each solve only a portion of the ecosystem, such as authentication, schema definition, or end-user provisioning; but without a clear recommendation on how to assemble the pieces into a whole. As a result, each application may choose to assemble standards in different ways or even ignore them, such as by declaring their own user schema. The resulting impact is that each hosted application can be an architectural one-off that an administrator must study and understand before beginning to configure a federation relationship.  </p>
<p id="rfc.section.1.p.3">Another area of difficulty arises because there is no standard mechanism for an independent identity provider and application provider to directly exchange the metadata required by existing standards. Instead, a human administrator must copy-and-paste information between the two providers. This is typically done by opening a web page for each provider and following online instructions to copy information between them. Copy-and-paste errors, overlooked steps, or incomplete documentation can result in non-functional configuration that is difficult to debug.  </p>
<p id="rfc.section.1.p.4">Finally, a working configuration may cease to function when the configuration becomes stale, such as when certificates expire. The lack of a direct communication channel between the identity provider and application provider requires that human administrators remember to periodically refresh the configuration and rotate certificates. In some implementations, planned refresh activities such as certificate rotation can temporarily break the ability for federated users to sign-in to the hosted application.  </p>
<p id="rfc.section.1.p.5">As a result of these challenges, administrators find it necessary to acquire domain expertise in the identity standards and spend significant time configuring, debugging, and maintaining the federations.  </p>
<p id="rfc.section.1.p.6">The goal of FastFed is to simplify the administrator experience. An ecosystem of FastFed-enabled providers enable administrators to instantiate new federation relationships with a few clicks in a web-based workflow, and without needing to understand the underlying technologies.  </p>
<p id="rfc.section.1.p.7">To achieve this, FastFed defines additional metadata documents, APIs, and flows so that an administrator can quickly connect two providers that support common identity standards. In addition, FastFed defines interoperability profiles which describe the subset of existing standards which must be implemented for a Provider to label themselves as FastFed compatible.  </p>
<p id="rfc.section.1.p.8">This specification defines the core FastFed metadata formats and handshake flows.  </p>
<p id="rfc.section.1.p.9">Additional FastFed Profiles extend this specification with protocol-specific requirements.  For reference, see the FastFed Profiles for <a href="#FastFedProfile.EnterpriseSAML" class="xref">Enterprise SAML</a> and <a href="#FastFedProfile.EnterpriseSCIM" class="xref">Enterprise SCIM</a>.  </p>
<h1 id="rfc.section.1.1">
<a href="#rfc.section.1.1">1.1.</a> <a href="#rnc" id="rnc">Requirements Notation and Conventions</a>
</h1>
<p id="rfc.section.1.1.p.1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a href="#RFC2119" class="xref">RFC 2119</a>.  </p>
<p id="rfc.section.1.1.p.2">In the .txt version of this specification, values are quoted to indicate that they are to be taken literally.  When using these values in protocol messages, the quotes MUST NOT be used as part of the value.  In the HTML version of this specification, values to be taken literally are indicated by the use of <samp>this fixed-width font</samp>.  </p>
<h1 id="rfc.section.1.2">
<a href="#rfc.section.1.2">1.2.</a> <a href="#Terminology" id="Terminology">Terminology</a>
</h1>
<p id="rfc.section.1.2.p.1">FastFed acts as a high-level metadata description layer which references many different underlying standards. To avoid confusion of terminology, the FastFed specification will explicitly reference the relevant standards inline when using terminology from those standards.  </p>
<p id="rfc.section.1.2.p.2">In addition, this specification defines the following terms. When used in this document, the terms refer to the definitions here and not to any terminology from related standards: </p>

<dl>
<dt>Administrator</dt>
<dd style="margin-left: 8">A human end-user who is responsible for establishing the federation between an Identity Provider and Application Provider. An Administrator is typically a member of an organization with privileges to enable single sign-on to hosted applications for other members of their organization.  </dd>
<dt>Application Provider</dt>
<dd style="margin-left: 8">An online service or website which requires end-user provisioning and/or authentication from an Identity Provider.  </dd>
<dt>FastFed URL</dt>
<dd style="margin-left: 8">A shorthand alias for the FastFed Provider Metadata Endpoint (<a href="#ProviderMetadataEndpoint" class="xref">Section 4.1</a>). Providers may advertise their "FastFed URL" in documentation for enabling single sign-on.  </dd>
<dt>Identity Provider</dt>
<dd style="margin-left: 8">A service that is capable of authenticating end-users via a federation protocol (such as OpenID Connect and SAML) or providing user information to the application via provisioning protocols (such as SCIM).  <br><br>Some Identity Providers may offer both capabilities. Others may only offer one. Additionally, responsibilities may be delegated. For example, a Provider who implements the FastFed Handshake may delegate the implementation of authentication or provisioning activities to another subsystem. In this case, all the participants collectively fulfill the role of the Identity Provider. FastFed supports all of these variations.  </dd>
<dt>Multi-Tenant Provider</dt>
<dd style="margin-left: 8">A Provider who serves multiple customers from a single instance of a service. Each customer is logically isolated from other customers of the service.  <br> The FastFed specification treats all Providers as potentially Multi-Tenant.  </dd>
<dt>Provider</dt>
<dd style="margin-left: 8">An entity that can act as an Application Provider, an Identity Provider, or both.  </dd>
</dl>

<p> </p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> <a href="#Overview" id="Overview">Overview</a>
</h1>
<p id="rfc.section.2.p.1">This section provides an introductory overview of the key concepts in FastFed. The following concepts are explored: </p>

<dl>
<dt>Metadata</dt>
<dd style="margin-left: 8">Configuration that describes the capabilities and preferences of a Provider.  </dd>
<dt>Endpoints</dt>
<dd style="margin-left: 8">Locations where Metadata documents can be retrieved.  </dd>
<dt>Handshake</dt>
<dd style="margin-left: 8">Flows that describe how an Identity Provider and Application Provider share Metadata documents with each other, thereby establishing the federation relationship.  </dd>
<dt>User Schema and Provisioning</dt>
<dd style="margin-left: 8">Describes how Providers agree on a common user schema and declare capabilities for user provisioning.  </dd>
</dl>

<p> </p>
<h1 id="rfc.section.2.1">
<a href="#rfc.section.2.1">2.1.</a> <a href="#OverviewMetadata" id="OverviewMetadata">Metadata</a>
</h1>
<p id="rfc.section.2.1.p.1">FastFed uses Metadata documents to enable Identity Providers and Application Providers to programmatically discover the capabilities of one another and exchange any configuration necessary to enable federation.  </p>
<p id="rfc.section.2.1.p.2">Metadata can be different for each tenant of a Provider. The various tenants may have different preferences, configurations, and namespaces that get reflected in their Metadata.  </p>
<p id="rfc.section.2.1.p.3">Metadata includes the following: </p>

<ul>
<li>Authentication protocols and provisioning methods implemented by the provider.  </li>
<li>Endpoint locations for the FastFed Handshake (<a href="#Handshake" class="xref">Section 7</a>).  </li>
<li>Optional values such as icon images that can aesthetically improve the handshake flows seen by Administrators.  </li>
</ul>

<p> </p>
<p id="rfc.section.2.1.p.4">Provider Metadata is segmented into blocks for <samp>identity_provider</samp> and <samp>application_provider</samp>. An entity can define one, or both blocks, depending on the roles they are capable of performing.  </p>
<p id="rfc.section.2.1.p.5">The following is a non-normative example of Provider Metadata: </p>
<pre>
 {
   "identity_provider": {
     "entity_id": "https://tenant-12345.idp.example.com/"
     "provider_domain": "example.com",
     "provider_contact_information": {
       "organization": "Example Inc.",
       "phone": "+1-800-555-5555",
       "email": "support@example.com"
     },
     "display_settings": {
       "display_name": "Example Identity Provider",
       "logo_uri": "https://idp.example.com/images/logo.png",
       "icon_uri": "https://idp.example.com/images/icon.png",
       "license": "https://openid.net/intellectual-property/licenses/fastfed/1.0/"
     }
     "capabilities": {
       "authentication_profiles": [
         "urn:ietf:params:fastfed:1.0:authentication:saml:2.0:enterprise"
       ],
       "provisioning_profiles": [
         "urn:ietf:params:fastfed:1.0:provisioning:scim:2.0:enterprise"
       ],
       "schema_grammars": [
         "urn:ietf:params:fastfed:1.0:schemas:scim:2.0"
       ],
       "signing_algorithms": [
         "ES512",
         "RS256"
       ]
     },
     "jwks_uri": "https://idp.example.com/keys",
     "fastfed_handshake_start_uri": "https://tenant-12345.idp.example.com/fastfed/start",
 }
</pre>
<h1 id="rfc.section.2.2">
<a href="#rfc.section.2.2">2.2.</a> <a href="#OverviewEndpoints" id="OverviewEndpoints">Endpoints</a>
</h1>
<p id="rfc.section.2.2.p.1">Endpoints describe the semantics for exchanging information between Providers.  </p>
<p id="rfc.section.2.2.p.2">FastFed defines one Endpoint for retrieving Metadata documents: </p>

<ul><li>Provider Metadata Endpoint (<a href="#ProviderMetadataEndpoint" class="xref">Section 4.1</a>), also referred to as the "FastFed URL"</li></ul>

<p> </p>
<p id="rfc.section.2.2.p.3">And, two Endpoints for the FastFed Handshake </p>

<ul>
<li>FastFed Handshake Start Endpoint, hosted by the Identity Provider (<a href="#HandshakeApplicationProviderRedirectVia302" class="xref">Section 7.2.1.7.1</a>)</li>
<li>FastFed Handshake Register Endpoint, hosted by the Application Provider (<a href="#HandshakeRegistrationRequest" class="xref">Section 7.2.3.1</a>)</li>
</ul>

<p> </p>
<h1 id="rfc.section.2.3">
<a href="#rfc.section.2.3">2.3.</a> <a href="#OverviewEndpointDiscovery" id="OverviewEndpointDiscovery">Endpoint Discovery</a>
</h1>
<p id="rfc.section.2.3.p.1">Discovery is the means by which Endpoint locations are determined. For example, when the administrator of an application wishes to enable single sign-on, the Application needs to know the administrator's Identity Provider Metadata Endpoint (e.g. "FastFed URL"). This is accomplished through Endpoint Discovery.  </p>
<p id="rfc.section.2.3.p.2">The simplest discovery mechanism (though the least user-friendly) is for the end-user to manually paste their FastFed URL into a form field of the Application. The user may have discovered this value by consulting with an appropriate IT department in their organization, talking to peers, or reading internal documentation pages. This will vary by organization and is outside the scope of this specification.  </p>
<p id="rfc.section.2.3.p.3">To simplify the experience, FastFed also supports automated discovery based upon an email address. If a user's Identity Provider supports it, the FastFed experience can be initiated simply by a user providing their email address to the Application (<a href="#ProviderMetadataEndpointDiscovery" class="xref">Section 4.1.2</a>).  </p>
<h1 id="rfc.section.2.4">
<a href="#rfc.section.2.4">2.4.</a> <a href="#OverviewFastFedHandshake" id="OverviewFastFedHandshake">FastFed Handshake</a>
</h1>
<p id="rfc.section.2.4.p.1">The FastFed Handshake flow is the means by which Metadata documents are exchanged and a federation relationship established.  </p>
<p id="rfc.section.2.4.p.2">The abstract flow follows these steps: </p>
<p></p>

<ol>
<li>Application Provider authenticates the Administrator.  </li>
<li>Application Provider whitelists the Identity Provider and redirects the Administrator to the Identity Provider to perform the remainder of the registration.  </li>
<li>Identity Provider authenticates the Administrator.  </li>
<li>Identity Provider makes a registration request to the Application Provider with protocol-specific information necessary to formally establish the federation relationship.  </li>
<li>Application Provider validates the Identity Provider is whitelisted and captures the federation configuration.  </li>
<li>Application Provider responds with any protocol-specific configuration needed by the Identity Provider.  </li>
<li>Identity Provider captures the federation configuration.  </li>
<li>Optionally, Identity Provider notifies the Application Provider when the federation relationship is activated and ready for end-user traffic.  </li>
</ol>

<p> </p>
<pre>
   +----------+              +----------------+         .----.
   |   User   |              |                |        |.____.|
   |   Agent  |&lt;-----(1)----&gt;|  Application   |--(5)--&gt;| Data |
   |          |              |    Provider    |        | Store|
   |        +-|------(2)----&lt;|                |         "----"
   |        | |              +----------------+
   |        | |                 ^    |    ^
   |        | |                 |    |    |
   |        | |                 |    |    |
   |        | |                (4)  (6)  (8)
   |        | |                 |    |    |
   |        | |                 |    |    |
   |        | |                 |    V    |
   |        | |              +----------------+         .----.
   |        +-|-------------&gt;|                |        |.____.|
   |          |              |    Identity    |--(7)--&gt;| Data |
   |          |&lt;-----(3)----&gt;|    Provider    |        | Store|
   |          |              |                |         "----"
   +----------+              +----------------+

                 Figure 1: Abstract Handshake Flow
</pre>
<h1 id="rfc.section.2.5">
<a href="#rfc.section.2.5">2.5.</a> <a href="#OverviewUser" id="OverviewUser">User Schemas and Provisioning</a>
</h1>
<p id="rfc.section.2.5.p.1">Federated Identity Management requires a common, agreed upon schema to describe user information, plus a mechanism to transmit user information across organizational boundaries.  </p>
<p id="rfc.section.2.5.p.2">While previous standards each define pieces of the solution, they lack guidance on assembling the pieces into an end-to-end flow. For example, the SCIM specification defines a User schema, but does not specify how to bind the schema into SAML or OIDC assertions. Alternatively, OIDC defines a schema for Standard Claims and a User Info Endpoint to retrieve them. However, the claims are weighted toward describing social media users and may lack attributes necessary to describe users from the enterprise sector or educational sector. In addition, the OIDC claims are bound to the OIDC protocol and it is unspecified how the same schema could be reused with an Application Provider that requires SAML instead of OIDC. Finally, it is not uncommon for an Application Provider to completely ignore all preexisting standards and define their own schema which federation partners must adhere to in SAML or OIDC messages.  </p>
<p id="rfc.section.2.5.p.3">Administrators bear the burden of this inconsistency. The lack of agreement amongst federation participants requires an Administrator to bridge the divide by defining schema transformation rules that map user attributes from an Identity Provider format into an Application Provider format. This mapping is unique for each Application Provider and must be defined for each federation. Understanding and defining these transformation rules is a contributor to the friction of adopting federation.  </p>
<p id="rfc.section.2.5.p.4">To eliminate the burden from Administrators, Providers must agree upon a shared vocabulary for user attributes. This is accomplished by requiring both parties to share a common schema for use within the FastFed Metadata documents. This schema serves as a common lingua franca for communicating the user attributes to be exchanged.  </p>
<h1 id="rfc.section.2.5.1">
<a href="#rfc.section.2.5.1">2.5.1.</a> <a href="#OverviewUserSchemaSelection" id="OverviewUserSchemaSelection">Schema Selection</a>
</h1>
<p id="rfc.section.2.5.1.p.1">FastFed Metadata allows Providers to declare the schemas they understand. Providers should choose schemas that are likely to be shared by federation partners. The lack of a common schema between an Identity Provider and Application Provider will be regarded as an incompatibility and the FastFed handshake will be halted before completion.  </p>
<p id="rfc.section.2.5.1.p.2">FastFed recommends the use of SCIM 2.0 User and Group Resource Schemas (<a href="#ScimSchemaGrammar" class="xref">Section 3.3.4.1</a>). This specification uses SCIM in examples and references. However, other schemas may be used.  </p>
<p id="rfc.section.2.5.1.p.3">The following is a non-normative example showing a snippet of FastFed Metadata with a list of schema grammars understood by an Identity Provider: </p>
<pre>
 {
   "identity_provider": {
     capabilities: {
       ...
       "schema_grammars": [
         "urn:ietf:params:fastfed:1.0:schemas:scim:2.0"
       ],
     }
     ...
</pre>
<h1 id="rfc.section.2.5.2">
<a href="#rfc.section.2.5.2">2.5.2.</a> <a href="#OverviewUserAttributeFiltering" id="OverviewUserAttributeFiltering">Attribute Filtering</a>
</h1>
<p id="rfc.section.2.5.2.p.1">User schemas can potentially contain many pieces of information about a user. For example, the SCIM User Resource defines more than 25 different attribute types, some containing sensitive user information. It is typically unnecessary to share all user information with a hosted application. In recognition of this, FastFed provides a mechanism for Application Providers to specify the subset of attributes needed to use the application.  </p>
<p id="rfc.section.2.5.2.p.2">Identity Providers MAY display the list of requested attributes during the FastFed Handshake so that Administrators can review and approve the attributes to be released.  </p>
<p id="rfc.section.2.5.2.p.3">The following is a non-normative example showing a snippet of FastFed Metadata for an Application Provider who desires 3 attributes from a SCIM User Resource.  </p>
<pre>
     "desired_attributes": [
       "urn:ietf:params:fastfed:1.0:schemas:scim:2.0": {
          "required_user_attributes": [
	    "externalId",
            "userName", 
            "active"
          ],
          "optional_user_attributes": [
            "displayName",
            "emails[primary eq true]"
          ]
       }
     ]
</pre>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> <a href="#Metadata" id="Metadata">Metadata</a>
</h1>
<h1 id="rfc.section.3.1">
<a href="#rfc.section.3.1">3.1.</a> <a href="#MetadataSerialization" id="MetadataSerialization">Metadata Serialization</a>
</h1>
<p id="rfc.section.3.1.p.1">All FastFed Metadata is represented in JSON format. Property names and string values are represented as JSON strings. Numerical values are represented as JSON numbers. Boolean values are represented as JSON Booleans. Lists are represented as JSON arrays. Complex structures are represented as JSON objects. Omitted properties and properties with no value SHOULD be omitted from the object and not represented by a JSON null value.  <br><br>DateTime values are a JSON numeric format representing the number of seconds from 1970-01-01T00:00:00Z UTC until the specified UTC date/time, ignoring leap seconds.  This is equivalent to the IEEE Std 1003.1, 2018 Edition <a href="#POSIX.1" class="xref">[POSIX.1]</a> definition "Seconds Since the Epoch", in which each day is accounted for by exactly 86400 seconds, other than that non-integer values can be represented.  </p>
<h1 id="rfc.section.3.2">
<a href="#rfc.section.3.2">3.2.</a> <a href="#MetadataLanguages" id="MetadataLanguages">Metadata Languages and Scripts</a>
</h1>
<p id="rfc.section.3.2.p.1">Human-readable Metadata values and Metadata values that reference human-readable values MAY be represented in multiple languages and scripts. For example, values such as display_name and logo_uri might have multiple locale-specific values for some Providers.  </p>
<p id="rfc.section.3.2.p.2">To specify the languages and scripts, <a href="#RFC5646" class="xref">BCP47</a> [RFC5646] language tags are added to Provider Metadata member names, delimited by a # character.  </p>
<p id="rfc.section.3.2.p.3">If such a human-readable field is sent without a language tag, parties using it MUST NOT make any assumptions about the language, character set, or script of the string value, and the string value MUST be used as-is wherever it is presented in a user interface. To facilitate interoperability, it is RECOMMENDED that any human-readable fields sent without language tags contain values suitable for display on a wide variety of systems.  </p>
<h1 id="rfc.section.3.3">
<a href="#rfc.section.3.3">3.3.</a> <a href="#ProviderMetadata" id="ProviderMetadata">Provider Metadata</a>
</h1>
<p id="rfc.section.3.3.p.1">Provider Metadata enables Providers to advertise their capabilities and evaluate compatibility with other Providers. The Metadata also contains the endpoint configuration needed to perform the FastFed Handshake.  </p>
<p id="rfc.section.3.3.p.2">Provider Metadata is a structure with the following top-level attributes: </p>

<dl>
<dt>identity_provider</dt>
<dd style="margin-left: 8">OPTIONAL. Structure containing the members described by Identity Provider Metadata (<a href="#IdentityProviderMetadata" class="xref">Section 3.3.8</a>).  The existence of this element indicates the entity is capable of acting as an Identity Provider.  </dd>
<dt>application_provider</dt>
<dd style="margin-left: 8">OPTIONAL. Structure containing the members described by Application Provider Metadata (<a href="#ApplicationProviderMetadata" class="xref">Section 3.3.9</a>) The existence of this element indicates the entity is capable of acting as an Application Provider.  </dd>
</dl>

<p> </p>
<p id="rfc.section.3.3.p.3">If a single Provider is capable of acting as both an Identity Provider and an Application Provider, the Provider Metadata MAY contain both parts.  </p>
<p id="rfc.section.3.3.p.4">If neither part is specified, the FastFed Handshake will halt as per <a href="#HandshakeHalt" class="xref">Section 7.1.4</a>.  </p>
<h1 id="rfc.section.3.3.1">
<a href="#rfc.section.3.3.1">3.3.1.</a> <a href="#ProviderMetadataCapabilities" id="ProviderMetadataCapabilities">Capabilities</a>
</h1>
<p id="rfc.section.3.3.1.p.1">Capabilities describe the supported behaviors of a Provider.  They are included in the Metadata for both Identity Providers and Application Providers and are the primary tool to evaluate if two Providers are compatible with one another.  </p>
<p id="rfc.section.3.3.1.p.2">Capabilities are represented as a structure with the following members: </p>

<dl>
<dt>authentication_profiles</dt>
<dd style="margin-left: 8">OPTIONAL. A list of URNs specifying the single sign-in authentication protocols supported by the Provider. For example, the value "urn:ietf:params:fastfed:1.0:authentication:saml:2.0:enterprise" indicates the provider implements the <a href="#FastFedProfile.EnterpriseSAML" class="xref">FastFed Enterprise SAML Profile</a>.  <br><br> If no value is specified by the Application Provider for <samp>authentication_profiles</samp>, this indicates the Provider does not require authentication, perhaps because FastFed is being used only to configure synchronization of user data between systems in a context without a need for single sign-on. See <a href="#ProviderCompatibilityEvaluationEmptyList" class="xref">Section 5.1</a> for handling empty capabilities.  </dd>
<dt>provisioning_profiles</dt>
<dd style="margin-left: 8">OPTIONAL. A list of URNs specifying the user provisioning capabilities supported by the Provider.  <br><br>For example, the value <samp>"urn:ietf:params:fastfed:1.0:provisioning:scim:2.0:enterprise"</samp> indicates a Provider supports full user provisioning (and deprovisioning) as defined in the <a href="#FastFedProfile.EnterpriseSCIM" class="xref">FastFed Profile For SCIM Provisioning</a>.  <br><br> If no value is specified by the Application Provider for <samp>provisioning_profiles</samp>, this indicates the Provider does not require provisioning or that provisioning happens through a non-standard mechanism that is out of scope of the FastFed specification. See <a href="#ProviderCompatibilityEvaluationEmptyList" class="xref">Section 5.1</a> for handling empty capabilities.  </dd>
<dt>schema_grammars</dt>
<dd style="margin-left: 8">REQUIRED. A list of URNs specifying the schemas grammars understood by the Provider. FastFed does not mandate a specific schema grammar, but RECOMMENDS the use of SCIM as defined in <a href="#ScimSchemaGrammar" class="xref">Section 3.3.4.1</a>.  </dd>
<dt>signing_algorithms</dt>
<dd style="margin-left: 8">REQUIRED. A list of JWA <a href="#RFC7518" class="xref">[RFC7518]</a> signing algorithms supported by the Provider. Used for signing request objects within the FastFed Handshake. May also be used by FastFed Profiles (for example, SCIM provisioning) which require authentication of a Provider.<br>At minimum, all Providers SHOULD support <samp>RS256</samp>, but MAY support additional algorithms.  </dd>
</dl>

<p> </p>
<h1 id="rfc.section.3.3.2">
<a href="#rfc.section.3.3.2">3.3.2.</a> <a href="#DisplaySettings" id="DisplaySettings">Display Settings</a>
</h1>
<p id="rfc.section.3.3.2.p.1">Display Settings contains the names, icons, logos, and licenses for a Provider. It is included in the Metadata for both Identity Providers and Application Providers.<br><br>If defined, these values supersede any overlapping specifications from underlying protocols; e.g. the <samp>logo_uri</samp> defined in <a href="#OpenID.Registration" class="xref">OpenID Connect Dynamic Client Registration 1.0</a>.  <br><br> Display Settings are represented as a structure with the following members: </p>

<dl>
<dt>display_name</dt>
<dd style="margin-left: 8">REQUIRED. The name of the Provider suitable for display to end-users. The value SHOULD be the primary textual label by which this Provider is normally displayed when presenting it to end-users. If desired, representation of this value in different languages and scripts is represented as described in <a href="#MetadataLanguages" class="xref">Section 3.2</a>.  </dd>
<dt>icon_uri</dt>
<dd style="margin-left: 8">OPTONAL. A URL that points to a square image file. Commonly used in scenarios where clicking the icon results in launching an instance of the application for the user. Image dimensions MUST NOT exceed 512x512 pixels. Image files SHOULD be in PNG format, but Providers MAY accept alternative formats. Providers who consume and display the image MAY resize it to smaller dimensions (while preserving aspect ratios) and/or convert to alternative file formats.  If desired, representation of this value in different languages and scripts is represented as described in <a href="#MetadataLanguages" class="xref">Section 3.2</a>.  </dd>
<dt>logo_uri</dt>
<dd style="margin-left: 8">OPTIONAL. A URL that points to a logo file for the business or organization. Image dimensions MUST NOT exceed 512 pixels in width or 256 pixels in height. Image files SHOULD be in PNG format, but Providers MAY accept alternative formats. Providers who consume and display the image MAY resize it to smaller dimensions (while preserving aspect ratios) and/or convert to alternative file formats. If desired, representation of this value in different languages and scripts is represented as described in <a href="#MetadataLanguages" class="xref">Section 3.2</a>.  </dd>
<dt>license</dt>
<dd style="margin-left: 8">REQUIRED. A URL that points to a license granting use of the display name, icons, and logos. If the license is unrecognized by a participant in the FastFed flows, the participant MUST halt the FastFed Handshake as specified in <a href="#HandshakeHalt" class="xref">Section 7.1.4</a>. To maximize interoperability, all Providers are RECOMMENDED to use an existing FastFed license such as <samp>"https://openid.net/intellectual-property/licenses/fastfed/1.0/"</samp>.  </dd>
</dl>

<p> </p>
<h1 id="rfc.section.3.3.3">
<a href="#rfc.section.3.3.3">3.3.3.</a> <a href="#ProviderContactInformation" id="ProviderContactInformation">Provider Contact Information</a>
</h1>
<p id="rfc.section.3.3.3.p.1">Specifies the contact information for the Provider. This information is intended to be used when one Provider needs to contact another Provider for operational purposes. For example, if software flaws were to cause an undesired impact, such as excessive HTTP traffic between Providers or a broken end-user experience, this contact information can be used to notify the Provider of the issue.  <br><br>This information is NOT intended to be displayed to end-users as it exists only for the purpose of allowing one Provider to contact another Provider for operational reasons.  <br><br>Provider Contact Information consists of the following members: </p>

<dl>
<dt>organization</dt>
<dd style="margin-left: 8">REQUIRED. The legal name of the business or organization which operates the Provider.  </dd>
<dt>phone</dt>
<dd style="margin-left: 8">REQUIRED. A phone number to contact the Provider. The number MUST be a support channel that is guaranteed to remain valid over time. It MUST NOT be the number of an individual in the organization. The value SHOULD be formatted according to the global number representation of <a href="#RFC3966" class="xref">RFC 3966</a>, e.g., '+1-800-555-0123'.  </dd>
<dt>email</dt>
<dd style="margin-left: 8">REQUIRED. An email address to contact the Provider. The email MUST be an alias which routes to a support channel that is guaranteed to remain valid over time. It MUST NOT be the email of an individual in the organization. The value SHOULD be specified according to <a href="#RFC5321" class="xref">RFC 5321</a>, e.g., "support@example.com".  </dd>
</dl>

<p> </p>
<p id="rfc.section.3.3.3.p.2">The following is a non-normative example of Provider Authentication metadata: </p>
<pre>
 
     "provider_contact_information": {
       "organization": "Example Inc.",
       "phone": "+1-800-555-5555",
       "email": "support@example.com"
     }
 
</pre>
<h1 id="rfc.section.3.3.4">
<a href="#rfc.section.3.3.4">3.3.4.</a> <a href="#AttributeReferences" id="AttributeReferences">Attribute Reference</a>
</h1>
<p id="rfc.section.3.3.4.p.1">Portions of the FastFed specification require the ability to reference a User attribute, such as a name, email, or phone. An example of such a scenario occurs when the Application Provider seeks to express the list of user attributes it needs to receive during user provisioning.  </p>
<p id="rfc.section.3.3.4.p.2">Different schema grammars define different mechanisms for referencing individual attributes. For example, SCIM 2.0 represents Users as a JSON structure, and individual attributes are referenced using a path syntax that is defined in Section 3.5.2 of <a href="#RFC7644" class="xref">RFC 7644</a>.  </p>
<p id="rfc.section.3.3.4.p.3">The FastFed Attribute Reference is a string containing an attribute reference in the syntax of a particular schema grammar.  </p>
<p id="rfc.section.3.3.4.p.4">The following is a non-normative example of a list of SCIM 2.0 Attribute References: </p>
<pre>
 [userName,
  name.givenName,               
  emails[primary eq true]
 ]
</pre>
<h1 id="rfc.section.3.3.4.1">
<a href="#rfc.section.3.3.4.1">3.3.4.1.</a> <a href="#ScimSchemaGrammar" id="ScimSchemaGrammar">Using the SCIM 2.0 Schema Grammar for Attribute References</a>
</h1>
<p id="rfc.section.3.3.4.1.p.1">This section defines the requirements for using SCIM 2.0 <a href="#RFC7643" class="xref">[RFC7643]</a> as a schema grammar for <a href="#AttributeReferences" class="xref">Attribute References</a>.  </p>
<p id="rfc.section.3.3.4.1.p.2">A Provider who includes the value <samp>"urn:ietf:params:fastfed:1.0:schemas:scim:2.0"</samp> as a supported <samp>schema_grammar</samp> in their <a href="#ProviderMetadataCapabilities" class="xref">Provider Metadata</a> <samp>capabilities</samp> MUST comply with the following requirements: </p>

<ol>
<li>The Provider MUST support the SCIM Core schema for "User", and MAY support "Group", as defined in Section 4.1 and 4.2 of <a href="#RFC7643" class="xref">RFC 7643</a>. The Provider MAY support additional schema extensions, as defined in Section 3.3 of <a href="#RFC7643" class="xref">RFC 7643</a>.<br><br> </li>
<li>FastFed Attribute References MUST be specified using the SCIM PATH syntax as defined in Section 3.5.2 of <a href="#RFC7644" class="xref">RFC 7644</a>. For example, the given name of a User is referenced as <samp>"name.givenName"</samp>.<br><br> </li>
<li>As per Section 3.10 of the SCIM Protocol Specification <a href="#RFC7644" class="xref">RFC 7644</a>, attribute names are fully qualified by prefixing with a schema URI. E.g. <samp>"urn:ietf:params:scim:schemas:core:2.0:User:name.formatted"</samp>.  Clients MAY omit URN prefixes for core schema names, but SHOULD fully qualify extended attributes with the associated schema extension URI. When no prefix is specified, the default SCIM core schema is presumed.<br><br> </li>
<li>For the multi-valued attributes <samp>"emails"</samp>, <samp>"phoneNumbers"</samp>, and <samp>"addresses"</samp>, it MUST be possible to reference one of the attributes in the multi-valued set using the filter <samp>"primary eq true"</samp>, as described in Section 2.4 of <a href="#RFC7643" class="xref">RFC 7643</a>. If the Identity Provider does not natively represent any of the multi-valued attributes as the primary, it MUST be able to map a request for the primary into a deterministic answer.<br><br> </li>
<li>To encourage interoperability, it is RECOMMENDED that Providers avoid the use of any other SCIM filter expression except <samp>"primary eq true"</samp> when specifying desired attributes, unless the filter expression is known to be supported by potential integration partners.<br><br> </li>
<li>If a SCIM PATH references a complex attribute type, it MUST be processed as equivalent to referencing each individual attribute within the complex type. For example, specifying the value <samp>"name"</samp> is equivalent to specifying <samp>"name.formatted"</samp>, <samp>"name.familyName"</samp>, <samp>"name.givenName"</samp>, etc.<br><br> </li>
<li>If a SCIM PATH references a multi-valued attribute, it MUST be processed as equivalent to referencing all members of the list. For example, specifying the value <samp>"emails"</samp> as a desired attribute would result in the full list of emails being shared.<br><br> </li>
<li>A trailing asterisk <samp>"*"</samp> wildcard in the SCIM PATH MUST be processed as equivalent to any fully qualified path that is prefixed with the string that precedes the wildcard. Wildcards MUST NOT be used in any position except the final character of the SCIM PATH. Wildcards MUST NOT be used in the <samp>required_user_attributes</samp> or <samp>required_group_attributes</samp> elements of the <a href="#DesiredAttributes" class="xref">Desired Attributes</a> structure, but MAY be used in the <samp>optional_user_attributes</samp> or <samp>optional_group_attributes</samp>.<br><br>Wildcards can be useful when an application wants to receive user data without knowing in advance which attributes are defined or available for the user. For example, the value <samp>"*"</samp> would match all attributes from any schema, including custom-defined extensions. The effectively results in a full copy of the user object. Wildcards also allow for requesting all attributes within a particular schema. For example, <samp>"urn:ietf:params:scim:schemas:extension:enterprise:2.0:User:*"</samp> would match all attributes in the SCIM Enterprise User extension.<br><br> </li>
</ol>

<p> </p>
<h1 id="rfc.section.3.3.5">
<a href="#rfc.section.3.3.5">3.3.5.</a> <a href="#DesiredAttributes" id="DesiredAttributes">Desired Attributes</a>
</h1>
<p id="rfc.section.3.3.5.p.1">A structure describing the user and group attributes that the Application Provider desires from the Identity Provider. During the FastFed Handshake, Administrators have an opportunity to review and consent to the release of the desired attributes.  </p>
<p id="rfc.section.3.3.5.p.2">As a reference, the set of attributes can vary across protocols. For example, the attributes included in a SAML Assertion may differ from the attributes included in a SCIM provisioning activity. Due to this variability, each FastFed Profile will generally define its own rules for declaring the desired attributes, as well as rules about which attributes are required versus optional.  </p>
<p id="rfc.section.3.3.5.p.3">As such, the structure defined in this section is not directly referenced in any of the FastFed Core metadata documents. Rather, it exists as a re-usable element which the various FastFed Profiles may reference in their own extensions, to declare their desired attributes.  </p>
<p id="rfc.section.3.3.5.p.4">The structure has the following properties.  </p>
<p id="rfc.section.3.3.5.p.5">It MUST contain a member for each <samp>schema_grammar</samp> in the list of Provider <samp>capabilities</samp>, where the member name is the URN of the <samp>schema_grammar</samp>.  </p>
<p id="rfc.section.3.3.5.p.6">The value of each element is another structure with the following members: </p>

<dl>
<dt>required_user_attributes</dt>
<dd style="margin-left: 8">REQUIRED. A list of <a href="#AttributeReferences" class="xref">Attribute References</a> describing the end-user attributes which the Identity Provider MUST release to the Application Provider. The value of the attributes MUST NOT be null, empty, or consist of only whitespace characters.  <br><br>If a required attribute is not defined for an end-user, the Identity Provider MUST NOT perform any authentication or provisioning activity into the Application Provider for the affected end-user. To assist with diagnostics, the Identity Provider SHOULD signal to the end-user that the attribute is missing and is required by the Application. The means of doing so are outside the scope of the specification, but could include displaying an informative error message when the end-user attempts to authenticate into the application, or making error logs available to the administrators of the Identity Provider if user provisioning fails due to the missing attributes.  <br><br>To encourage interoperability, it is RECOMMENDED that Providers avoid requiring any schema extensions or custom attributes which are unlikely to be in common use by potential integration partners.  </dd>
<dt>optional_user_attributes</dt>
<dd style="margin-left: 8">OPTIONAL. A list of <a href="#AttributeReferences" class="xref">Attribute References</a> describing the user attributes which the Identity Provider MAY release to the Application Provider.  <br><br>The Application Provider MUST remain functional if the attributes are undefined or if the Identity Provider chooses not to release the <samp>optional_attributes</samp>; albeit with minor degradations in user experience; e.g. falling back to labeling end-users with an opaque <samp>userName</samp> instead of a more human-readable <samp>displayName</samp>.  </dd>
<dt>required_group_attributes</dt>
<dd style="margin-left: 8">OPTIONAL. A list of <a href="#AttributeReferences" class="xref">Attribute References</a> describing the group attributes which the Identity Provider MUST release to the Application Provider.  <br><br>If a required attribute is not defined for a group, the Identity Provider MUST NOT attempt to provision the group to the Application.  <br><br>To encourage interoperability, it is RECOMMENDED that Providers avoid requiring any schema extensions or custom attributes which are unlikely to be in common use by potential integration partners.  </dd>
<dt>optional_group_attributes</dt>
<dd style="margin-left: 8">OPTIONAL. A list of <a href="#AttributeReferences" class="xref">Attribute References</a> describing the group attributes which the Identity Provider MAY release to the Application Provider.  <br><br>The Application Provider MUST remain functional if the attributes are undefined or if the Identity Provider chooses not to release the <samp>optional_group_attributes</samp>.  </dd>
</dl>

<p> </p>
<p id="rfc.section.3.3.5.p.7">The following is a non-normative example of Desired Attributes using the SCIM 2.0 schema grammar: </p>
<pre>
  {
    "urn:ietf:params:fastfed:1.0:schemas:scim:2.0": {
      "required_user_attributes": [
        "externalId",
        "userName",
        "active",
        "emails[primary eq true]"
      ],
      "optional_user_attributes": [
        "displayName",
        "name.givenName",
        "name.familyName",
        "urn:ietf:params:scim:schemas:extension:enterprise:2.0:User:*",
        "urn:scim:my:custom:schema:customAttribute"
      ]
      "required_group_attributes": [
        "displayName"
      ],
      "optional_group_attributes": [
	"externalId",
        "members"
      ]
    }
  }
</pre>
<p id="rfc.section.3.3.5.p.8">The following is a non-normative example of the usage of wildcards in the Desired Attributes. In this example, the Application Provider accepts any user attribute that is defined using the SCIM 2.0 grammar, essentially resulting in a copy of the User object: </p>
<pre>
  {
    "urn:ietf:params:fastfed:1.0:schemas:scim:2.0": {
      "required_user_attributes": [
        "userName",
        "active"
      ],
      "optional_user_attributes": [
        "*"
      ]
    }
  }
</pre>
<h1 id="rfc.section.3.3.6">
<a href="#rfc.section.3.3.6">3.3.6.</a> <a href="#UserAttribute" id="UserAttribute">User Attribute</a>
</h1>
<p id="rfc.section.3.3.6.p.1">This entity is similar to the <a href="#DesiredAttributes" class="xref">Desired Attributes</a>, but describes only a single user attribute as opposed to a collection of user/group attributes.  </p>
<p id="rfc.section.3.3.6.p.2">It is not directly referenced in any of the FastFed Core metadata documents. Rather, it exists as a re-usable element which other FastFed Profiles may reference in their own extensions.  </p>
<p id="rfc.section.3.3.6.p.3">The structure has the following properties.  </p>
<p id="rfc.section.3.3.6.p.4">It MUST contain a member for each <samp>schema_grammar</samp> in the list of Provider <samp>capabilities</samp>, where the member name is the URN of the <samp>schema_grammar</samp>.  </p>
<p id="rfc.section.3.3.6.p.5">The value of each element is a string containing an <a href="#AttributeReferences" class="xref">Attribute Reference</a> which specifies a singular end-user attribute.  </p>
<p id="rfc.section.3.3.6.p.6">The <a href="#AttributeReferences" class="xref">Attribute Reference</a> MUST NOT reference a complex or multi-value attribute.  </p>
<p id="rfc.section.3.3.6.p.7">The following is a non-normative example of a User Attribute which specifies a user's primary email address via the SCIM 2.0 schema grammar: </p>
<pre>
  {
    "urn:ietf:params:fastfed:1.0:schemas:scim:2.0": "emails[primary eq true].value"
  }	    
	  </pre>
<h1 id="rfc.section.3.3.7">
<a href="#rfc.section.3.3.7">3.3.7.</a> <a href="#CommonProviderMetadata" id="CommonProviderMetadata">Common Provider Metadata</a>
</h1>
<p id="rfc.section.3.3.7.p.1">Common Provider Metadata describes properties that are shared by both Identity Providers and Application Providers.  </p>
<p id="rfc.section.3.3.7.p.2">Common Provider Metadata is a structure with the following members: </p>

<dl>
<dt>entity_id</dt>
<dd style="margin-left: 8">REQUIRED. A URI which serves as a globally unique name for a participant in a FastFed exchange. The value MUST represent a combination of the Provider, Tenant, and role (Identity Provider or Application Provider) such that varying any of those attributes results in a different <samp>entity_id</samp>.  <br><br> If expressed as a URL, the <samp>entity_id</samp> does not need to be resolvable and does not need to match the FastFed Endpoints.  </dd>
<dt>provider_domain</dt>
<dd style="margin-left: 8">REQUIRED. A Domain Name <a href="#RFC1034" class="xref">[RFC1034]</a> for the Provider. Serves as a unique key for programmatic use cases that require awareness of a distinct Provider identity. See <a href="#ProviderMetadataEndpointValidation" class="xref">Section 4.1.1</a> for rules on validating FastFed Endpoints against the <samp>provider_domain</samp>. See <a href="#SecurityAppTrust" class="xref">Section 8.3</a> for information on how <samp>provider_domain</samp> may be used for security considerations.  <br><br> As a reference to implementers, <samp>provider_domain</samp> can serve as the basis for assigning a reputational score to different Providers and consequently varying the Administrator experience based upon whether a Provider is recognized as generally safe. Other uses may exist as well. In general, <samp>provider_domain</samp> should therefore identify a unique Provider who vends one-or-more online services that share common product ownership and vendor reputation.  </dd>
<dt>provider_contact_information</dt>
<dd style="margin-left: 8">REQUIRED. A structure describing the contact information for the Provider, defined in <a href="#ProviderContactInformation" class="xref">Section 3.3.3</a>.  </dd>
<dt>display_settings</dt>
<dd style="margin-left: 8">REQUIRED. A structure describing the display settings of the Provider, defined in <a href="#DisplaySettings" class="xref">Section 3.3.2</a>.  </dd>
<dt>capabilities</dt>
<dd style="margin-left: 8">REQUIRED. A structure describing the capabilities of the Provider, defined in <a href="#ProviderMetadataCapabilities" class="xref">Section 3.3.1</a>.  </dd>
</dl>

<p> </p>
<h1 id="rfc.section.3.3.8">
<a href="#rfc.section.3.3.8">3.3.8.</a> <a href="#IdentityProviderMetadata" id="IdentityProviderMetadata">Identity Provider Metadata</a>
</h1>
<p id="rfc.section.3.3.8.p.1">Identity Provider Metadata represents the configuration and preferences of a single tenant within the Identity Provider. The same metadata is advertised to all Application Providers who initiate a FastFed Handshake.  </p>
<p id="rfc.section.3.3.8.p.2">The data type is a structure that includes all the members defined in <a href="#CommonProviderMetadata" class="xref">Common Provider Metadata</a>, plus the following additional members: </p>

<dl>
<dt>jwks_uri</dt>
<dd style="margin-left: 8">REQUIRED. URL of the Identity Provider's JSON Web Key Set <a href="#RFC7517" class="xref">[JWK]</a> containing the signing key(s) used by the Provider. The Provider MAY use the same key set for all tenants.  </dd>
<dt>fastfed_handshake_start_uri</dt>
<dd style="margin-left: 8">REQUIRED. A URL which specifies the endpoint for the Identity Provider to receive a FastFed Handshake initiation request. See <a href="#HandshakeApplicationProviderRedirectVia302" class="xref">Section 7.2.1.7.1</a>.  </dd>
</dl>

<p> </p>
<p id="rfc.section.3.3.8.p.3">The following is a non-normative example of Identity Provider Metadata: </p>
<pre>
 {
   "identity_provider": {
     "entity_id": "https://tenant-12345.idp.example.com/"
     "provider_domain": "example.com",
     "provider_contact_information": {
       "organization": "Example Inc.",
       "phone": "+1-800-555-5555",
       "email": "support@example.com"
     },
     "display_settings": {
       "display_name": "Example Identity Provider",
       "logo_uri": "https://idp.example.com/images/logo.png",
       "icon_uri": "https://idp.example.com/images/icon.png",
       "license": "https://openid.net/intellectual-property/licenses/fastfed/1.0/"
     }
     "capabilities": {
       "authentication_profiles": [
         "urn:ietf:params:fastfed:1.0:authentication:saml:2.0:enterprise"
       ],
       "provisioning_profiles": [
         "urn:ietf:params:fastfed:1.0:provisioning:scim:2.0:enterprise"
       ],
       "schema_grammars": [
         "urn:ietf:params:fastfed:1.0:schemas:scim:2.0"
       ],
       "signing_algorithms": [
         "ES512",
         "RS256"
       ]
     },
     "jwks_uri": "https://idp.example.com/keys",
     "fastfed_handshake_start_uri": "https://tenant-12345.idp.example.com/fastfed/start",
 }
</pre>
<h1 id="rfc.section.3.3.9">
<a href="#rfc.section.3.3.9">3.3.9.</a> <a href="#ApplicationProviderMetadata" id="ApplicationProviderMetadata">Application Provider Metadata</a>
</h1>
<p id="rfc.section.3.3.9.p.1">Application Provider Metadata represents the configuration and preferences of a single tenant within the Application Provider. The Application MAY expose different metadata contents to different Identity Providers as a means to control which capabilities the Identity Provider is permitted to utilize.  </p>
<p id="rfc.section.3.3.9.p.2">For example, if an Application Provider supports both SAML and OpenID Connect as authentication protocols, but only wishes to allow the Identity Provider to use SAML, the Application would vend a metadata document that only includes SAML in the list of supported authentication methods. Similarly, if the Application supports SCIM for user provisioning, but doesn't wish to use SCIM with the Identity Provider, then the metadata would not include SCIM in the advertised capabilities.  </p>
<p id="rfc.section.3.3.9.p.3">The data type is a structure that includes all the members defined in <a href="#CommonProviderMetadata" class="xref">Common Provider Metadata</a>, plus the following additional members: </p>

<dl>
<dt>fastfed_handshake_register_uri</dt>
<dd style="margin-left: 8">REQUIRED. A URL which specifies the FastFed Handshake registration endpoint. See <a href="#HandshakeRegistrationRequest" class="xref">Section 7.2.3.1</a>.  </dd>
</dl>

<p> </p>
<p id="rfc.section.3.3.9.p.4">The following is a non-normative example of Application Provider Metadata: </p>
<pre>
 {
   "application_provider": {
     "entity_id": "https://tenant-67890.app.example.com/"
     "provider_domain": "example.com",
     "provider_contact_information": {
       "organization": "Example Inc.",
       "phone": "+1-800-555-5555",
       "email": "support@example.com"
     },
     "display_settings": {
       "display_name": "Example Application Provider",
       "logo_uri": "https://app.example.com/images/logo.png",
       "icon_uri": "https://app.example.com/images/icon.png",
       "license": "https://openid.net/intellectual-property/licenses/fastfed/1.0/"
     }
     "capabilities": {
       "authentication_profiles": [
         "urn:ietf:params:fastfed:1.0:authentication:saml:2.0:enterprise"
       ],
       "provisioning_profiles": [
         "urn:ietf:params:fastfed:1.0:provisioning:scim:2.0:enterprise"
       ],
       "schema_grammars": [
         "urn:ietf:params:fastfed:1.0:schemas:scim:2.0"
       ],
       "signing_algorithms": [
         "ES512",
         "RS256"
       ]
     },
     "fastfed_handshake_register_uri": "https://tenant-67890.app.example.com/fastfed/register"
 }
</pre>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> <a href="#MetadataEndpoints" id="MetadataEndpoints">Metadata Endpoints</a>
</h1>
<p id="rfc.section.4.p.1">Metadata Endpoints describe the semantics for reading Metadata documents.  </p>
<h1 id="rfc.section.4.1">
<a href="#rfc.section.4.1">4.1.</a> <a href="#ProviderMetadataEndpoint" id="ProviderMetadataEndpoint">Provider Metadata Endpoint</a>
</h1>
<p id="rfc.section.4.1.p.1">A request to this endpoint will return the Provider Metadata document defined in <a href="#ProviderMetadata" class="xref">Section 3.3</a>.  </p>
<p id="rfc.section.4.1.p.2">The Provider Metadata Endpoint MUST be accessible to other Providers who are permitted to initiate a FastFed Handshake Flow with the entity.  Access to the Endpoint SHOULD NOT require Administrators to perform pre-configuration or pre-registration of any form between the two Providers, except the necessary act of inputting the URL for the Provider Metadata Endpoint (a.k.a. "FastFed URL") to initiate the FastFed Handshake if the endpoint location is not discoverable through other means. Requests to the endpoint may be rate-limited or otherwise limited to prevent a denial-of-service attack.  </p>
<h1 id="rfc.section.4.1.1">
<a href="#rfc.section.4.1.1">4.1.1.</a> <a href="#ProviderMetadataEndpointValidation" id="ProviderMetadataEndpointValidation">Endpoint Validation</a>
</h1>
<p id="rfc.section.4.1.1.p.1">To prevent impersonation of Providers, the value of the <samp>provider_domain</samp> returned in the Metadata (<a href="#CommonProviderMetadata" class="xref">Section 3.3.7</a>) MUST suffix-match the domain of the Metadata Endpoint.  </p>
<p id="rfc.section.4.1.1.p.2">The Metadata Endpoint MAY be hosted at a subdomain of the <samp>provider_domain</samp>.  </p>
<p id="rfc.section.4.1.1.p.3">A TLS server certificate check MUST be performed when connecting to the Metadata Endpoint to verify Provider ownership of the domain. See <a href="#SecurityAppTrust" class="xref">Section 8.3</a>.  </p>
<p id="rfc.section.4.1.1.p.4">The following is a non-normative example showing valid and invalid Metadata Endpoints.  </p>
<pre>
 For a Metadata document containing the following domain name:
     {
       "provider_domain: "idp.example.com",
       ...
     }
 
 The name is valid if retrieved from any of these Endpoints:

     https://idp.example.com/                 --&gt; OK. Exact Match.
     https://tenant-12345.idp.example.com/    --&gt; OK. Suffix Match.
     https://idp.example.com/fastfed/metadata --&gt; OK. Exact Match + Path.

 The name is invalid if retrieved from any of these Endpoints:
 
     https://idp.example.com.otherdomain.com/ --&gt; INVALID. No suffix match.
     https://example.com/                     --&gt; INVALID. Incomplete match.
     http://idp.example.com/                  --&gt; INVALID. Not https.

</pre>
<p id="rfc.section.4.1.1.p.5">If the <samp>provider_domain</samp> is invalid, the FastFed Handshake MUST be halted as specified in <a href="#HandshakeHalt" class="xref">Section 7.1.4</a>.  </p>
<h1 id="rfc.section.4.1.2">
<a href="#rfc.section.4.1.2">4.1.2.</a> <a href="#ProviderMetadataEndpointDiscovery" id="ProviderMetadataEndpointDiscovery">Endpoint Discovery</a>
</h1>
<h1 id="rfc.section.4.1.2.1">
<a href="#rfc.section.4.1.2.1">4.1.2.1.</a> <a href="#ProviderMetadataEndpointDiscoveryWebFinger" id="ProviderMetadataEndpointDiscoveryWebFinger">Email-based Discovery via WebFinger</a>
</h1>
<p id="rfc.section.4.1.2.1.p.1">Discovering the location of a Provider Metadata Endpoint for a specific end-user can be achieved through several means. If the user's email address is available to the Application Provider, the RECOMMENDED method of discovery is via a WebFinger request <a href="#RFC7033" class="xref">[RFC7033]</a> to the user's email domain.  </p>
<h1 id="rfc.section.4.1.2.1.1">
<a href="#rfc.section.4.1.2.1.1">4.1.2.1.1.</a> <a href="#ProviderMetadataEndpointDiscoveryWebFingerEndpoint" id="ProviderMetadataEndpointDiscoveryWebFingerEndpoint">WebFinger Endpoints</a>
</h1>
<p id="rfc.section.4.1.2.1.1.p.1">WebFinger traditionally requires a webserver hosted at the root domain. For example, if a user's email address is <samp>"user@company.com"</samp>, WebFinger requests are sent to <samp>"https://company.com/.well_known/webfinger"</samp>.  </p>
<p id="rfc.section.4.1.2.1.1.p.2">However, administrators at large enterprises can experience organizational roadblocks when attempting to host a WebFinger discovery endpoint at the root domain. This is because the root domain is often the public-facing product or web presence for an organization. This domain is often maintained by different owners who possess security and operational privileges that FastFed administrators may not share.  </p>
<p id="rfc.section.4.1.2.1.1.p.3">Therefore, to simplify adoption, FastFed supports WebFinger discovery using subdomains. The subdomain location is determined by prefixing the email domain with <samp>"fastfed._well_known"</samp>. For example, if the user email is <samp>"babs@example.com"</samp>, the resulting Webfinger endpoint is <samp>"https://fastfed._well_known.example.com"</samp>.  </p>
<h1 id="rfc.section.4.1.2.1.2">
<a href="#rfc.section.4.1.2.1.2">4.1.2.1.2.</a> <a href="#ProviderMetadataEndpointDiscoveryWebFingerQueries" id="ProviderMetadataEndpointDiscoveryWebFingerQueries">WebFinger Queries</a>
</h1>
<p id="rfc.section.4.1.2.1.2.p.1">FastFed uses the following <samp>rel</samp> value in WebFinger: </p>
<table cellpadding="3" cellspacing="0" class="tt full center">
<thead><tr>
<th class="left">RelType</th>
<th class="left">URI</th>
</tr></thead>
<tbody><tr>
<td class="left">FastFed Provider</td>
<td class="left">https://openid.net/specs/fastfed/1.0/provider</td>
</tr></tbody>
</table>
<p id="rfc.section.4.1.2.1.2.p.2">To start discovery of FastFed endpoints, the Application Provider makes an HTTP GET request to the WebFinger [RFC7033] endpoint with the <samp>resource</samp> value set to the user email address prepended with the <samp>acct:</samp> scheme <a href="#RFC7565" class="xref">[RFC7565]</a>. All WebFinger communication MUST utilize TLS in the manner described in <a href="#HanshakeTLSRequirements" class="xref">Section 7.1.1</a>.  </p>
<p id="rfc.section.4.1.2.1.2.p.3">The FastFed Provider Metadata location MUST be returned in the WebFinger response as the value of the <samp>href</samp> member of a <samp>links</samp> array element with <samp>rel</samp> member value <samp>http://openid.net/specs/fastfed/1.0/provider</samp>. (Per Section 7 of WebFinger <a href="#RFC7033" class="xref">[RFC7033]</a>, obtaining the WebFinger response may first involve following some redirects.) </p>
<p id="rfc.section.4.1.2.1.2.p.4">The returned Issuer location MUST be a URI <a href="#RFC3986" class="xref">[RFC3986]</a> with a scheme component that MUST be https, a host component, and optionally, port and path components and no query or fragment components. Note that the WebFinger request may return a metadata location hosted under a different domain than the user's email.  </p>
<p id="rfc.section.4.1.2.1.2.p.5">The WebFinger endpoint MAY return a static response to any query, regardless of input parameters. This can be useful, for example, when all users under the same domain will share the same Identity Provider. A static response allows the WebFinger hosting provider to use a static file and avoid the overhead of operating a full-featured WebFinger service.  </p>
<p id="rfc.section.4.1.2.1.2.p.6">To allow the use of static responses, <samp>subject</samp> MAY be omitted from the WebFinger response.  </p>
<p id="rfc.section.4.1.2.1.2.p.7">The following non-normative example demonstrates the discovery of FastFed Provider Metadata for <samp>jane@example.com</samp>. The WebFinger parameters are as follows: </p>
<table cellpadding="3" cellspacing="0" class="tt full center">
<thead><tr>
<th class="left">WebFinger Parameter</th>
<th class="left">Value</th>
</tr></thead>
<tbody>
<tr>
<td class="left">resource</td>
<td class="left">acct:jane@example.com</td>
</tr>
<tr>
<td class="left">host</td>
<td class="left">example.com</td>
</tr>
<tr>
<td class="left">rel</td>
<td class="left">https://openid.net/specs/fastfed/1.0/provider</td>
</tr>
</tbody>
</table>
<p id="rfc.section.4.1.2.1.2.p.8">The Application Provider makes a WebFinger request to the well-known FastFed subdomain endpoint (with line wraps for display purposes only): </p>
<pre>
  GET /
    ?resource=acct%3Ajane%40example.com
    &amp;rel=http%3A%2F%2Fopenid.net%2Fspecs%2Ffastfed%2F1.0%2Fprovider
    HTTP/1.1
  Host: fastfed._well_known.example.com
</pre>
<pre> 
  HTTP/1.1 200 OK
  Content-Type: application/jrd+json

  {
   "subject": "acct:jane@example.com",
   "links":
    [
     {
      "rel": "http://openid.net/specs/fastfed/1.0/provider",
      "href": "https://tenant-12345.idp.example.com/fastfed"
     }
    ]
  }
</pre>
<h1 id="rfc.section.4.1.2.2">
<a href="#rfc.section.4.1.2.2">4.1.2.2.</a> <a href="#ProviderMetadataEndpointDiscoveryAlternative" id="ProviderMetadataEndpointDiscoveryAlternative">Alternative Discovery Mechanisms</a>
</h1>
<p id="rfc.section.4.1.2.2.p.1">Application Providers MAY use other means of discovering the FastFed URL for an Identity Provider. This is an implementation detail.  </p>
<p id="rfc.section.4.1.2.2.p.2">As a reference to implementers, another mechanism may be to ask the Administrator to read the single sign-on documentation provided by their Identity Provider to find the FastFed URL and then paste the value into a form field.  </p>
<h1 id="rfc.section.4.1.3">
<a href="#rfc.section.4.1.3">4.1.3.</a> <a href="#ProviderMetadataEndpointRead" id="ProviderMetadataEndpointRead">Read Request</a>
</h1>
<p id="rfc.section.4.1.3.p.1">After the endpoint is discovered, Provider Metadata can be read by making an HTTP GET request to the Provider Metadata Endpoint.  </p>
<p id="rfc.section.4.1.3.p.2">The following is a non-normative example read request: </p>
<pre>
  GET /fastfed/provider-metadata HTTP/1.1
  Accept: application/json
  Host: provider.example.com
</pre>
<h1 id="rfc.section.4.1.4">
<a href="#rfc.section.4.1.4">4.1.4.</a> <a href="#ProviderMetadataEndpointResponse" id="ProviderMetadataEndpointResponse">Read Response</a>
</h1>
<p id="rfc.section.4.1.4.p.1">Upon a successful read operation, the server SHOULD return all available Provider Metadata.  </p>
<p id="rfc.section.4.1.4.p.2">A successful response SHOULD use the HTTP 200 OK status code and return a JSON document <a href="#RFC4627" class="xref">[RFC4627]</a> using the application/json_content type with the Provider Metadata values as top-level members of the root JSON object.  </p>
<p id="rfc.section.4.1.4.p.3">The following is a non-normative example read response (with line wraps within values for display purposes only): </p>
<pre>
 HTTP/1.1 200 OK
 Content-Type: application/json
 {
   "identity_provider": {
     "entity_id": "https://tenant-12345.idp.example.com/"
     "provider_domain": "example.com",
     "provider_contact_information": {
       "organization": "Example Inc.",
       "phone": "+1-800-555-5555",
       "email": "support@example.com"
     },
     "display_settings": {
       "display_name": "Example Identity Provider",
       "logo_uri": "https://idp.example.com/images/logo.png",
       "icon_uri": "https://idp.example.com/images/icon.png",
       "license": "https://openid.net/intellectual-property/licenses/fastfed/1.0/"
     }
     "capabilities": {
       "authentication_profiles": [
         "urn:ietf:params:fastfed:1.0:authentication:saml:2.0:enterprise"
       ],
       "provisioning_profiles": [
         "urn:ietf:params:fastfed:1.0:provisioning:scim:2.0:enterprise"
       ],
       "schema_grammars": [
         "urn:ietf:params:fastfed:1.0:schemas:scim:2.0"
       ],
       "signing_algorithms": [
         "ES512",
         "RS256"
       ]
     },
     "jwks_uri": "https://idp.example.com/keys",
     "fastfed_handshake_start_uri": "https://tenant-12345.idp.example.com/fastfed/start",
 }
</pre>
<h1 id="rfc.section.4.1.5">
<a href="#rfc.section.4.1.5">4.1.5.</a> <a href="#MetadataRefresh" id="MetadataRefresh">Metadata Refresh</a>
</h1>
<p id="rfc.section.4.1.5.p.1">Provider Metadata contains information that may be used on a recurring basis, such as the list of supported signing algorithms and URLs of image files. Consumers of the metadata SHOULD locally cache the metadata information and image files that will be used on an ongoing basis after the FastFed Handshake completes.  </p>
<p id="rfc.section.4.1.5.p.2">A Provider is permitted to refresh the following values from another Provider's Metadata Endpoint on a recurring basis, outside the context of a FastFed Handshake.  </p>

<ul>
<li>From the <a href="#ProviderContactInformation" class="xref">Provider Contact Information</a>: <ul>
<li><samp>organization</samp></li>
<li><samp>phone</samp></li>
<li><samp>email</samp></li>
</ul>
<p> </p>
</li>
<li>From the <a href="#DisplaySettings" class="xref">Display Settings</a>: <ul>
<li><samp>logo_uri</samp></li>
<li><samp>icon_uri</samp></li>
</ul>
<p> </p>
</li>
<li>From the <a href="#ProviderMetadataCapabilities" class="xref">Capabilities</a>: <ul><li><samp>signing_algorithms</samp></li></ul>
<p> </p>
</li>
</ul>

<p> </p>
<p id="rfc.section.4.1.5.p.3">The image files hosted at the <samp>logo_uri</samp> and <samp>icon_uri</samp> MAY be updated either by publishing a new URI in the metadata file or by modifying the contents hosted at the same URI.  </p>
<p id="rfc.section.4.1.5.p.4">In addition to the attributes listed above, <a href="#ProviderAuthenticationMethods" class="xref">Section 6</a> specifies the requirements for key rotation and signing algorithm selection.  </p>
<p id="rfc.section.4.1.5.p.5">Any other metadata defined in the FastFed Core specification MUST ONLY be updated by completing a FastFed Handshake.  </p>
<p id="rfc.section.4.1.5.p.6">The following describes the responsibilities of metadata publishers and consumers to enable refresh activities of the FastFed Core metadata.  </p>
<p id="rfc.section.4.1.5.p.7">The following applies to a publisher of metadata information: </p>

<ul>
<li>MAY alter the content returned from the Provider Metadata Endpoint or the content of the image files referenced by URL within the Provider Metadata.  </li>
<li>MUST support the HTTP 1.1 ETag semantics <a href="#RFC2616" class="xref">[RFC2616]</a> for all requests to the URLs, including: <ul>
<li>Returning an ETag response header </li>
<li>Accepting an If-None-Match request header, and returning an HTTP 304 response if the object is unmodified.  </li>
</ul>
<p> </p>
</li>
</ul>

<p> </p>
<p id="rfc.section.4.1.5.p.8">The following requirements apply to a consumer of metadata information: </p>

<ul>
<li>For any locally cached data, MUST re-query the URLs at least once every 24 hours to check if a new version of the object is available to replace a local copy.  </li>
<li>MUST include the If-None-Match header in the query, populated with the value of the ETag response header received when initially downloading the content.  </li>
<li>MUST handle an HTTP 304 response code which indicates that the content is unchanged.  </li>
<li>MUST ignore any changes to attributes that are not in the permitted list of modifiable values enumerated in this section.  </li>
</ul>

<p> </p>
<p id="rfc.section.4.1.5.p.9">It is possible that refreshed metadata may contain errors or incompatibilities. For example, an updated image URL may point to a missing or malformed image, or an updated list of signing algorithms may result in two providers no longer sharing a mutually compatible algorithm. In error situations, the consumer of the metadata MAY continue to rely on previously cached values. They SHOULD signal the error situation to the Administrator or Metadata Provider as necessary to resolve the error. Notification mechanisms are outside the scope of FastFed.  </p>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> <a href="#ProviderCompatibilityEvaluation" id="ProviderCompatibilityEvaluation">Provider Compatibility Evaluation</a>
</h1>
<p id="rfc.section.5.p.1">A compatibility evaluation is the act of comparing the abilities of two Providers to determine if they can interoperate. For FastFed, this is accomplished by examining the intersection of <a href="#ProviderMetadataCapabilities" class="xref">Provider Capabilities</a>. The process is specified below.  </p>
<p id="rfc.section.5.p.2">For reference, all FastFed Capabilities are represented as lists of strings. This includes the following attributes: </p>

<ul>
<li>authentication_profiles</li>
<li>provisioning_profiles</li>
<li>schema_grammars</li>
<li>signing_algorithms</li>
</ul>

<p> </p>
<p id="rfc.section.5.p.3">Required attributes MUST have at least one valid element in the list. Optional attributes MAY have any number of elements in the list, including no elements. An optional attribute that is omitted from the configuration, or defined as a null value, MUST be treated equivalently to an empty list.  </p>
<p id="rfc.section.5.p.4">Each list is evaluated for compatibility via the following steps: </p>

<ul>
<li>If the list from Identity Provider and the list from the Application Provider are both defined and non-empty, the intersection is calculated between the lists. If the resulting intersection is also non-empty, the Providers are compatible for those elements in the intersection.  </li>
<li>Otherwise, if one or both lists are empty, see <a href="#ProviderCompatibilityEvaluationEmptyList" class="xref">Section 5.1</a> for special handling of empty capabilities.  </li>
</ul>

<p> </p>
<p id="rfc.section.5.p.5">The resulting intersection of capabilities represents the compatible choices which a Provider can select from when determining how to configure federation with another Provider.  </p>
<p id="rfc.section.5.p.6">If the Providers are not compatible for one or more FastFed Capabilities, then the Providers MUST be treated as incompatible.  </p>
<p id="rfc.section.5.p.7">The handling of incompatibilities depends on the context in which evaluation occurred and is described elsewhere in the specification. The most common situation is when compatibility is tested during the FastFed Handshake. In this situation, failure causes the handshake to halt and a diagnostic error message is displayed to the end-user.  </p>
<h1 id="rfc.section.5.1">
<a href="#rfc.section.5.1">5.1.</a> <a href="#ProviderCompatibilityEvaluationEmptyList" id="ProviderCompatibilityEvaluationEmptyList">Handling Empty Capabilities</a>
</h1>
<p id="rfc.section.5.1.p.1">A special case of compatibility evaluation occurs when one of the Providers returns an empty value for an attribute, such as <samp>provisioning_profiles</samp> or <samp>authentication_profiles</samp>.  </p>
<p id="rfc.section.5.1.p.2">The following rules MUST apply for handling empty values: </p>

<ul>
<li>If the Application Provider Metadata contains an empty value for either <samp>provisioning_profiles</samp> or <samp>authentication_profiles</samp>, the Identity Provider MUST treat this as a signal that the Application Provider does not need the capability. The Identity Provider MUST omit the value from subsequent steps of the FastFed Handshake and not enable the capability after the handshake completes.  </li>
<li>If the Application Provider Metadata contains an empty value for BOTH <samp>provisioning_profiles</samp> and <samp>authentication_profiles</samp>, the Identity Provider MUST treat this as a signal that the Application Provider wishes to disable all functionality and deactivate the federation relationship. If a federation relationship exists, the Identity Provider MUST omit the values from subsequent steps of the FastFed Handshake and disable all federation capabilities upon completion of the handshake. If a federation relationship does not currently exist, this scenario MUST be treated as an invalid request from the Application Provider and the FastFed Handshake halted.  </li>
<li>If the Identity Provider Metadata contains an empty value for either <samp>provisioning_profiles</samp> or <samp>authentication_profiles</samp> and the Application Provider considers the capability to be essential for successful usage of the application, the Application Provider MUST treat this as an incompatibility.  </li>
</ul>

<p> </p>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> <a href="#ProviderAuthenticationMethods" id="ProviderAuthenticationMethods">Provider Authentication Methods</a>
</h1>
<p id="rfc.section.6.p.1">Portions of the FastFed Handshake require the transmission of signed messages from the Identity Provider to the Application Provider. Additionally, some profiles such as <a href="#FastFedProfile.EnterpriseSCIM" class="xref">SCIM Provisioning</a> also require authentication by a Provider.  </p>
<p id="rfc.section.6.p.2">FastFed intentionally avoids long-lived shared secrets for signing and authentication purposes. Instead, FastFed Providers use public/private key pairs. The intention is to eliminate the burden upon Administrators who would otherwise be required to re-execute the FastFed Handshake to rotate long-lived shared secrets or update signing algorithms.  </p>
<p id="rfc.section.6.p.3">This section specifies how keys are discovered and utilized in FastFed.  </p>
<h1 id="rfc.section.6.1">
<a href="#rfc.section.6.1">6.1.</a> <a href="#ProviderAuthenticationMethodsKeyDiscovery" id="ProviderAuthenticationMethodsKeyDiscovery">Key   Discovery</a>
</h1>
<p id="rfc.section.6.1.p.1">The FastFed Handshake only necessitates authentication by the Identity Provider. Hence, in this specification, only the Identity Provider is required to provide a key set.  </p>
<p id="rfc.section.6.1.p.2">Public keys for the Identity Provider are found at the location specified by the <samp>jwks_uri</samp> in the <a href="#IdentityProviderMetadata" class="xref">Identity Provider Metadata</a>.  </p>
<p id="rfc.section.6.1.p.3">Providers MAY use the same <samp>jwks_uri</samp> across all tenants and all federation relationships.  </p>
<h1 id="rfc.section.6.2">
<a href="#rfc.section.6.2">6.2.</a> <a href="#ProviderAuthenticationMethodsKeyRotation" id="ProviderAuthenticationMethodsKeyRotation">Key Rotation</a>
</h1>
<p id="rfc.section.6.2.p.1">Providers SHOULD rotate keys on an ongoing basis.  </p>
<p id="rfc.section.6.2.p.2">Rotation of signing keys can be accomplished with the following approach. The signer publishes its keys in a JWK Set at its jwks_uri location and includes the kid of the signing key in the JOSE Header of each message to indicate to the verifier which key is to be used to validate the signature. Keys can be rolled over by periodically adding new keys to the JWK Set at the jwks_uri location. The signer can begin using a new key at its discretion and signals the change to the verifier using the kid value. The verifier knows to go back to the jwks_uri location to re-retrieve the keys when it sees an unfamiliar kid value. The JWK Set document at the jwks_uri SHOULD retain recently decommissioned signing keys for a reasonable period of time to facilitate a smooth transition.  </p>
<h1 id="rfc.section.6.3">
<a href="#rfc.section.6.3">6.3.</a> <a href="#ProviderAuthenticationMethodsAlgSelection" id="ProviderAuthenticationMethodsAlgSelection">Algorithm Selection</a>
</h1>
<p id="rfc.section.6.3.p.1">The signing algorithms supported by a Provider are specified in the <samp>signing_algorithms</samp> attribute in the <a href="#ProviderMetadataCapabilities" class="xref">Provider Capabilities Metadata</a>.  </p>
<p id="rfc.section.6.3.p.2">Current best practices for signing algorithms can evolve over time. Therefore, Providers SHOULD publish updated FastFed Metadata with new signing algorithms as necessary to evolve with current best practices. Consumers of the FastFed Metadata MUST periodically refresh any cached information as described in <a href="#MetadataRefresh" class="xref">Section 4.1.5</a> in order to maintain a current list of supported algorithms for a Provider.  </p>
<p id="rfc.section.6.3.p.3">When updating, Providers SHOULD add new algorithms but SHOULD NOT remove existing algorithms that are actively being used unless necessary for security purposes, since removing an algorithm may break existing federation relationships.  </p>
<p id="rfc.section.6.3.p.4">If two Providers are compatible for multiple signing algorithms, the signer may select any mutually compatible algorithm. The Provider SHOULD avoid known weak algorithms which do not reflect current best practices.  </p>
<h1 id="rfc.section.6.4">
<a href="#rfc.section.6.4">6.4.</a> <a href="#ProviderAuthenticationMethodsJWT" id="ProviderAuthenticationMethodsJWT">JWT Requirements</a>
</h1>
<p id="rfc.section.6.4.p.1">Portions of the FastFed Handshake require the transmission of a signed JWT <a href="#RFC7519" class="xref">[RFC7519]</a>. This section describes the requirements for JWT usage within FastFed.  </p>
<p id="rfc.section.6.4.p.2">JWT serialization MUST use JWS Compact Serialization <a href="#RFC7517" class="xref">[RFC7517]</a>.  </p>
<p id="rfc.section.6.4.p.3">The JWT header MUST contain the following attributes; </p>

<dl>
<dt>alg</dt>
<dd style="margin-left: 8">The signing algorithm MUST be a compatible <a href="#RFC7515" class="xref">JWS</a> <samp>alg</samp> algorithm <a href="#RFC7518" class="xref">[JWA]</a> specified by both Providers in the <samp>signing_algorithms</samp> attribute of the <a href="#ProviderMetadataCapabilities" class="xref">Provider Capabilities</a>.  </dd>
<dt>kid</dt>
<dd style="margin-left: 8">The JWS signing key MUST exist in the JSON Web Key Set <a href="#RFC7517" class="xref">[JWK]</a>. For the FastFed Handshake, the location of the key set is specified by the <samp>jwks_uri</samp> parameter of the <a href="#IdentityProviderMetadata" class="xref">Identity Provider Metadata</a>. Other profiles, such as <a href="#FastFedProfile.EnterpriseSCIM" class="xref">SCIM provisioning</a>, may specify alternative key sets. The <samp>alg</samp> associated with the signing key MUST match the <samp>alg</samp> used to sign the JWT.  </dd>
</dl>

<p> </p>
<p id="rfc.section.6.4.p.4">The JWT payload MUST contain the following attributes: </p>

<dl>
<dt>iss</dt>
<dd style="margin-left: 8">The value MUST match the <samp>entity_id</samp> of the Provider generating the JWT, as specified in the <a href="#CommonProviderMetadata" class="xref">Provider Metadata</a>.  </dd>
<dt>aud</dt>
<dd style="margin-left: 8">The value MUST match the <samp>entity_id</samp> of the intended recipient of the JWT, as specified in the recipient's <a href="#CommonProviderMetadata" class="xref">Provider Metadata</a>.  </dd>
<dt>exp</dt>
<dd style="margin-left: 8">Expiration time SHOULD be as short as possible. As a reference to implementors, a 10-minute expiration window is often sufficient to reduce the risk of replays while still allowing a small degree of clock skew between participants.  </dd>
</dl>

<p> A JWT MAY include additional attributes in addition to the list above.  </p>
<h1 id="rfc.section.6.5">
<a href="#rfc.section.6.5">6.5.</a> <a href="#ProviderAuthenticationMethodsProtocolSpecific" id="ProviderAuthenticationMethodsProtocolSpecific">Protocol-specific Key Materials</a>
</h1>
<p id="rfc.section.6.5.p.1">Protocols such as SAML and OpenID Connect each define their own protocol-specific key materials.  </p>
<p id="rfc.section.6.5.p.2">Wherever they exist, the protocol-specific key materials should continue to be used. For example, SAML defines a Metadata format which includes a certificate. This certificate should continue to be used for signing SAML messages as per the SAML specifications. FastFed provides the means to discover and exchange the SAML metadata files.  </p>
<h1 id="rfc.section.6.6">
<a href="#rfc.section.6.6">6.6.</a> <a href="#OAuth2WithJWTProfile" id="OAuth2WithJWTProfile">OAuth 2.0 with JWT Profile</a>
</h1>
<p id="rfc.section.6.6.p.1">Not all protocols offer a built-in authentication mechanism. For example, SCIM <a href="#RFC7644" class="xref">[RFC7644]</a> does not specify how to attain authentication materials. For these situations, FastFed fills in the gaps.  </p>
<p id="rfc.section.6.6.p.2">For protocols requiring OAuth 2.0 access tokens, a FastFed profile MAY utilize the JSON Web Token (JWT) Profile for OAuth 2.0 Client Authentication and Authorization Grants <a href="#RFC7523" class="xref">[RFC7523]</a>.  </p>
<p id="rfc.section.6.6.p.3">This specification defines a mechanism for exchanging a signed JWT for an OAuth 2.0 <samp>access_token</samp>.  </p>
<p id="rfc.section.6.6.p.4">An end-to-end example of this approach can be found in Section 5 of the FastFed Profile for SCIM provisioning <a href="#FastFedProfile.EnterpriseSCIM" class="xref">[FastFedProfile.EnterpriseSCIM]</a>.  </p>
<p id="rfc.section.6.6.p.5">The following are common requirements for any profile utilizing <a href="#RFC7523" class="xref">RFC 7523</a>.  </p>
<p></p>

<ol>
<li>Providers MUST be compliant with Section 2.1 of <a href="#RFC7523" class="xref">RFC 7523</a>, "Using JWTs as Authorization Grants".  </li>
<li>The JWT MUST be formatted according to the <a href="#ProviderAuthenticationMethodsJWT" class="xref">FastFed JWT Requirements</a>.  </li>
<li>The JWT MUST be signed using one of the mutually compatible algorithms negotiated during the FastFed Handshake based upon the contents of the <samp>signing_algorithms</samp> attribute defined in <a href="#ProviderMetadataCapabilities" class="xref">Section 3.3.1</a> of Provider Metadata.  </li>
<li>The token endpoint MUST NOT require an OAuth 2.0 <samp>client_id</samp>. FastFed does not require the exchange of a <samp>client_id</samp>.  </li>
</ol>

<p> </p>
<h1 id="rfc.section.7">
<a href="#rfc.section.7">7.</a> <a href="#Handshake" id="Handshake">FastFed Handshake</a>
</h1>
<h1 id="rfc.section.7.1">
<a href="#rfc.section.7.1">7.1.</a> <a href="#HandshakeCommon" id="HandshakeCommon">Common Considerations</a>
</h1>
<h1 id="rfc.section.7.1.1">
<a href="#rfc.section.7.1.1">7.1.1.</a> <a href="#HanshakeTLSRequirements" id="HanshakeTLSRequirements">TLS Requirements</a>
</h1>
<p id="rfc.section.7.1.1.p.1">All implementations MUST require the use of TLS for all FastFed Endpoints, including the Metadata Endpoints and FastFed Handshake Endpoints.  </p>
<p id="rfc.section.7.1.1.p.2">Which TLS version(s) ought to be implemented will vary over time, and depends on the widespread deployment and known security vulnerabilities at the time of implementation. To protect against information disclosure and tampering, confidentiality protection MUST be applied using TLS with a ciphersuite that provides confidentiality and integrity protection.  </p>
<p id="rfc.section.7.1.1.p.3">Whenever TLS is used, a TLS server certificate check MUST be performed, per <a href="#RFC6125" class="xref">[RFC6125]</a>.  </p>
<h1 id="rfc.section.7.1.2">
<a href="#rfc.section.7.1.2">7.1.2.</a> <a href="#HandshakeHTTPRedirects" id="HandshakeHTTPRedirects">HTTP Redirects</a>
</h1>
<p id="rfc.section.7.1.2.p.1">This specification makes use of HTTP redirection, in which a Provider directs the Administrator's user-agent to another destination.  While the examples in this specification show the use of the HTTP 302 status code, any other method available via the user-agent to accomplish this redirection is allowed and is considered to be an implementation detail.  </p>
<h1 id="rfc.section.7.1.3">
<a href="#rfc.section.7.1.3">7.1.3.</a> <a href="#HandshakeSerialization" id="HandshakeSerialization">Query String Serialization</a>
</h1>
<p id="rfc.section.7.1.3.p.1">The FastFed Handshake uses HTTP GET with Query String Serialization to transmit requests.  </p>
<p id="rfc.section.7.1.3.p.2">In order to serialize the parameters using the Query String Serialization, the Client constructs the string by adding the parameters and values to the query component of a URL using the application/x-www-form-urlencoded format as defined by <a href="#W3C.REC-html401-19991224" class="xref">[W3C.REC-html401-19991224]</a>. Query String Serialization is typically used in HTTP GET requests. The same serialization method is also used when adding parameters to the fragment component of a URL.  </p>
<h1 id="rfc.section.7.1.4">
<a href="#rfc.section.7.1.4">7.1.4.</a> <a href="#HandshakeHalt" id="HandshakeHalt">Halting the Handshake</a>
</h1>
<p id="rfc.section.7.1.4.p.1">In certain circumstances, the FastFed Handshake cannot proceed and must be halted. This may occur, for example, if the Providers do not share common capabilities.  </p>
<p id="rfc.section.7.1.4.p.2">When halting the handshake, the Provider who decides to halt SHOULD display an informative message to the Administrator explaining why the action was halted and any steps that can be taken by the Administrator to correct the situation. The details of this communication to the Administrator are outside the scope of the specification.  </p>
<h1 id="rfc.section.7.1.5">
<a href="#rfc.section.7.1.5">7.1.5.</a> <a href="#UpdatesAndDuplicates" id="UpdatesAndDuplicates">Handling Updates and Duplicates</a>
</h1>
<p id="rfc.section.7.1.5.p.1">The FastFed Handshake is intended to support both the creation of a new federation relationship as well as the update of an existing relationship. Examples of update scenarios can include changing, adding, or removing any of the authentication and provisioning profiles, as well as changing the schema.  </p>
<p id="rfc.section.7.1.5.p.2">In addition, because the FastFed Handshake relies on an exchange of HTTP messages, operational events such as network timeouts and other factors can result in a single message being redriven to a recipient multiple times. Therefore, duplicate messages can also occur during the handshake.  </p>
<p id="rfc.section.7.1.5.p.3">Duplicates and redrives are detected by examining the <samp>entity_id</samp> of the Identity Provider and Application Provider involved in a FastFed exchange. If the values match an existing federation relationship, an event will be evaluated against the existing relationship.  </p>
<p id="rfc.section.7.1.5.p.4">Where needed, the individual steps of the FastFed Handshake specify the correct handling of updates and redrives.  </p>
<h1 id="rfc.section.7.2">
<a href="#rfc.section.7.2">7.2.</a> <a href="#HandshakeFlow" id="HandshakeFlow">Handshake Flow</a>
</h1>
<h1 id="rfc.section.7.2.1">
<a href="#rfc.section.7.2.1">7.2.1.</a> <a href="#HandshakeStart" id="HandshakeStart">Handshake Initiation at Application Provider</a>
</h1>
<h1 id="rfc.section.7.2.1.1">
<a href="#rfc.section.7.2.1.1">7.2.1.1.</a> <a href="#HandshakeApplicationProviderPrerequisites" id="HandshakeApplicationProviderPrerequisites">Prerequisites</a>
</h1>
<p id="rfc.section.7.2.1.1.p.1">Prior to beginning the FastFed Handshake, the Application Provider MUST perform Endpoint Discovery (<a href="#ProviderMetadataEndpointDiscovery" class="xref">Section 4.1.2</a>) to discover the Identity Provider Metadata Endpoint URI(s).  </p>
<p id="rfc.section.7.2.1.1.p.2">The Application Provider MUST also authenticate the Administrator and verify they are authorized to initiate the FastFed Handshake. The means of doing so are outside the scope of this specification.  </p>
<h1 id="rfc.section.7.2.1.2">
<a href="#rfc.section.7.2.1.2">7.2.1.2.</a> <a href="#HandshakeApplicationProviderReadsIdentityProviderMetadata" id="HandshakeApplicationProviderReadsIdentityProviderMetadata">Application Provider Reads Identity Provider Metadata</a>
</h1>
<p id="rfc.section.7.2.1.2.p.1">The process of Endpoint Discovery (<a href="#ProviderMetadataEndpointDiscovery" class="xref">Section 4.1.2</a>) may result in the discovery of one-or-more possible Identity Providers.  </p>
<p id="rfc.section.7.2.1.2.p.2">For each discovered Identity Provider, the Application Provider queries the <a href="#ProviderMetadataEndpoint" class="xref">Identity Provider Metadata Endpoint</a>.  </p>
<p id="rfc.section.7.2.1.2.p.3">If the Identity Provider Metadata cannot be downloaded or is missing required elements, the FastFed Handshake MUST be halted for the affected Identity Provider.  </p>
<p id="rfc.section.7.2.1.2.p.4">Prior to using any information in the metadata response, the Application Provider MUST validate the <samp>provider_domain</samp> as specified in <a href="#ProviderMetadataEndpointValidation" class="xref">Section 4.1.1</a>.  </p>
<p id="rfc.section.7.2.1.2.p.5">If multiple Identity Providers were discovered and the metadata successfully retrieved and validated, one Provider MUST be selected before continuing the FastFed Handshake. Selection is an implementation detail outside the scope of the specification. As a reference to implementors, one possible implementation is to display the list of Providers to the Administrator with a summary of the capabilities, and then ask the Administrator to select.  </p>
<h1 id="rfc.section.7.2.1.3">
<a href="#rfc.section.7.2.1.3">7.2.1.3.</a> <a href="#HandshakeApplicationProviderChecksForDuplicates" id="HandshakeApplicationProviderChecksForDuplicates">Application Provider Checks For Duplicates</a>
</h1>
<p id="rfc.section.7.2.1.3.p.1">If the tenant of the Application Provider already has an established federation relationship with the tenant of the Identity Provider, as determined by examining the <samp>entity_id</samp> of both parties, the Application Provider SHOULD alert the Administrator of a duplicate registration attempt and steer the end-user toward the appropriate tooling to view or update the existing relationship.  </p>
<h1 id="rfc.section.7.2.1.4">
<a href="#rfc.section.7.2.1.4">7.2.1.4.</a> <a href="#HandshakeApplicationProviderVerifiesCompatibilityWithIdentityProvider" id="HandshakeApplicationProviderVerifiesCompatibilityWithIdentityProvider">Application Provider Verifies Compatibility with Identity Provider</a>
</h1>
<p id="rfc.section.7.2.1.4.p.1">The Application Provider MUST compare its Provider Metadata against the Identity Provider Metadata to verify compatibility, as described in <a href="#ProviderCompatibilityEvaluation" class="xref">Section 5</a>.  </p>
<p id="rfc.section.7.2.1.4.p.2">If the Providers are incompatible, the FastFed Handshake MUST be halted.  </p>
<h1 id="rfc.section.7.2.1.5">
<a href="#rfc.section.7.2.1.5">7.2.1.5.</a> <a href="#HandshakeApplicationProviderObtainsConfirmation" id="HandshakeApplicationProviderObtainsConfirmation">Application Provider Obtains Confirmation from Administrator</a>
</h1>
<p id="rfc.section.7.2.1.5.p.1">The Application Provider MUST obtain explicit confirmation from an Administrator to allow federation with the Identity Provider.  </p>
<p id="rfc.section.7.2.1.5.p.2">As a reference to implementers, confirmation could include displaying a verification page which summarizes the actions that will occur and asking the user to click a confirmation button.  </p>
<h1 id="rfc.section.7.2.1.6">
<a href="#rfc.section.7.2.1.6">7.2.1.6.</a> <a href="#HandshakeApplicationProviderWhitelistsIdentityProvider" id="HandshakeApplicationProviderWhitelistsIdentityProvider">Application Provider Whitelists the Identity Provider</a>
</h1>
<p id="rfc.section.7.2.1.6.p.1">The Application Provider whitelists that the tenant of the Identity Provider is permitted to create a federation relationship with the tenant of the Application. This whitelisting will be utilized later in the handshake when the Identity Provider calls back to the Application Provider to complete the registration.  </p>
<p id="rfc.section.7.2.1.6.p.2">The purpose of the whitelist is to defend against unauthorized callers using the FastFed Handshake flows to register themselves as a valid Identity Provider for the Application instance. In addition, the whitelist prevents legitimate callers from activating capabilities they should not be permitted to use. For example, if an Application Provider has allowed an Identity Provider to authenticate users via SAML, the Identity Provider should not be allowed to register with a different protocol such as OpenID Connect.  </p>
<p id="rfc.section.7.2.1.6.p.3">To accomplish these goals, the whitelist MUST capture the following information: </p>

<ol>
<li>
<samp>entity_id</samp> of the Identity Provider, as specified in the Identity Provider Metadata.  </li>
<li>
<samp>jwks_uri</samp> of the Identity Provider, as specified in the Identity Provider Metadata.  </li>
<li>
<samp>authentication_profiles</samp> that the Identity Provider is permitted to use, as specified in the Application Provider Metadata.  </li>
<li>
<samp>provisioning_profiles</samp> that the Identity Provider is permitted to use, as specified in the Application Provider Metadata.  </li>
<li>
<samp>expiration_date</samp> after which the whitelisting will be considered expired. If a FastFed Handshake with the whitelisted properties is never completed during the validity window, the whitelisting SHOULD expire after a reasonable amount of time. The amount of time is an implementation detail. As a reference to implementors, some enterprises require multiple parties to approve a new Application for single sign-in. These approvals may take days or weeks to acquire.  </li>
</ol>

<p> </p>
<p id="rfc.section.7.2.1.6.p.4">The only usage of the whitelist is to define the valid parameters that the Identity Provider may pass to the Application Provider in <a href="#HandshakeRegistrationRequest" class="xref">Section 7.2.3.1</a>, and which get validated in in <a href="#HandshakeRegistrationProcessing" class="xref">Section 7.2.3.2</a>. This whitelisting step MUST NOT prematurely alter the behavior of an existing federation relationship prior to the completion of the FastFed Handshake.  </p>
<p id="rfc.section.7.2.1.6.p.5">A pending whitelist is one in which the Identity Provider has not called back to complete the FastFed Handshake and activate the whitelisted capabilities. The Application Administrator MUST be allowed to cancel a pending whitelist within the Application, effectively halting the ability for the Identity Provider to call back and complete the handshake. (See <a href="#HandshakeRegistrationResponse" class="xref">Section 7.2.3.3</a> and <a href="#HandshakeRegistrationResponseHandling" class="xref">Section 7.2.3.4</a>.) After cancelling a pending whitelist in the Application Provider, the Application Provider MAY proceed with <a href="#HandshakeApplicationProviderRedirect" class="xref">Section 7.2.1.7</a> of the FastFed Handshake to redirect the Administrator to the Identity Provider, where the Administrator may cleanup any pending resources within the Identity Provider (such as an approval workflow). If this is done, the Application Provider MUST set the capabilities in the Application Provider Metadata to match the previously whitelisted capabilities (or set them to be empty if no active relationship exists yet) in order to signal that the desired end state of the FastFed Handshake is to preserve the status quo and cancel any outstanding changes.  </p>
<p id="rfc.section.7.2.1.6.p.6">The representation of the whitelist is an implementation detail.  </p>
<h1 id="rfc.section.7.2.1.7">
<a href="#rfc.section.7.2.1.7">7.2.1.7.</a> <a href="#HandshakeApplicationProviderRedirect" id="HandshakeApplicationProviderRedirect">Application Provider Sends Request to the Identity Provider</a>
</h1>
<p id="rfc.section.7.2.1.7.p.1">If the preceding steps were successful, the Application Provider responds by issuing a request to the Identity Provider containing the following parameters: </p>

<dl>
<dt>app_metadata_uri</dt>
<dd style="margin-left: 8">REQUIRED. The location of the Provider Metadata for the Application Provider.  </dd>
<dt>expiration</dt>
<dd style="margin-left: 8">OPTIONAL. The DateTime when the Application Provider will consider the whitelist to be expired and the administrator must restart the FastFed Handshake. This value is provided as a convenience to the Identity Provider so that it may be aware of the deadline for completing the flow.  </dd>
</dl>

<p> </p>
<p id="rfc.section.7.2.1.7.p.2">The request can be transmitted through the following mechanisms.  </p>
<h1 id="rfc.section.7.2.1.7.1">
<a href="#rfc.section.7.2.1.7.1">7.2.1.7.1.</a> <a href="#HandshakeApplicationProviderRedirectVia302" id="HandshakeApplicationProviderRedirectVia302">HTTP Redirect</a>
</h1>
<p id="rfc.section.7.2.1.7.1.p.1">An Application Provider MAY issue an HTTP 302 redirect to the <samp>fastfed_handshake_start_uri</samp> specified in the <a href="#IdentityProviderMetadata" class="xref">Identity Provider Metadata</a> with the request parameters encoded using <a href="#HandshakeSerialization" class="xref">Query String Serialization</a>.  </p>
<p id="rfc.section.7.2.1.7.1.p.2">The following is a non-normative example of a response (with line wraps within values for display purposes only): </p>
<pre>
 HTTP/1.1 302 Found
 Location: https://tenant-12345.idp.example.com/fastfed/handshake/start?
   app_metadata_uri=https%3A%2F%2Ftenant-67890.app.example.com%2Ffastfed%2Fprovider-metadata
   &amp;expiration=1475878357
</pre>
<h1 id="rfc.section.7.2.1.7.2">
<a href="#rfc.section.7.2.1.7.2">7.2.1.7.2.</a> <a href="#HandshakeApplicationProviderRedirectViaOtherChannel" id="HandshakeApplicationProviderRedirectViaOtherChannel">Alternative Channel</a>
</h1>
<p id="rfc.section.7.2.1.7.2.p.1">In some circumstances, the end-user who is initiating the FastFed Handshake at the Application Provider may not be a valid end-user in the Identity Provider. This could occur, for example, when one organization is inviting members of a different organization to collaborate in a shared instance of an application.  </p>
<p id="rfc.section.7.2.1.7.2.p.2">If a Provider has reason to believe that the end-user initiating the FastFed Handshake may not exist in the given Identity Provider, then the request message MAY be transmitted through alternate channels. Such channels may include, but are not limited to, email and instant messaging.  </p>
<p id="rfc.section.7.2.1.7.2.p.3">The request message is conveyed as a URL with the host value set to the <samp>fastfed_handshake_start_uri</samp> specified in the <a href="#IdentityProviderMetadata" class="xref">Identity Provider Metadata</a> and the request parameters encoded using <a href="#HandshakeSerialization" class="xref">Query String Serialization</a>.  </p>
<p id="rfc.section.7.2.1.7.2.p.4">The following is a non-normative example of a message (with line wraps within values for display purposes only): </p>
<pre>
 Hello Jane,
 Please click this link to finish setting up single sign-on with us.
 
 https://tenant-12345.idp.example.com/fastfed/handshake/start?
   app_metadata_uri=https%3A%2F%2Ftenant-67890.app.example.com%2Ffastfed%2Fprovider-metadata
   &amp;expiration=1475878357
</pre>
<h1 id="rfc.section.7.2.2">
<a href="#rfc.section.7.2.2">7.2.2.</a> <a href="#HandshakeReceiptByIdentityProvider" id="HandshakeReceiptByIdentityProvider">Handshake Receipt by Identity Provider</a>
</h1>
<h1 id="rfc.section.7.2.2.1">
<a href="#rfc.section.7.2.2.1">7.2.2.1.</a> <a href="#HandshakeIdentityProviderAuthenticatesAdministrator" id="HandshakeIdentityProviderAuthenticatesAdministrator">Identity Provider Authenticates Administrator</a>
</h1>
<p id="rfc.section.7.2.2.1.p.1">Upon receiving a handshake message from the Application Provider as specified in Step <a href="#HandshakeApplicationProviderRedirect" class="xref">7.2.1.7</a>, the Identity Provider MUST authenticate the end-user and verify they are authorized to initiate a federation relationship with the Application Provider.  </p>
<p id="rfc.section.7.2.2.1.p.2">If the end-user cannot be authenticated, the FastFed Handshake MUST be halted.  </p>
<p id="rfc.section.7.2.2.1.p.3">If the end-user is authenticated but not permitted to complete the registration process, an Identity Provider MAY pause the handshake flow at any point beyond this step, capture the registration information for approval by a different Administrator, and thereafter finish the remaining steps of the FastFed handshake.  </p>
<h1 id="rfc.section.7.2.2.2">
<a href="#rfc.section.7.2.2.2">7.2.2.2.</a> <a href="#HandshakeIdentityProviderReadsProviderMetadata" id="HandshakeIdentityProviderReadsProviderMetadata">Identity Provider Reads Application Provider Metadata</a>
</h1>
<p id="rfc.section.7.2.2.2.p.1">Using the <samp>app_metadata_uri</samp> sent as a parameter in the handshake request, the Identity Provider queries the <a href="#ProviderMetadataEndpoint" class="xref">Application Provider Metadata Endpoint</a>.  </p>
<p id="rfc.section.7.2.2.2.p.2">If the Application Provider Metadata cannot be downloaded or is missing required elements, the FastFed Handshake must be halted.  </p>
<h1 id="rfc.section.7.2.2.3">
<a href="#rfc.section.7.2.2.3">7.2.2.3.</a> <a href="#HandshakeIdentityProviderVerifiesCompatibility" id="HandshakeIdentityProviderVerifiesCompatibility">Identity Provider Verifies Compatibility</a>
</h1>
<p id="rfc.section.7.2.2.3.p.1">The Identity Provider MUST compare its Provider Metadata against the Application Provider Metadata in order to verify compatibility, as described in <a href="#ProviderCompatibilityEvaluation" class="xref">Section 5</a>.  </p>
<p id="rfc.section.7.2.2.3.p.2">If the Providers are incompatible, the FastFed Handshake MUST be halted. During update scenarios (<a href="#HandshakeIdentityProviderAppliesDuplicateDetection" class="xref">Section 7.2.2.4</a>), the messaging to the Administrator SHOULD explain that the incompatibility applies only to the update request and that the existing federation relationship remains valid and unchanged.  </p>
<p id="rfc.section.7.2.2.3.p.3">It is possible that both Providers may share a list of capabilities, such as supporting both SAML and OpenID Connect for single sign-on. If multiple options are valid, the Identity Provider MUST choose the options to use. To make a choice, the Identity Provider MAY ask the Administrator to select or MAY automatically choose based on default preferences of the Provider.  </p>
<h1 id="rfc.section.7.2.2.4">
<a href="#rfc.section.7.2.2.4">7.2.2.4.</a> <a href="#HandshakeIdentityProviderAppliesDuplicateDetection" id="HandshakeIdentityProviderAppliesDuplicateDetection">Identity Provider Checks For Duplicates and Updates</a>
</h1>
<p id="rfc.section.7.2.2.4.p.1">If there already exists an active or pending federation relationship between the tenant of the Identity Provider and the tenant of the Application Provider, as determined by examining the <samp>entity_id</samp> of both parties, the handshake request is either a duplicate or an update of an existing relationship.  </p>
<p id="rfc.section.7.2.2.4.p.2">In either scenario, the Identity Provider MUST inform the Administrator that an existing federation relationship exists and SHOULD provide explanatory context about the state of the relationship, such as whether it is active or pending approval.  </p>
<p id="rfc.section.7.2.2.4.p.3">If another FastFed Handshake is in-process, such as a prior request that is pending approval within the Identity Provider, the Identity Provider SHOULD allow the Administrator to view, cancel, replace, and/or amend the outstanding request. The implementation of approval workflows and other scenarios that can result in a pending relationship are outside the scope of the FastFed specification. As a reference to implementors, the Identity Provider should avoid having multiple FastFed Handshakes in-process for a single federation relationship, as the Application Provider only maintains a single whitelist of allowed capabilities (potentially making older stale handshakes impossible to complete), as well as the usability concerns of having multiple approval requests for a single federation relationship.  </p>
<p id="rfc.section.7.2.2.4.p.4">The determination of whether a FastFed Handshake may result in an update to an existing federation relationship is accomplished by examining the <samp>capabilities</samp> returned in the Application Provider Metadata and comparing the following attributes against existing settings: </p>

<ul>
<li>
<samp>authentication_profiles</samp> </li>
<li>
<samp>provisioning_profiles</samp> </li>
</ul>

<p> </p>
<p id="rfc.section.7.2.2.4.p.5">If new values exist in the capabilities that don't exist in the current configuration, the Administrator SHOULD be given the choice to add or update to the new value. For example, if SCIM provisioning is not currently enabled, but the capabilities now include SCIM provisioning, the Administrator can choose to enable it.  </p>
<p id="rfc.section.7.2.2.4.p.6">If values are missing from the capabilities that were previously configured, then completion of the FastFed handshake MUST result in disabling the capability. For example, if SCIM provisioning was previously enabled, but the new capabilities don't include SCIM provisioning, then execution of the FastFed Handshake will result in SCIM being disabled.  </p>
<p id="rfc.section.7.2.2.4.p.7">Both scenarios can be combined to perform an update. For example, if the federation relationship was previously configured to use SAML for user authentication, but the new capabilities only include an alternative protocol such as OpenID Connect, then the result of completing the FastFed Handshake would be to disable SAML and enable OpenID Connect as the user authentication method.  </p>
<p id="rfc.section.7.2.2.4.p.8">If any capabilities can be enabled or disabled, the Administrator MUST be given the option to proceed with updating the existing federation relationship. The Administrator MUST be informed how proceeding will cause the relationship to be altered.  </p>
<p id="rfc.section.7.2.2.4.p.9">If no capabilities are changing, the Administrator SHOULD be given the opportunity to proceed and re-execute the FastFed Handshake with the same configuration. This can be necessary, for example, if the Administrator accidentally deleted their settings in the Application Provider and seeks to re-execute the Handshake in order to restore the configuration.  </p>
<p id="rfc.section.7.2.2.4.p.10">The subsequent message flows in the FastFed Handshake remain the same for all scenarios.  </p>
<h1 id="rfc.section.7.2.2.5">
<a href="#rfc.section.7.2.2.5">7.2.2.5.</a> <a href="#HandshakeIdentityProviderObtainsConfirmation" id="HandshakeIdentityProviderObtainsConfirmation">Identity Provider Obtains Confirmation from Administrator</a>
</h1>
<p id="rfc.section.7.2.2.5.p.1">The Identity Provider MUST obtain explicit confirmation from an Administrator to create or update the federation relationship with the Application Provider.  </p>
<p id="rfc.section.7.2.2.5.p.2">As a reference to implementers, confirmation could include displaying a verification page which summarizes the actions that will occur and asking the user to click a confirmation button.  </p>
<h1 id="rfc.section.7.2.3">
<a href="#rfc.section.7.2.3">7.2.3.</a> <a href="#HandshakeRegistration" id="HandshakeRegistration">Handshake Registration</a>
</h1>
<p id="rfc.section.7.2.3.p.1">The registration phase of the handshake is the point at which Providers exchange information necessary to activate an authentication and provisioning relationship. For example, if the Identity Provider has chosen to use the SAML and SCIM protocols, this is the point at which SAML metadata files will be exchanged and SCIM endpoints and authentication credentials established.  </p>
<h1 id="rfc.section.7.2.3.1">
<a href="#rfc.section.7.2.3.1">7.2.3.1.</a> <a href="#HandshakeRegistrationRequest" id="HandshakeRegistrationRequest">Identity Provider Sends Registration Request</a>
</h1>
<p id="rfc.section.7.2.3.1.p.1">The Identity Provider MUST choose the set of capabilities to be activated and enabled, based upon the mutually supported capabilities between the Providers. The choice may include all the mutually supported capabilities, or a subset.  The Identity Provider conveys its choices in the registration request by populating the contents of the message with the capabilities that it seeks to enable. Unspecified capabilities will not be enabled.  The Identity Provider registers with the Application Provider by issuing an HTTP POST to the <samp>fastfed_handshake_register_uri</samp> specified within the <a href="#ApplicationProviderMetadata" class="xref">Application Provider Metadata</a> with the following properties:.  </p>

<ul>
<li>HTTP <samp>Content-Type</samp> MUST be <samp>application/jwt</samp> </li>
<li>The content of the HTTP POST MUST be a JWT that has been encoded using JWS Compact Serialization <a href="#RFC7519" class="xref">[RFC7519]</a> as specified in <a href="#ProviderAuthenticationMethodsJWT" class="xref">Section 6.4</a>.  </li>
</ul>

<p> </p>
<p id="rfc.section.7.2.3.1.p.2">In addition to the required attributes specified in <a href="#ProviderAuthenticationMethodsJWT" class="xref">Section 6.4</a>, the JWT includes the following additional attributes: </p>

<dl>
<dt>authentication_profiles</dt>
<dd style="margin-left: 8">OPTIONAL. A list containing the authentication protocols to be enabled for sign-in between the Identity Provider and the Application Provider, chosen from the list of compatible <samp>authentication_profiles</samp> defined in the <a href="#ProviderMetadataCapabilities" class="xref">Provider Capabilities</a>.  </dd>
<dt>provisioning_profiles</dt>
<dd style="margin-left: 8">OPTIONAL. A list containing the user provisioning profiles to be enabled by the Identity Provider and Application Provider, chosen from the list of compatible <samp>provisioning_profiles</samp> defined in the <a href="#ProviderMetadataCapabilities" class="xref">Provider Capabilities</a>.  </dd>
</dl>

<p> </p>
<p id="rfc.section.7.2.3.1.p.3">Specific authentication or provisioning profiles MAY extend the set of attributes in the JWT with additional values necessary for the chosen protocol. These extensions are defined elsewhere within the profile specifications. See <a href="#FastFedProfile.EnterpriseSAML" class="xref">[FastFedProfile.EnterpriseSAML]</a> and <a href="#FastFedProfile.EnterpriseSCIM" class="xref">[FastFedProfile.EnterpriseSCIM]</a>.  </p>
<p id="rfc.section.7.2.3.1.p.4">For example, the following is a non-normative example of the contents of a registration message prior to serialization, with protocol-specific values for the Enterprise SAML and Enterprise SCIM profiles: </p>
<pre>
 {
   "iss": "https://tenant-12345.idp.example.com",
   "aud": "https://tenant-67890.app.example.com",
   "exp": 1234567890,
   "authentication_profiles": ["urn:ietf:params:fastfed:1.0:authentication:saml:2.0:enterprise"],
   "provisioning_profiles": ["urn:ietf:params:fastfed:1.0:provisioning:scim:2.0:enterprise"],
   "urn:ietf:params:fastfed:1.0:authentication:saml:2.0:enterprise": {
     "saml_metadata_uri": "https://tenant-12345.idp.example.com/saml-metadata.xml",
   },
   "urn:ietf:params:fastfed:1.0:provisioning:scim:2.0:enterprise": {
     "provider_contact_information": {
       "organization": "Example Inc.",
       "phone": "+1-800-555-6666",
       "email": "provisioning@example.com"
     },
     "provider_authentication_methods": {
       "urn:ietf:params:fastfed:1.0:provider_authentication:oauth:2.0:jwt_profile": {
         "jwks_uri": "https://provisioning.example.com/keys"
       }
     }
   }
 }
</pre>
<p id="rfc.section.7.2.3.1.p.5">The following is a non-normative example of a POST after JWS serialization: </p>
<pre>
POST /fastfed/register
 Host: tenant-67890.app.example.com 
 Content-Type: application/jwt

eyJhbGciOiJSUzI1NiIsImtpZCI6IjIyIn0[... omitted for brevity...]

</pre>
<h1 id="rfc.section.7.2.3.2">
<a href="#rfc.section.7.2.3.2">7.2.3.2.</a> <a href="#HandshakeRegistrationProcessing" id="HandshakeRegistrationProcessing">Application Provider Handles Registration Request</a>
</h1>
<p id="rfc.section.7.2.3.2.p.1">Upon receiving the registration request from the Identity Provider, the Application Provider MUST perform the following verification steps: </p>

<ol>
<li>Verify the <samp>aud</samp> attribute matches the <samp>entity_id</samp> of a tenant in the Application Provider.  </li>
<li>Verify the <samp>iss</samp> attribute matches a whitelisted <samp>entity_id</samp> for the tenant of the Application Provider, as captured in <a href="#HandshakeApplicationProviderWhitelistsIdentityProvider" class="xref">Section 7.2.1.6</a>.  </li>
<li>Verify the <samp>exp</samp> DateTime in the JWT is prior to current DateTime.  </li>
<li>Verify the <samp>kid</samp> matches an entry in the key set hosted at the whitelisted <samp>jwks_uri</samp> captured in <a href="#HandshakeApplicationProviderWhitelistsIdentityProvider" class="xref">Section 7.2.1.6</a>.  </li>
<li>Verify the JWT signature using the key from the key set. The signing algorithm for the <samp>kid</samp> in the key set MUST match the signing algorithm in the JWT.  </li>
<li>If an expiration date exists on the whitelist (<a href="#HandshakeApplicationProviderWhitelistsIdentityProvider" class="xref">Section 7.2.1.6</a>), verify the expiration date has not been exceeded.  </li>
<li>Verify the values of <samp>authentication_profiles</samp> and <samp>provisioning_profiles</samp> against the whitelisted capabilities captured in <a href="#HandshakeApplicationProviderWhitelistsIdentityProvider" class="xref">Section 7.2.1.6</a>. The request MUST be treated as invalid if any of the following conditions are true: <ul>
<li>The Identity Provider includes a value in the list of <samp>authentication_profiles</samp> or <samp>provisioning_profiles</samp> that does not exist in the Application Provider whitelist.  </li>
<li>The Identity Provider fails to include at least one value in <samp>authentication_profiles</samp> when the Application Provider whitelist contains one or more values for <samp>authentication_profiles</samp>.  </li>
<li>The Identity Provider fails to include at least one value in <samp>provisioning_profiles</samp> when the Application Provider whitelist contains one or more values for <samp>authentication_profiles</samp>.  </li>
</ul>
<p> </p>
</li>
</ol>

<p> </p>
<p id="rfc.section.7.2.3.2.p.2">If verification succeeds, the Application Provider MUST capture the configuration information and initiate any actions necessary to activate or update the federation relationship to reflect the desired <samp>authentication_profiles</samp> and <samp>provisioning_profiles</samp> indicated in the registration request. These actions are defined in the FastFed Profile for each profile.  </p>
<p id="rfc.section.7.2.3.2.p.3">For example, if SCIM provisioning was enabled, one of the actions may include activating the SCIM endpoint and registering the Identity Provider as an authorized client. This is an implementation detail outside the scope of the specification.  </p>
<p id="rfc.section.7.2.3.2.p.4">If the registration request applies to an existing federation relationship, it can result in capabilities being added or removed. For example, if a federation relationship previously used SCIM provisioning, but the new registration request contains an empty value for <samp>provisioning_profile</samp>, then the existing SCIM capabilities will be disabled to reflect the new settings.  </p>
<p id="rfc.section.7.2.3.2.p.5">After processing the registration request, the expiration date MUST be removed from the whitelisting entry.  </p>
<p id="rfc.section.7.2.3.2.p.6">Due to transient failures and retry scenarios, it is possible that an Identity Provider may send duplicate registration requests. The Application Provider MUST preserve enough whitelist context to provide an idempotent response to duplicate requests.  If a duplicate request is still valid when compared against the current whitelist, the Application Provider MUST return the same response contents as in the original response, as specified in <a href="#HandshakeRegistrationResponse" class="xref">Section 7.2.3.3</a>.  </p>
<p id="rfc.section.7.2.3.2.p.7">The implementation of the whitelist is outside the scope of the specification.  As a reference to implementors, it may be beneficial to capture contextual information such as the status of the whitelisting entry (pending, active) and the date when the registration was completed to assist with auditing and debugging.  </p>
<h1 id="rfc.section.7.2.3.3">
<a href="#rfc.section.7.2.3.3">7.2.3.3.</a> <a href="#HandshakeRegistrationResponse" id="HandshakeRegistrationResponse">Application Provider Sends Registration Response</a>
</h1>
<p id="rfc.section.7.2.3.3.p.1">If the registration failed because of a validation failure, the Application Provider MUST respond with an HTTP 401 status code and content type text/plain. The response body MUST either be empty or contain a textual error message which may assist the Identity Provider with diagnostics.  </p>
<p id="rfc.section.7.2.3.3.p.2">If the registration is successful, the Application Provider MUST respond with an HTTP 200 status code and return a JSON document <a href="#RFC4627" class="xref">[RFC4627]</a> using the <samp>application/json</samp> content type.  </p>
<p id="rfc.section.7.2.3.3.p.3">The JSON document contains the following attributes: </p>

<dl>
<dt>fastfed_handshake_finalize_uri</dt>
<dd style="margin-left: 8">OPTIONAL. URL that the Identity Provider will invoke to signal to the Application Provider that the registration response was successfully received, all information has been captured and stored by the Identity Provider, and the federation relationship may be considered established. See <a href="#HandshakeFinalization" class="xref">Section 7.2.4</a> for details.  </dd>
</dl>

<p> </p>
<p id="rfc.section.7.2.3.3.p.4">FastFed Profiles may extend the response with protocol-specific values. For example, the use of the <a href="#FastFedProfile.EnterpriseSCIM" class="xref">SCIM Provisioning</a> profile will result in the location of the SCIM endpoint being included in the response.  </p>
<p id="rfc.section.7.2.3.3.p.5">If the Identity Provider does not receive an HTTP 200 or 401 status code, it MUST periodically retry the request until a successful response is received or 48 hours has elapsed, whichever comes first.  </p>
<p id="rfc.section.7.2.3.3.p.6">Retry logic is outside the scope of this specification. As a reference to implementors, a potential retry strategy could include retrying on an hourly basis until 48 hours has elapsed. Alternatively, an exponential backoff strategy may be applied to retry more frequently at the beginning and slowly backoff.  </p>
<p id="rfc.section.7.2.3.3.p.7">The following is a non-normative example of a successful response for a Provider who has chosen to use the Enterprise SAML and Enterprise SCIM profiles.  </p>
<pre>

 HTTP/1.1 200 OK
 Content-Type: application/json
 Cache-Control: no-store
 Pragma: no-cache

 {  
   "fastfed_handshake_finalize_uri": "https://tenant-67890.app.example.com/fastfed/finalize",
   "urn:ietf:params:fastfed:1.0:authentication:saml:2.0:enterprise": {
     "saml_metadata_uri": "https://tenant-67890.app.example.com/saml-metadata.xml"
   },
   "urn:ietf:params:fastfed:1.0:provisioning:scim:2.0:enterprise": {
     "scim_service_uri": "https://tenant-67890.app.example.com/scim",
     "provider_authentication_methods": "urn:ietf:params:fastfed:1.0:provider_authentication:oauth:2.0:jwt_profile",
     "urn:ietf:params:fastfed:1.0:provider_authentication:oauth:2.0:jwt_profile":
     {
       "token_endpoint": "https://tenant-67890.app.example.com/oauth",
       "scope": "scim"
     }
   }
 }
</pre>
<h1 id="rfc.section.7.2.3.4">
<a href="#rfc.section.7.2.3.4">7.2.3.4.</a> <a href="#HandshakeRegistrationResponseHandling" id="HandshakeRegistrationResponseHandling">Identity Provider Handles Registration Response</a>
</h1>
<p id="rfc.section.7.2.3.4.p.1">Upon receiving a successful registration response from the Application Provider, the Identity Provider MUST capture the configuration information and initiate any actions necessary to activate the federation relationship for the specific <samp>authentication_profile</samp> and <samp>provisioning_profile</samp> indicated in the registration request.  </p>
<h1 id="rfc.section.7.2.4">
<a href="#rfc.section.7.2.4">7.2.4.</a> <a href="#HandshakeFinalization" id="HandshakeFinalization">Handshake Finalization</a>
</h1>
<p id="rfc.section.7.2.4.p.1">Handshake Finalization is an optional step of the FastFed Handshake. It signals when each provider has completed the work necessary to setup the authentication and provisioning mechanisms and is ready to handle user traffic.  </p>
<p id="rfc.section.7.2.4.p.2">Handshake Finalization occurs if the registration response from the Application Provider includes a value for <samp>fastfed_handshake_finalize_uri</samp> (<a href="#HandshakeRegistrationResponse" class="xref">Section 7.2.3.3</a>), </p>
<p id="rfc.section.7.2.4.p.3">As a reference to implementors, an Application Provider may use this information to inform the Application Administrator that a registration is complete so that follow-up actions may occur. Example actions could include sending proactive guidance to the Administrator to test the configuration, or providing instructions for how to disable any password-based authentication in favor of using the newly established single sign-on capabilities through the Identity Provider.  </p>
<p id="rfc.section.7.2.4.p.4">Finalization can be skipped if the Application Provider does not need to be informed when the Identity Provider has successfully finished handling the registration response.  </p>
<h1 id="rfc.section.7.2.4.1">
<a href="#rfc.section.7.2.4.1">7.2.4.1.</a> <a href="#HandshakeFinalizationIdentityProviderRequest" id="HandshakeFinalizationIdentityProviderRequest">Identity Provider Sends Finalization Request</a>
</h1>
<p id="rfc.section.7.2.4.1.p.1">If the registration response from the Application Provider includes a value for <samp>fastfed_handshake_finalize_uri</samp> (<a href="#HandshakeRegistrationResponse" class="xref">Section 7.2.3.3</a>), the Identity Provider MUST invoke the finalization endpoint after the following criteria are met: </p>

<ol>
<li>If an authentication protocol was negotiated during the FastFed Handshake, the Identity Provider is ready to handle sign-in requests using the selected protocol.  </li>
<li>If a provisioning profile was negotiated during the FastFed Handshake, the Identity Provider is ready to handle provisioning activity using the selected protocol.  </li>
</ol>

<p> </p>
<p id="rfc.section.7.2.4.1.p.2">The Identity Provider invokes the endpoint by sending an HTTP POST to the <samp>fastfed_handshake_finalize_uri</samp> with the following properties: </p>

<ul>
<li>HTTP <samp>Content-Type</samp> MUST be <samp>application/jwt</samp> </li>
<li>The content of the HTTP POST MUST be a JWT that has been encoded using JWS Compact Serialization <a href="#RFC7519" class="xref">[RFC7519]</a> as specified in <a href="#ProviderAuthenticationMethodsJWT" class="xref">Section 6.4</a>.  </li>
</ul>

<p> </p>
<p id="rfc.section.7.2.4.1.p.3">The following is a non-normative example of the contents of a finalization message prior to serialization: </p>
<pre>
 {
   "iss": "https://tenant-12345.idp.example.com",
   "aud": "https://tenant-67890.app.example.com",
   "exp": 1234567890
 }
</pre>
<p id="rfc.section.7.2.4.1.p.4">The following is a non-normative example of a POST after JWS serialization: </p>
<pre>
POST /fastfed/finalize
 Host: tenant-67890.app.example.com 
 Content-Type: application/jwt

eyJhbGciOiJSUzI1NiIsImtpZCI6IjIyIn0[... omitted for brevity...]

</pre>
<h1 id="rfc.section.7.2.4.2">
<a href="#rfc.section.7.2.4.2">7.2.4.2.</a> <a href="#HandshakeFinalizationApplicationProviderHandlesRequest" id="HandshakeFinalizationApplicationProviderHandlesRequest">Application Provider Handles Finalization Request</a>
</h1>
<p id="rfc.section.7.2.4.2.p.1">Upon receiving the finalization request from the Identity Provider, the Application Provider MUST perform the following verification steps: </p>

<ol>
<li>Verify the <samp>aud</samp> attribute matches the <samp>entity_id</samp> of a tenant in the Application Provider.  </li>
<li>Verify the <samp>iss</samp> attribute matches the <samp>entity_id</samp> of a federation partner for the tenant of the Application Provider, as established in <a href="#HandshakeRegistrationProcessing" class="xref">Section 7.2.3.2</a>.  </li>
<li>Verify the <samp>exp</samp> DateTime in the JWT is prior to current DateTime.  </li>
<li>Verify the <samp>kid</samp> matches an entry in the whitelisted key set hosted at the <samp>jwks_uri</samp> captured in <a href="#HandshakeApplicationProviderWhitelistsIdentityProvider" class="xref">Section 7.2.1.6</a>.  </li>
<li>Verify the JWT signature using the key from the key set. The signing algorithm for the <samp>kid</samp> in the key set MUST match the signing algorithm in the JWT.  </li>
</ol>

<p> </p>
<p id="rfc.section.7.2.4.2.p.2">If validation is successful, the Application Provider may initiate any actions that result from a finalized handshake. This is an implementation detail outside the scope of the specification.  </p>
<h1 id="rfc.section.7.2.4.3">
<a href="#rfc.section.7.2.4.3">7.2.4.3.</a> <a href="#HandshakeFinalizationApplicationProviderSendsResponse" id="HandshakeFinalizationApplicationProviderSendsResponse">Application Provider Sends Finalization Response</a>
</h1>
<p id="rfc.section.7.2.4.3.p.1">If the request validation fails, the Application Provider MUST respond with an HTTP 401 status code and content type text/plain. The response body MUST either be empty or contain a textual error message which may assist the Identity Provider with diagnostics.  </p>
<p id="rfc.section.7.2.4.3.p.2">Otherwise, if validation succeeds, the Application Provider MUST respond with an HTTP 200 OK status code and empty message contents if the following criteria are met: </p>

<ol>
<li>If an authentication protocol was negotiated during the FastFed Handshake, the Application Provider is ready to handle sign-in requests using the selected protocol.  </li>
<li>If a provisioning profile was negotiated during the FastFed Handshake, the Application Provider is ready to handle provisioning activity using the selected protocol.  </li>
</ol>

<p> </p>
<p id="rfc.section.7.2.4.3.p.3">If these criteria are NOT met, the Application Provider MUST respond with an HTTP 202 Accepted status and empty message content.  </p>
<h1 id="rfc.section.7.2.4.4">
<a href="#rfc.section.7.2.4.4">7.2.4.4.</a> <a href="#HandshakeFinalizationIdentityProviderHandlesResponse" id="HandshakeFinalizationIdentityProviderHandlesResponse">Identity Provider Handles Finalization Response</a>
</h1>
<p id="rfc.section.7.2.4.4.p.1">If the Identity Provider receives an HTTP 200 response code from the Application Provider, the Identity Provider may initiate any actions that result from a finalized handshake. This is an implementation detail outside the scope of the specification.  </p>
<p id="rfc.section.7.2.4.4.p.2">If the Identity Provider does not receive an HTTP 200 or HTTP 401 response from the Application Provider, it MUST periodically retry the request until a successful HTTP 200 response is received or 48 hours has elapsed, whichever comes first.  </p>
<p id="rfc.section.7.2.4.4.p.3">Retry logic is outside the scope of this specification. As a reference to implementors, a potential retry strategy could include retrying on an hourly basis until 48 hours has elapsed. Alternatively, an exponential backoff strategy may be applied to retry more frequently at the beginning and slowly backoff.  </p>
<h1 id="rfc.section.8">
<a href="#rfc.section.8">8.</a> <a href="#Security" id="Security">Security Considerations</a>
</h1>
<p id="rfc.section.8.p.1">The primary risk of FastFed is the creation of an undesired identity federation relationship.  </p>
<p id="rfc.section.8.p.2">For example, if a malicious actor were to succeed in having their Identity Provider approved for single sign-on to an application owned by another party, it can allow the malicious actor to access the application.  </p>
<p id="rfc.section.8.p.3">Similarly, if a malicious application were to succeed in being approved for use by members of an organization, this can have several impacts. First, by receiving user provisioning messages, the malicious application may gain access to information about members of the organization. Second, by observing user activity in the application, it may extract additional information from end-users. Finally, if the malicious application were to impersonate (or man-in-the-middle) another application that end-users recognize, the malicious actor may gain visibility into user activity for the impersonated application.  </p>
<p id="rfc.section.8.p.4">To protect against this, mitigations can be grouped into the three categories: </p>

<ol>
<li>Strongly authenticate Administrators such that an unauthorized party may not create a federation relationship.  </li>
<li>Protect legitimate administrators from unintended approvals of a federation relationship through silent vectors, such as CSRF.  </li>
<li>Help legitimate administrators understand whether an application is trustworthy before choosing to approve it.  </li>
</ol>

<p> </p>
<p id="rfc.section.8.p.5">These mitigations are described below.  </p>
<h1 id="rfc.section.8.1">
<a href="#rfc.section.8.1">8.1.</a> <a href="#SecurityStrongAuthn" id="SecurityStrongAuthn">Strong Authentication of Administrators</a>
</h1>
<p id="rfc.section.8.1.p.1">When authenticating Administrators, Providers are encouraged to consider stronger authentication means than password. Providers MUST ensure confidentiality of passwords and other Administrator credentials.  </p>
<h1 id="rfc.section.8.2">
<a href="#rfc.section.8.2">8.2.</a> <a href="#SecurityUnintendedApprovals" id="SecurityUnintendedApprovals">Protection from Unintended Approvals</a>
</h1>
<p id="rfc.section.8.2.p.1">As per <a href="#HandshakeApplicationProviderObtainsConfirmation" class="xref">Section 7.2.1.5</a> and <a href="#HandshakeIdentityProviderObtainsConfirmation" class="xref">Section 7.2.2.5</a>, both the Application Provider and Identity Provider MUST receive positive acknowledgement (such as via a button click) that the Administrator wishes to proceed with the action.  </p>
<p id="rfc.section.8.2.p.2">In addition, Providers MUST implement all known best practices for protection of web applications and APIs including defenses against CSRF, XSS, and code injection.  </p>
<p id="rfc.section.8.2.p.3">Depending on the sensitivity of the application or organization, Providers may also consider additional defenses such as quorum approval processes, Test of User Presence <a href="#W3C.WebAuthn" class="xref">[W3C.WebAuthn]</a>, or change notifications.  </p>
<h1 id="rfc.section.8.3">
<a href="#rfc.section.8.3">8.3.</a> <a href="#SecurityAppTrust" id="SecurityAppTrust">Evaluating Trustworthiness of Applications</a>
</h1>
<p id="rfc.section.8.3.p.1">Providers are uniquely identified via the <samp>provider_domain</samp> attribute in the <a href="#CommonProviderMetadata" class="xref">Provider Metadata</a>. Domain names MUST be validated as per <a href="#ProviderMetadataEndpointValidation" class="xref">Section 4.1.1</a>.  </p>
<p id="rfc.section.8.3.p.2">The validation process relies on TLS certificate checks to verify the entity has demonstrated control of the domain. Validators MUST perform a TLS/SSL server identity check, per <a href="#RFC6125" class="xref">[RFC6125]</a>.  Implementation security considerations for TLS can be found in <a href="#RFC7525" class="xref">[RFC7525]</a>.  </p>
<p id="rfc.section.8.3.p.3">Failure to validate the TLS certificate and the <samp>provider_domain</samp> can allow impersonation of a Provider.  </p>
<p id="rfc.section.8.3.p.4">Using the <samp>provider_domain</samp> as a unique and validated identifier, Identity Providers MAY build lists of Providers and assign them varying levels of trust. These implementation details are outside the scope of this specification. As a reference to implementors, an Identity Provider may create and use a whitelist of highly trusted Application Providers. Identity Providers MAY also utilize blacklists of known malware domains, phishing sites, or similar risk signals. The risk categorizations MAY be used to vary the customer experience, such as by displaying additional warnings or requiring additional approvals for riskier scenarios. Other considerations may include comparing the Display Settings (<a href="#DisplaySettings" class="xref">Section 3.3.2</a>) of an unrecognized application with those of whitelisted Providers to detect possible impersonation attempts.  </p>
<h1 id="rfc.section.9">
<a href="#rfc.section.9">9.</a> <a href="#IANA" id="IANA">IANA Considerations</a>
</h1>
<p id="rfc.section.9.p.1">Pending </p>
<h1 id="rfc.references">
<a href="#rfc.references">10.</a> Normative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="FastFedProfile.EnterpriseSAML">[FastFedProfile.EnterpriseSAML]</b></td>
<td class="top">
<a title="Amazon">McAdams, K.</a>, "<a href="http://openid.net/specs/fastfed-saml-1_0.html">FastFed Enterprise SAML Profile 1.0</a>", October 2020.</td>
</tr>
<tr>
<td class="reference"><b id="FastFedProfile.EnterpriseSCIM">[FastFedProfile.EnterpriseSCIM]</b></td>
<td class="top">
<a title="Amazon">McAdams, K.</a>, "<a href="http://openid.net/specs/fastfed-scim-1_0.html">FastFed Enterprise SCIM Profile 1.0</a>", October 2020.</td>
</tr>
<tr>
<td class="reference"><b id="OpenID.Registration">[OpenID.Registration]</b></td>
<td class="top">
<a title="Nomura Research Institute, Ltd.">Sakimura, N.</a>, <a title="Ping Identity">Bradley, J.</a> and <a title="Microsoft">M. Jones</a>, "<a href="http://openid.net/specs/openid-connect-registration-1_0.html">OpenID Connect Dynamic Client Registration 1.0</a>", November 2014.</td>
</tr>
<tr>
<td class="reference"><b id="POSIX.1">[POSIX.1]</b></td>
<td class="top">
<a title="IEEE Std 1003.1, 2018 Edition">IEEE</a>, "<a href="http://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap04.html#tag_04_16">The Open Group Base Specifications Issue 7</a>", 2018.</td>
</tr>
<tr>
<td class="reference"><b id="RFC1034">[RFC1034]</b></td>
<td class="top">
<a>Mockapetris, P.</a>, "<a href="https://tools.ietf.org/html/rfc1034">Domain names - concepts and facilities</a>", STD 13, RFC 1034, DOI 10.17487/RFC1034, November 1987.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2119">[RFC2119]</b></td>
<td class="top">
<a>Bradner, S.</a>, "<a href="https://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, DOI 10.17487/RFC2119, March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2616">[RFC2616]</b></td>
<td class="top">
<a>Fielding, R.</a>, <a>Gettys, J.</a>, <a>Mogul, J.</a>, <a>Frystyk, H.</a>, <a>Masinter, L.</a>, <a>Leach, P.</a> and <a>T. Berners-Lee</a>, "<a href="https://tools.ietf.org/html/rfc2616">Hypertext Transfer Protocol -- HTTP/1.1</a>", RFC 2616, DOI 10.17487/RFC2616, June 1999.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3966">[RFC3966]</b></td>
<td class="top">
<a>Schulzrinne, H.</a>, "<a href="https://tools.ietf.org/html/rfc3966">The tel URI for Telephone Numbers</a>", RFC 3966, DOI 10.17487/RFC3966, December 2004.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3986">[RFC3986]</b></td>
<td class="top">
<a>Berners-Lee, T.</a>, <a>Fielding, R.</a> and <a>L. Masinter</a>, "<a href="https://tools.ietf.org/html/rfc3986">Uniform Resource Identifier (URI): Generic Syntax</a>", STD 66, RFC 3986, DOI 10.17487/RFC3986, January 2005.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4627">[RFC4627]</b></td>
<td class="top">
<a>Crockford, D.</a>, "<a href="https://tools.ietf.org/html/rfc4627">The application/json Media Type for JavaScript Object Notation (JSON)</a>", RFC 4627, DOI 10.17487/RFC4627, July 2006.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5321">[RFC5321]</b></td>
<td class="top">
<a>Klensin, J.</a>, "<a href="https://tools.ietf.org/html/rfc5321">Simple Mail Transfer Protocol</a>", RFC 5321, DOI 10.17487/RFC5321, October 2008.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5646">[RFC5646]</b></td>
<td class="top">
<a>Phillips, A.</a> and <a>M. Davis</a>, "<a href="https://tools.ietf.org/html/rfc5646">Tags for Identifying Languages</a>", BCP 47, RFC 5646, DOI 10.17487/RFC5646, September 2009.</td>
</tr>
<tr>
<td class="reference"><b id="RFC6125">[RFC6125]</b></td>
<td class="top">
<a>Saint-Andre, P.</a> and <a>J. Hodges</a>, "<a href="https://tools.ietf.org/html/rfc6125">Representation and Verification of Domain-Based Application Service Identity within Internet Public Key Infrastructure Using X.509 (PKIX) Certificates in the Context of Transport Layer Security (TLS)</a>", RFC 6125, DOI 10.17487/RFC6125, March 2011.</td>
</tr>
<tr>
<td class="reference"><b id="RFC7033">[RFC7033]</b></td>
<td class="top">
<a>Jones, P.</a>, <a>Salgueiro, G.</a>, <a>Jones, M.</a> and <a>J. Smarr</a>, "<a href="https://tools.ietf.org/html/rfc7033">WebFinger</a>", RFC 7033, DOI 10.17487/RFC7033, September 2013.</td>
</tr>
<tr>
<td class="reference"><b id="RFC7515">[RFC7515]</b></td>
<td class="top">
<a>Jones, M.</a>, <a>Bradley, J.</a> and <a>N. Sakimura</a>, "<a href="https://tools.ietf.org/html/rfc7515">JSON Web Signature (JWS)</a>", RFC 7515, DOI 10.17487/RFC7515, May 2015.</td>
</tr>
<tr>
<td class="reference"><b id="RFC7517">[RFC7517]</b></td>
<td class="top">
<a>Jones, M.</a>, "<a href="https://tools.ietf.org/html/rfc7517">JSON Web Key (JWK)</a>", RFC 7517, DOI 10.17487/RFC7517, May 2015.</td>
</tr>
<tr>
<td class="reference"><b id="RFC7518">[RFC7518]</b></td>
<td class="top">
<a>Jones, M.</a>, "<a href="https://tools.ietf.org/html/rfc7518">JSON Web Algorithms (JWA)</a>", RFC 7518, DOI 10.17487/RFC7518, May 2015.</td>
</tr>
<tr>
<td class="reference"><b id="RFC7519">[RFC7519]</b></td>
<td class="top">
<a>Jones, M.</a>, <a>Bradley, J.</a> and <a>N. Sakimura</a>, "<a href="https://tools.ietf.org/html/rfc7519">JSON Web Token (JWT)</a>", RFC 7519, DOI 10.17487/RFC7519, May 2015.</td>
</tr>
<tr>
<td class="reference"><b id="RFC7523">[RFC7523]</b></td>
<td class="top">
<a>Jones, M.</a>, <a>Campbell, B.</a> and <a>C. Mortimore</a>, "<a href="https://tools.ietf.org/html/rfc7523">JSON Web Token (JWT) Profile for OAuth 2.0 Client Authentication and Authorization Grants</a>", RFC 7523, DOI 10.17487/RFC7523, May 2015.</td>
</tr>
<tr>
<td class="reference"><b id="RFC7525">[RFC7525]</b></td>
<td class="top">
<a>Sheffer, Y.</a>, <a>Holz, R.</a> and <a>P. Saint-Andre</a>, "<a href="https://tools.ietf.org/html/rfc7525">Recommendations for Secure Use of Transport Layer Security (TLS) and Datagram Transport Layer Security (DTLS)</a>", BCP 195, RFC 7525, DOI 10.17487/RFC7525, May 2015.</td>
</tr>
<tr>
<td class="reference"><b id="RFC7565">[RFC7565]</b></td>
<td class="top">
<a>Saint-Andre, P.</a>, "<a href="https://tools.ietf.org/html/rfc7565">The 'acct' URI Scheme</a>", RFC 7565, DOI 10.17487/RFC7565, May 2015.</td>
</tr>
<tr>
<td class="reference"><b id="RFC7643">[RFC7643]</b></td>
<td class="top">
<a>Hunt, P.</a>, <a>Grizzle, K.</a>, <a>Wahlstroem, E.</a> and <a>C. Mortimore</a>, "<a href="https://tools.ietf.org/html/rfc7643">System for Cross-domain Identity Management: Core Schema</a>", RFC 7643, DOI 10.17487/RFC7643, September 2015.</td>
</tr>
<tr>
<td class="reference"><b id="RFC7644">[RFC7644]</b></td>
<td class="top">
<a>Hunt, P.</a>, <a>Grizzle, K.</a>, <a>Ansari, M.</a>, <a>Wahlstroem, E.</a> and <a>C. Mortimore</a>, "<a href="https://tools.ietf.org/html/rfc7644">System for Cross-domain Identity Management: Protocol</a>", RFC 7644, DOI 10.17487/RFC7644, September 2015.</td>
</tr>
<tr>
<td class="reference"><b id="W3C.REC-html401-19991224">[W3C.REC-html401-19991224]</b></td>
<td class="top">
<a title="W3C">Raggett, D.</a>, <a title="W3C">Hors, A.</a> and <a title="W3C">I. Jacobs</a>, "<a href="https://www.w3.org/TR/1999/REC-html401-19991224">HTML 4.01 Specification</a>", December 1999.</td>
</tr>
<tr>
<td class="reference"><b id="W3C.WebAuthn">[W3C.WebAuthn]</b></td>
<td class="top">
<a title="Google">Balfanz, D.</a>, <a title="Google">Czeskis, A.</a>, <a title="Google">Hodges, J.</a>, <a title="Mozilla">Jones, J.</a>, <a title="Microsoft">Jones, M.</a>, <a title="Microsoft">Kumar, A.</a>, <a title="Microsoft">Liao, A.</a>, <a title="Nok Nok Labs">Lindemann, R.</a> and <a title="Yubico">E. Lundberg</a>, "<a href="https://www.w3.org/TR/webauthn/#test-of-user-presence">Web Authentication</a>", March 2019.</td>
</tr>
</tbody></table>
<h1 id="rfc.appendix.A">
<a href="#rfc.appendix.A">Appendix A.</a> <a href="#Acknowledgements" id="Acknowledgements">Acknowledgements</a>
</h1>
<p id="rfc.section.A.p.1">The OpenID Community would like to thank the following people for their contributions to this specification: </p>
<p></p>

<ul class="empty">
<li>Brian Campbell (bcampbell@pingidentity.com), Ping Identity </li>
<li>Zhen Chien Chia (chiazhenchien@outlook.com), Microsoft </li>
<li>Pamela Dingle (pamela.dingle@microsoft.com), Microsoft </li>
<li>Matt Domsch (matt.domsch@sailpoint.com), SailPoint </li>
<li>Wesley Dunnington (wesleydunnington@pingidentity.com), Ping Identity </li>
<li>Erik Gustavson (erikgustavson@google.com), Google </li>
<li>Dick Hardt (dick.hardt@gmail.com), Independent </li>
<li>Romain Lenglet (rlenglet@google.com), Google </li>
<li>Karl McGuinness (kmcguinness@okta.com), Okta </li>
<li>Chuck Mortimore (cmortimore@salesforce.com), Salesforce </li>
<li>Brian Rose (brian.rose@sailpoint.com), SailPoint </li>
</ul>

<p> </p>
<h1 id="rfc.appendix.B">
<a href="#rfc.appendix.B">Appendix B.</a> <a href="#Notices" id="Notices">Notices</a>
</h1>
<p id="rfc.section.B.p.1">Copyright (c) 2020 The OpenID Foundation.</p>
<p id="rfc.section.B.p.2">The OpenID Foundation (OIDF) grants to any Contributor, developer, implementer, or other interested party a non-exclusive, royalty free, worldwide copyright license to reproduce, prepare derivative works from, distribute, perform and display, this Implementers Draft or Final Specification solely for the purposes of (i) developing specifications, and (ii) implementing Implementers Drafts and Final Specifications based on such documents, provided that attribution be made to the OIDF as the source of the material, but that such attribution does not indicate an endorsement by the OIDF.</p>
<p id="rfc.section.B.p.3">The technology described in this specification was made available from contributions from various sources, including members of the OpenID Foundation and others. Although the OpenID Foundation has taken steps to help ensure that the technology is available for distribution, it takes no position regarding the validity or scope of any intellectual property or other rights that might be claimed to pertain to the implementation or use of the technology described in this specification or the extent to which any license under such rights might or might not be available; neither does it represent that it has made any independent effort to identify any such rights. The OpenID Foundation and the contributors to this specification make no (and hereby expressly disclaim any) warranties (express, implied, or otherwise), including implied warranties of merchantability, non-infringement, fitness for a particular purpose, or title, related to this specification, and the entire risk as to implementing this specification is assumed by the implementer. The OpenID Intellectual Property Rights policy requires contributors to offer a patent promise not to assert certain patent claims against other contributors and against implementers. The OpenID Foundation invites any interested party to bring to its attention any copyrights, patents, patent applications, or other proprietary rights that may cover technology that may be required to practice this specification.</p>
<h1 id="rfc.authors"><a href="#rfc.authors">Author's Address</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Darin K. McAdams</span> 
	  <span class="n hidden">
		<span class="family-name">McAdams</span>
	  </span>
	</span>
	<span class="org vcardline">Amazon</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:darinm@amazon.com">darinm@amazon.com</a></span>

  </address>
</div>

</body>
</html>
