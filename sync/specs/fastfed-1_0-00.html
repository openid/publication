<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>FastFed 1.0 - draft 00</title>

  <style type="text/css" title="Xml2Rfc (sans serif)">
  /*<![CDATA[*/
	  a {
	  text-decoration: none;
	  }
      /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
      a.info {
          /* This is the key. */
          position: relative;
          z-index: 24;
          text-decoration: none;
      }
      a.info:hover {
          z-index: 25;
          color: #FFF; background-color: #900;
      }
      a.info span { display: none; }
      a.info:hover span.info {
          /* The span will display just on :hover state. */
          display: block;
          position: absolute;
          font-size: smaller;
          top: 2em; left: -5em; width: 15em;
          padding: 2px; border: 1px solid #333;
          color: #900; background-color: #EEE;
          text-align: left;
      }
	  a.smpl {
	  color: black;
	  }
	  a:hover {
	  text-decoration: underline;
	  }
	  a:active {
	  text-decoration: underline;
	  }
	  address {
	  margin-top: 1em;
	  margin-left: 2em;
	  font-style: normal;
	  }
	  body {
	  color: black;
	  font-family: verdana, helvetica, arial, sans-serif;
	  font-size: 10pt;
	  max-width: 55em;
	  
	  }
	  cite {
	  font-style: normal;
	  }
	  dd {
	  margin-right: 2em;
	  }
	  dl {
	  margin-left: 2em;
	  }
	
	  ul.empty {
	  list-style-type: none;
	  }
	  ul.empty li {
	  margin-top: .5em;
	  }
	  dl p {
	  margin-left: 0em;
	  }
	  dt {
	  margin-top: .5em;
	  }
	  h1 {
	  font-size: 14pt;
	  line-height: 21pt;
	  page-break-after: avoid;
	  }
	  h1.np {
	  page-break-before: always;
	  }
	  h1 a {
	  color: #333333;
	  }
	  h2 {
	  font-size: 12pt;
	  line-height: 15pt;
	  page-break-after: avoid;
	  }
	  h3, h4, h5, h6 {
	  font-size: 10pt;
	  page-break-after: avoid;
	  }
	  h2 a, h3 a, h4 a, h5 a, h6 a {
	  color: black;
	  }
	  img {
	  margin-left: 3em;
	  }
	  li {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  ol p {
	  margin-left: 0em;
	  }
	  p {
	  margin-left: 2em;
	  margin-right: 2em;
	  }
	  pre {
	  margin-left: 3em;
	  background-color: lightyellow;
	  padding: .25em;
	  }
	  pre.text2 {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f0f0f0;
	  width: 69em;
	  }
	  pre.inline {
	  background-color: white;
	  padding: 0em;
	  }
	  pre.text {
	  border-style: dotted;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  width: 69em;
	  }
	  pre.drawing {
	  border-style: solid;
	  border-width: 1px;
	  background-color: #f8f8f8;
	  padding: 2em;
	  }
	  table {
	  margin-left: 2em;
	  }
	  table.tt {
	  vertical-align: top;
	  }
	  table.full {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.headers {
	  border-style: outset;
	  border-width: 1px;
	  }
	  table.tt td {
	  vertical-align: top;
	  }
	  table.full td {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.tt th {
	  vertical-align: top;
	  }
	  table.full th {
	  border-style: inset;
	  border-width: 1px;
	  }
	  table.headers th {
	  border-style: none none inset none;
	  border-width: 1px;
	  }
	  table.left {
	  margin-right: auto;
	  }
	  table.right {
	  margin-left: auto;
	  }
	  table.center {
	  margin-left: auto;
	  margin-right: auto;
	  }
	  caption {
	  caption-side: bottom;
	  font-weight: bold;
	  font-size: 9pt;
	  margin-top: .5em;
	  }
	
	  table.header {
	  border-spacing: 1px;
	  width: 95%;
	  font-size: 10pt;
	  color: white;
	  }
	  td.top {
	  vertical-align: top;
	  }
	  td.topnowrap {
	  vertical-align: top;
	  white-space: nowrap; 
	  }
	  table.header td {
	  background-color: gray;
	  width: 50%;
	  }
	  table.header a {
	  color: white;
	  }
	  td.reference {
	  vertical-align: top;
	  white-space: nowrap;
	  padding-right: 1em;
	  }
	  thead {
	  display:table-header-group;
	  }
	  ul.toc, ul.toc ul {
	  list-style: none;
	  margin-left: 1.5em;
	  margin-right: 0em;
	  padding-left: 0em;
	  }
	  ul.toc li {
	  line-height: 150%;
	  font-weight: bold;
	  font-size: 10pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  ul.toc li li {
	  line-height: normal;
	  font-weight: normal;
	  font-size: 9pt;
	  margin-left: 0em;
	  margin-right: 0em;
	  }
	  li.excluded {
	  font-size: 0pt;
	  }
	  ul p {
	  margin-left: 0em;
	  }
	
	  .comment {
	  background-color: yellow;
	  }
	  .center {
	  text-align: center;
	  }
	  .error {
	  color: red;
	  font-style: italic;
	  font-weight: bold;
	  }
	  .figure {
	  font-weight: bold;
	  text-align: center;
	  font-size: 9pt;
	  }
	  .filename {
	  color: #333333;
	  font-weight: bold;
	  font-size: 12pt;
	  line-height: 21pt;
	  text-align: center;
	  }
	  .fn {
	  font-weight: bold;
	  }
	  .hidden {
	  display: none;
	  }
	  .left {
	  text-align: left;
	  }
	  .right {
	  text-align: right;
	  }
	  .title {
	  color: #990000;
	  font-size: 18pt;
	  line-height: 18pt;
	  font-weight: bold;
	  text-align: center;
	  margin-top: 36pt;
	  }
	  .vcardline {
	  display: block;
	  }
	  .warning {
	  font-size: 14pt;
	  background-color: yellow;
	  }
	
	
	  @media print {
	  .noprint {
		display: none;
	  }
	
	  a {
		color: black;
		text-decoration: none;
	  }
	
	  table.header {
		width: 90%;
	  }
	
	  td.header {
		width: 50%;
		color: black;
		background-color: white;
		vertical-align: top;
		font-size: 12pt;
	  }
	
	  ul.toc a::after {
		content: leader('.') target-counter(attr(href), page);
	  }
	
	  ul.ind li li a {
		content: target-counter(attr(href), page);
	  }
	
	  .print2col {
		column-count: 2;
		-moz-column-count: 2;
		column-fill: auto;
	  }
	  }
	
	  @page {
	  @top-left {
		   content: "Internet-Draft"; 
	  } 
	  @top-right {
		   content: "December 2010"; 
	  } 
	  @top-center {
		   content: "Abbreviated Title";
	  } 
	  @bottom-left {
		   content: "Doe"; 
	  } 
	  @bottom-center {
		   content: "Expires June 2011"; 
	  } 
	  @bottom-right {
		   content: "[Page " counter(page) "]"; 
	  } 
	  }
	
	  @page:first { 
		@top-left {
		  content: normal;
		}
		@top-right {
		  content: normal;
		}
		@top-center {
		  content: normal;
		}
	  }
  /*]]>*/
  </style>

  <link href="#rfc.toc" rel="Contents">
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction">
<link href="#rfc.section.1.1" rel="Chapter" title="1.1 Requirements Notation and Conventions">
<link href="#rfc.section.1.2" rel="Chapter" title="1.2 Terminology">
<link href="#rfc.section.2" rel="Chapter" title="2 Abbreviations">
<link href="#rfc.section.3" rel="Chapter" title="3 Overview">
<link href="#rfc.section.3.1" rel="Chapter" title="3.1 Metadata">
<link href="#rfc.section.3.2" rel="Chapter" title="3.2 Endpoints">
<link href="#rfc.section.3.3" rel="Chapter" title="3.3 FastFed Handshake">
<link href="#rfc.section.3.4" rel="Chapter" title="3.4 Provider Authorization">
<link href="#rfc.section.3.5" rel="Chapter" title="3.5 User Schemas and Provisioning">
<link href="#rfc.section.3.5.1" rel="Chapter" title="3.5.1 Schema Selection">
<link href="#rfc.section.3.5.2" rel="Chapter" title="3.5.2 Attribute Filtering">
<link href="#rfc.section.3.5.3" rel="Chapter" title="3.5.3 Attibute Mapping">
<link href="#rfc.section.3.5.4" rel="Chapter" title="3.5.4 User Provisioning">
<link href="#rfc.section.3.6" rel="Chapter" title="3.6 Recurring Activities">
<link href="#rfc.section.4" rel="Chapter" title="4 Metadata">
<link href="#rfc.section.4.1" rel="Chapter" title="4.1 Metadata Serialization">
<link href="#rfc.section.4.2" rel="Chapter" title="4.2 Metadata Languages and Scripts">
<link href="#rfc.section.4.3" rel="Chapter" title="4.3 Provider Metadata">
<link href="#rfc.section.4.3.1" rel="Chapter" title="4.3.1 Capabilities">
<link href="#rfc.section.4.3.2" rel="Chapter" title="4.3.2 Common Provider Metadata">
<link href="#rfc.section.4.3.3" rel="Chapter" title="4.3.3 Identity Provider Metadata">
<link href="#rfc.section.4.3.4" rel="Chapter" title="4.3.4 Application Provider Metadata">
<link href="#rfc.section.4.4" rel="Chapter" title="4.4 Instance Metadata">
<link href="#rfc.section.4.4.1" rel="Chapter" title="4.4.1 Common Instance Metadata">
<link href="#rfc.section.4.4.2" rel="Chapter" title="4.4.2 Identity Provider Instance Metadata">
<link href="#rfc.section.4.4.3" rel="Chapter" title="4.4.3 Application Provider Instance Metadata">
<link href="#rfc.section.4.5" rel="Chapter" title="4.5 Metadata Extensions for Specific Protocols">
<link href="#rfc.section.4.5.1" rel="Chapter" title="4.5.1 Extensions for SAML SSO">
<link href="#rfc.section.4.5.2" rel="Chapter" title="4.5.2 Extensions for OIDC SSO">
<link href="#rfc.section.4.5.3" rel="Chapter" title="4.5.3 Extensions for SCIM Provisoning">
<link href="#rfc.section.5" rel="Chapter" title="5 Metadata Endpoints">
<link href="#rfc.section.5.1" rel="Chapter" title="5.1 Provider Metadata Endpoint">
<link href="#rfc.section.5.1.1" rel="Chapter" title="5.1.1 Location">
<link href="#rfc.section.5.1.2" rel="Chapter" title="5.1.2 Read Request">
<link href="#rfc.section.5.1.3" rel="Chapter" title="5.1.3 Read Response">
<link href="#rfc.section.5.2" rel="Chapter" title="5.2 Instance Metadata Endpoint">
<link href="#rfc.section.5.2.1" rel="Chapter" title="5.2.1 Location">
<link href="#rfc.section.5.2.2" rel="Chapter" title="5.2.2 Read Request">
<link href="#rfc.section.5.2.3" rel="Chapter" title="5.2.3 Read Response">
<link href="#rfc.section.5.2.4" rel="Chapter" title="5.2.4 Read Error Response">
<link href="#rfc.section.6" rel="Chapter" title="6 Provider Compatibility Evaluation">
<link href="#rfc.section.7" rel="Chapter" title="7 FastFed Handshake">
<link href="#rfc.section.7.1" rel="Chapter" title="7.1 Common Considerations">
<link href="#rfc.section.7.1.1" rel="Chapter" title="7.1.1 TLS Requirments">
<link href="#rfc.section.7.1.2" rel="Chapter" title="7.1.2 HTTP Redirects">
<link href="#rfc.section.7.1.3" rel="Chapter" title="7.1.3 Serialization">
<link href="#rfc.section.7.1.3.1" rel="Chapter" title="7.1.3.1 Query String Serialization">
<link href="#rfc.section.7.1.3.2" rel="Chapter" title="7.1.3.2 Form Serialization">
<link href="#rfc.section.7.1.4" rel="Chapter" title="7.1.4 Halting the Handshake">
<link href="#rfc.section.7.2" rel="Chapter" title="7.2 Handshake Flow">
<link href="#rfc.section.7.2.1" rel="Chapter" title="7.2.1 Handshake Start at Identity Provider">
<link href="#rfc.section.7.2.1.1" rel="Chapter" title="7.2.1.1 Identity Provider Receives Start Request">
<link href="#rfc.section.7.2.1.2" rel="Chapter" title="7.2.1.2 Identity Provider Authenticates Administrator">
<link href="#rfc.section.7.2.1.3" rel="Chapter" title="7.2.1.3 Identity Provider Reads Application Provider Metadata">
<link href="#rfc.section.7.2.1.4" rel="Chapter" title="7.2.1.4 Identity Provider Verifies Compatibility with Application Provider">
<link href="#rfc.section.7.2.1.5" rel="Chapter" title="7.2.1.5 Identity Provider Obtains Initial Consent from Administrator">
<link href="#rfc.section.7.2.1.6" rel="Chapter" title="7.2.1.6 Identity Provider Generates Instance Metadata">
<link href="#rfc.section.7.2.1.7" rel="Chapter" title="7.2.1.7 Identity Provider Response">
<link href="#rfc.section.7.2.2" rel="Chapter" title="7.2.2 Handshake Receipt by Application Provider">
<link href="#rfc.section.7.2.2.1" rel="Chapter" title="7.2.2.1 Application Provider Authenticates Administrator">
<link href="#rfc.section.7.2.2.2" rel="Chapter" title="7.2.2.2 Application Provider Reads Provider Metadata">
<link href="#rfc.section.7.2.2.3" rel="Chapter" title="7.2.2.3 Application Provider Reads Instance Metadata">
<link href="#rfc.section.7.2.2.4" rel="Chapter" title="7.2.2.4 Application Provider Verifies Compatibility">
<link href="#rfc.section.7.2.2.5" rel="Chapter" title="7.2.2.5 Application Provider Generates Instance Metadata">
<link href="#rfc.section.7.2.2.6" rel="Chapter" title="7.2.2.6 Application Provider Obtains Consent from Administrator">
<link href="#rfc.section.7.2.2.7" rel="Chapter" title="7.2.2.7 Application Provider Enables Federation with the Identity Provider">
<link href="#rfc.section.7.2.2.8" rel="Chapter" title="7.2.2.8 Application Provider Response">
<link href="#rfc.section.7.2.3" rel="Chapter" title="7.2.3 Handshake Completion by Identity Provider">
<link href="#rfc.section.7.2.3.1" rel="Chapter" title="7.2.3.1 Identity Provider Authenticates State Paramater">
<link href="#rfc.section.7.2.3.2" rel="Chapter" title="7.2.3.2 Identity Provider Reads Instance Metadata">
<link href="#rfc.section.7.2.3.3" rel="Chapter" title="7.2.3.3 Identity Provider Verifies Compatibility with Instance Metadata">
<link href="#rfc.section.7.2.3.4" rel="Chapter" title="7.2.3.4 Identity Provider Obtains Final Consent from Administrator">
<link href="#rfc.section.7.2.3.5" rel="Chapter" title="7.2.3.5 Identity Provider Enables Federation">
<link href="#rfc.section.8" rel="Chapter" title="8 Provider Authorization">
<link href="#rfc.section.8.1" rel="Chapter" title="8.1 OAuth Scheme">
<link href="#rfc.section.8.1.1" rel="Chapter" title="8.1.1 FastFed Grant Type">
<link href="#rfc.section.8.1.2" rel="Chapter" title="8.1.2 OAuth Extensions to Provider Metadata">
<link href="#rfc.section.8.1.3" rel="Chapter" title="8.1.3 OAuth Extensions to Instance Metadata">
<link href="#rfc.section.8.1.4" rel="Chapter" title="8.1.4 OAuth Extensions to Handshake Flows">
<link href="#rfc.section.8.1.4.1" rel="Chapter" title="8.1.4.1 Extension to Step 6.2.1.7 - Identity Provider Response">
<link href="#rfc.section.8.1.4.2" rel="Chapter" title="8.1.4.2 Extension to Step 6.2.2.3 - Application Provider Reads Instance Metadata">
<link href="#rfc.section.8.1.4.3" rel="Chapter" title="8.1.4.3 Extension to Step 6.2.2.8 - Application Provider Response">
<link href="#rfc.section.8.1.4.4" rel="Chapter" title="8.1.4.4 Extension to Step 6.2.3.2 - Identity Provider Reads Instance Metadata">
<link href="#rfc.section.8.1.4.5" rel="Chapter" title="8.1.4.5 Extension to Step 6.2.3.5 - Identity Provider Enables Federations">
<link href="#rfc.section.8.1.5" rel="Chapter" title="8.1.5 Applicability to OIDC">
<link href="#rfc.section.8.1.6" rel="Chapter" title="8.1.6 Applicability to SAML">
<link href="#rfc.section.8.1.7" rel="Chapter" title="8.1.7 Applicability to SCIM">
<link href="#rfc.section.9" rel="Chapter" title="9 User Schemas">
<link href="#rfc.section.9.1" rel="Chapter" title="9.1 Attribute Path">
<link href="#rfc.section.9.2" rel="Chapter" title="9.2 Attribute Mapping">
<link href="#rfc.section.9.3" rel="Chapter" title="9.3 SCIM Specifications for FastFed">
<link href="#rfc.section.9.3.1" rel="Chapter" title="9.3.1 SCIM Attribute Path Syntax">
<link href="#rfc.section.9.3.2" rel="Chapter" title="9.3.2 SCIM Attribute Mapping Syntax">
<link href="#rfc.section.9.3.2.1" rel="Chapter" title="9.3.2.1 Simple SCIM to SAML">
<link href="#rfc.section.9.3.2.2" rel="Chapter" title="9.3.2.2 Simple SCIM to OIDC">
<link href="#rfc.section.10" rel="Chapter" title="10 Recurring Activities">
<link href="#rfc.section.10.1" rel="Chapter" title="10.1 Recurring Activities Capabilities">
<link href="#rfc.section.10.2" rel="Chapter" title="10.2 Extensions to Provider Metadata">
<link href="#rfc.section.10.3" rel="Chapter" title="10.3 Extensions to Instance Metadata">
<link href="#rfc.section.10.4" rel="Chapter" title="10.4 Extensions to Provider Compatiblity Evaluation">
<link href="#rfc.section.10.5" rel="Chapter" title="10.5 Extensions to Instance Metadata Validation">
<link href="#rfc.section.10.6" rel="Chapter" title="10.6 Requirements for Icon Refresh">
<link href="#rfc.section.10.6.1" rel="Chapter" title="10.6.1 Publication Requirements">
<link href="#rfc.section.10.6.2" rel="Chapter" title="10.6.2 Consumption Requirements">
<link href="#rfc.section.10.7" rel="Chapter" title="10.7 Requirements for SAML Certificate Rotation">
<link href="#rfc.section.10.7.1" rel="Chapter" title="10.7.1 Publication Requirements">
<link href="#rfc.section.10.7.2" rel="Chapter" title="10.7.2 Consumption Requirements">
<link href="#rfc.section.10.8" rel="Chapter" title="10.8 Requirements for OIDC Key Rotation">
<link href="#rfc.section.10.8.1" rel="Chapter" title="10.8.1 Publication Requirements">
<link href="#rfc.section.10.8.1.1" rel="Chapter" title="10.8.1.1 Publication of New Signing Keys">
<link href="#rfc.section.10.8.1.2" rel="Chapter" title="10.8.1.2 Publication of New Client Secret">
<link href="#rfc.section.10.8.2" rel="Chapter" title="10.8.2 Publication Requirements">
<link href="#rfc.section.10.8.2.1" rel="Chapter" title="10.8.2.1 Consumption of New Signing Keys">
<link href="#rfc.section.10.8.2.2" rel="Chapter" title="10.8.2.2 Consumption of New Client Secret">
<link href="#rfc.section.11" rel="Chapter" title="11 Interoperability Requirements">
<link href="#rfc.section.11.1" rel="Chapter" title="11.1 Interoperability for OIDC 1.0">
<link href="#rfc.section.11.1.1" rel="Chapter" title="11.1.1 Identity Provider Requirements">
<link href="#rfc.section.11.1.2" rel="Chapter" title="11.1.2 Application Provider Requirements">
<link href="#rfc.section.11.2" rel="Chapter" title="11.2 Interoperability for SAML 2.0">
<link href="#rfc.section.11.2.1" rel="Chapter" title="11.2.1 Identity Provider Requirements">
<link href="#rfc.section.11.2.2" rel="Chapter" title="11.2.2 Application Provider Requirements">
<link href="#rfc.section.11.3" rel="Chapter" title="11.3 Interoperability for SCIM 2.0">
<link href="#rfc.section.11.3.1" rel="Chapter" title="11.3.1 Identity Provider Requirements">
<link href="#rfc.section.11.3.2" rel="Chapter" title="11.3.2 Application Provider Requirements">
<link href="#rfc.section.12" rel="Chapter" title="12 FastFed Compatibility Descriptions">
<link href="#rfc.section.13" rel="Chapter" title="13 Security Considerations">
<link href="#rfc.section.14" rel="Chapter" title="14 IANA Considerations">
<link href="#rfc.references" rel="Chapter" title="15 Normative References">
<link href="#rfc.appendix.A" rel="Chapter" title="A Acknowledgements">
<link href="#rfc.appendix.B" rel="Chapter" title="B Notices">
<link href="#rfc.appendix.C" rel="Chapter" title="C Document History">
<link href="#rfc.authors" rel="Chapter">


  <meta name="generator" content="xml2rfc version 2.8.2 - https://tools.ietf.org/tools/xml2rfc" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />

  <meta name="dct.creator" content="McAdams, D." />
  <meta name="dct.identifier" content="urn:ietf:id:fastfed-1_0" />
  <meta name="dct.issued" scheme="ISO8601" content="2017-10-15" />
  <meta name="dct.abstract" content="FastFed simplifies the administrative effort to configure identity federation between an identity provider and a hosted application. The specification defines metadata documents, APIs, and flows to enable an administrator to quickly connect two providers that support common standards such as OpenID Connect, SAML, and SCIM, and allows configuration changes to be communicated directly between the identity provider and hosted application on a recurring basis.  " />
  <meta name="description" content="FastFed simplifies the administrative effort to configure identity federation between an identity provider and a hosted application. The specification defines metadata documents, APIs, and flows to enable an administrator to quickly connect two providers that support common standards such as OpenID Connect, SAML, and SCIM, and allows configuration changes to be communicated directly between the identity provider and hosted application on a recurring basis.  " />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
<td class="left"></td>
<td class="right">D. McAdams</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">Amazon</td>
</tr>
<tr>
<td class="left"></td>
<td class="right">October 15, 2017</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">FastFed 1.0 - draft 00<br />
  <span class="filename">fastfed-1_0</span></p>
  
  <h1 id="rfc.abstract"><a href="#rfc.abstract">Abstract</a></h1>
<p>FastFed simplifies the administrative effort to configure identity federation between an identity provider and a hosted application. The specification defines metadata documents, APIs, and flows to enable an administrator to quickly connect two providers that support common standards such as OpenID Connect, SAML, and SCIM, and allows configuration changes to be communicated directly between the identity provider and hosted application on a recurring basis.  </p>

  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a>
</li>
<ul><li>1.1.   <a href="#rfc.section.1.1">Requirements Notation and Conventions</a>
</li>
<li>1.2.   <a href="#rfc.section.1.2">Terminology</a>
</li>
</ul><li>2.   <a href="#rfc.section.2">Abbreviations</a>
</li>
<li>3.   <a href="#rfc.section.3">Overview</a>
</li>
<ul><li>3.1.   <a href="#rfc.section.3.1">Metadata</a>
</li>
<li>3.2.   <a href="#rfc.section.3.2">Endpoints</a>
</li>
<li>3.3.   <a href="#rfc.section.3.3">FastFed Handshake</a>
</li>
<li>3.4.   <a href="#rfc.section.3.4">Provider Authorization</a>
</li>
<li>3.5.   <a href="#rfc.section.3.5">User Schemas and Provisioning</a>
</li>
<ul><li>3.5.1.   <a href="#rfc.section.3.5.1">Schema Selection</a>
</li>
<li>3.5.2.   <a href="#rfc.section.3.5.2">Attribute Filtering</a>
</li>
<li>3.5.3.   <a href="#rfc.section.3.5.3">Attibute Mapping</a>
</li>
<li>3.5.4.   <a href="#rfc.section.3.5.4">User Provisioning</a>
</li>
</ul><li>3.6.   <a href="#rfc.section.3.6">Recurring Activities</a>
</li>
</ul><li>4.   <a href="#rfc.section.4">Metadata</a>
</li>
<ul><li>4.1.   <a href="#rfc.section.4.1">Metadata Serialization</a>
</li>
<li>4.2.   <a href="#rfc.section.4.2">Metadata Languages and Scripts</a>
</li>
<li>4.3.   <a href="#rfc.section.4.3">Provider Metadata</a>
</li>
<ul><li>4.3.1.   <a href="#rfc.section.4.3.1">Capabilities</a>
</li>
<li>4.3.2.   <a href="#rfc.section.4.3.2">Common Provider Metadata</a>
</li>
<li>4.3.3.   <a href="#rfc.section.4.3.3">Identity Provider Metadata</a>
</li>
<li>4.3.4.   <a href="#rfc.section.4.3.4">Application Provider Metadata</a>
</li>
</ul><li>4.4.   <a href="#rfc.section.4.4">Instance Metadata</a>
</li>
<ul><li>4.4.1.   <a href="#rfc.section.4.4.1">Common Instance Metadata</a>
</li>
<li>4.4.2.   <a href="#rfc.section.4.4.2">Identity Provider Instance Metadata</a>
</li>
<li>4.4.3.   <a href="#rfc.section.4.4.3">Application Provider Instance Metadata</a>
</li>
</ul><li>4.5.   <a href="#rfc.section.4.5">Metadata Extensions for Specific Protocols</a>
</li>
<ul><li>4.5.1.   <a href="#rfc.section.4.5.1">Extensions for SAML SSO</a>
</li>
<li>4.5.2.   <a href="#rfc.section.4.5.2">Extensions for OIDC SSO</a>
</li>
<li>4.5.3.   <a href="#rfc.section.4.5.3">Extensions for SCIM Provisoning</a>
</li>
</ul></ul><li>5.   <a href="#rfc.section.5">Metadata Endpoints</a>
</li>
<ul><li>5.1.   <a href="#rfc.section.5.1">Provider Metadata Endpoint</a>
</li>
<ul><li>5.1.1.   <a href="#rfc.section.5.1.1">Location</a>
</li>
<li>5.1.2.   <a href="#rfc.section.5.1.2">Read Request</a>
</li>
<li>5.1.3.   <a href="#rfc.section.5.1.3">Read Response</a>
</li>
</ul><li>5.2.   <a href="#rfc.section.5.2">Instance Metadata Endpoint</a>
</li>
<ul><li>5.2.1.   <a href="#rfc.section.5.2.1">Location</a>
</li>
<li>5.2.2.   <a href="#rfc.section.5.2.2">Read Request</a>
</li>
<li>5.2.3.   <a href="#rfc.section.5.2.3">Read Response</a>
</li>
<li>5.2.4.   <a href="#rfc.section.5.2.4">Read Error Response</a>
</li>
</ul></ul><li>6.   <a href="#rfc.section.6">Provider Compatibility Evaluation</a>
</li>
<li>7.   <a href="#rfc.section.7">FastFed Handshake</a>
</li>
<ul><li>7.1.   <a href="#rfc.section.7.1">Common Considerations</a>
</li>
<ul><li>7.1.1.   <a href="#rfc.section.7.1.1">TLS Requirments</a>
</li>
<li>7.1.2.   <a href="#rfc.section.7.1.2">HTTP Redirects</a>
</li>
<li>7.1.3.   <a href="#rfc.section.7.1.3">Serialization</a>
</li>
<ul><li>7.1.3.1.   <a href="#rfc.section.7.1.3.1">Query String Serialization</a>
</li>
<li>7.1.3.2.   <a href="#rfc.section.7.1.3.2">Form Serialization</a>
</li>
</ul><li>7.1.4.   <a href="#rfc.section.7.1.4">Halting the Handshake</a>
</li>
</ul><li>7.2.   <a href="#rfc.section.7.2">Handshake Flow</a>
</li>
<ul><li>7.2.1.   <a href="#rfc.section.7.2.1">Handshake Start at Identity Provider</a>
</li>
<ul><li>7.2.1.1.   <a href="#rfc.section.7.2.1.1">Identity Provider Receives Start Request</a>
</li>
<li>7.2.1.2.   <a href="#rfc.section.7.2.1.2">Identity Provider Authenticates Administrator</a>
</li>
<li>7.2.1.3.   <a href="#rfc.section.7.2.1.3">Identity Provider Reads Application Provider Metadata</a>
</li>
<li>7.2.1.4.   <a href="#rfc.section.7.2.1.4">Identity Provider Verifies Compatibility with Application Provider</a>
</li>
<li>7.2.1.5.   <a href="#rfc.section.7.2.1.5">Identity Provider Obtains Initial Consent from Administrator</a>
</li>
<li>7.2.1.6.   <a href="#rfc.section.7.2.1.6">Identity Provider Generates Instance Metadata</a>
</li>
<li>7.2.1.7.   <a href="#rfc.section.7.2.1.7">Identity Provider Response</a>
</li>
</ul><li>7.2.2.   <a href="#rfc.section.7.2.2">Handshake Receipt by Application Provider</a>
</li>
<ul><li>7.2.2.1.   <a href="#rfc.section.7.2.2.1">Application Provider Authenticates Administrator</a>
</li>
<li>7.2.2.2.   <a href="#rfc.section.7.2.2.2">Application Provider Reads Provider Metadata</a>
</li>
<li>7.2.2.3.   <a href="#rfc.section.7.2.2.3">Application Provider Reads Instance Metadata</a>
</li>
<li>7.2.2.4.   <a href="#rfc.section.7.2.2.4">Application Provider Verifies Compatibility</a>
</li>
<li>7.2.2.5.   <a href="#rfc.section.7.2.2.5">Application Provider Generates Instance Metadata</a>
</li>
<li>7.2.2.6.   <a href="#rfc.section.7.2.2.6">Application Provider Obtains Consent from Administrator</a>
</li>
<li>7.2.2.7.   <a href="#rfc.section.7.2.2.7">Application Provider Enables Federation with the Identity Provider</a>
</li>
<li>7.2.2.8.   <a href="#rfc.section.7.2.2.8">Application Provider Response</a>
</li>
</ul><li>7.2.3.   <a href="#rfc.section.7.2.3">Handshake Completion by Identity Provider</a>
</li>
<ul><li>7.2.3.1.   <a href="#rfc.section.7.2.3.1">Identity Provider Authenticates State Paramater</a>
</li>
<li>7.2.3.2.   <a href="#rfc.section.7.2.3.2">Identity Provider Reads Instance Metadata</a>
</li>
<li>7.2.3.3.   <a href="#rfc.section.7.2.3.3">Identity Provider Verifies Compatibility with Instance Metadata</a>
</li>
<li>7.2.3.4.   <a href="#rfc.section.7.2.3.4">Identity Provider Obtains Final Consent from Administrator</a>
</li>
<li>7.2.3.5.   <a href="#rfc.section.7.2.3.5">Identity Provider Enables Federation</a>
</li>
</ul></ul></ul><li>8.   <a href="#rfc.section.8">Provider Authorization</a>
</li>
<ul><li>8.1.   <a href="#rfc.section.8.1">OAuth Scheme</a>
</li>
<ul><li>8.1.1.   <a href="#rfc.section.8.1.1">FastFed Grant Type</a>
</li>
<li>8.1.2.   <a href="#rfc.section.8.1.2">OAuth Extensions to Provider Metadata</a>
</li>
<li>8.1.3.   <a href="#rfc.section.8.1.3">OAuth Extensions to Instance Metadata</a>
</li>
<li>8.1.4.   <a href="#rfc.section.8.1.4">OAuth Extensions to Handshake Flows</a>
</li>
<ul><li>8.1.4.1.   <a href="#rfc.section.8.1.4.1">Extension to Step 6.2.1.7 - Identity Provider Response</a>
</li>
<li>8.1.4.2.   <a href="#rfc.section.8.1.4.2">Extension to Step 6.2.2.3 - Application Provider Reads Instance Metadata</a>
</li>
<li>8.1.4.3.   <a href="#rfc.section.8.1.4.3">Extension to Step 6.2.2.8 - Application Provider Response</a>
</li>
<li>8.1.4.4.   <a href="#rfc.section.8.1.4.4">Extension to Step 6.2.3.2 - Identity Provider Reads Instance Metadata</a>
</li>
<li>8.1.4.5.   <a href="#rfc.section.8.1.4.5">Extension to Step 6.2.3.5 - Identity Provider Enables Federations</a>
</li>
</ul><li>8.1.5.   <a href="#rfc.section.8.1.5">Applicability to OIDC</a>
</li>
<li>8.1.6.   <a href="#rfc.section.8.1.6">Applicability to SAML</a>
</li>
<li>8.1.7.   <a href="#rfc.section.8.1.7">Applicability to SCIM</a>
</li>
</ul></ul><li>9.   <a href="#rfc.section.9">User Schemas</a>
</li>
<ul><li>9.1.   <a href="#rfc.section.9.1">Attribute Path</a>
</li>
<li>9.2.   <a href="#rfc.section.9.2">Attribute Mapping</a>
</li>
<li>9.3.   <a href="#rfc.section.9.3">SCIM Specifications for FastFed</a>
</li>
<ul><li>9.3.1.   <a href="#rfc.section.9.3.1">SCIM Attribute Path Syntax</a>
</li>
<li>9.3.2.   <a href="#rfc.section.9.3.2">SCIM Attribute Mapping Syntax</a>
</li>
<ul><li>9.3.2.1.   <a href="#rfc.section.9.3.2.1">Simple SCIM to SAML</a>
</li>
<li>9.3.2.2.   <a href="#rfc.section.9.3.2.2">Simple SCIM to OIDC</a>
</li>
</ul></ul></ul><li>10.   <a href="#rfc.section.10">Recurring Activities</a>
</li>
<ul><li>10.1.   <a href="#rfc.section.10.1">Recurring Activities Capabilities</a>
</li>
<li>10.2.   <a href="#rfc.section.10.2">Extensions to Provider Metadata</a>
</li>
<li>10.3.   <a href="#rfc.section.10.3">Extensions to Instance Metadata</a>
</li>
<li>10.4.   <a href="#rfc.section.10.4">Extensions to Provider Compatiblity Evaluation</a>
</li>
<li>10.5.   <a href="#rfc.section.10.5">Extensions to Instance Metadata Validation</a>
</li>
<li>10.6.   <a href="#rfc.section.10.6">Requirements for Icon Refresh</a>
</li>
<ul><li>10.6.1.   <a href="#rfc.section.10.6.1">Publication Requirements</a>
</li>
<li>10.6.2.   <a href="#rfc.section.10.6.2">Consumption Requirements</a>
</li>
</ul><li>10.7.   <a href="#rfc.section.10.7">Requirements for SAML Certificate Rotation</a>
</li>
<ul><li>10.7.1.   <a href="#rfc.section.10.7.1">Publication Requirements</a>
</li>
<li>10.7.2.   <a href="#rfc.section.10.7.2">Consumption Requirements</a>
</li>
</ul><li>10.8.   <a href="#rfc.section.10.8">Requirements for OIDC Key Rotation</a>
</li>
<ul><li>10.8.1.   <a href="#rfc.section.10.8.1">Publication Requirements</a>
</li>
<ul><li>10.8.1.1.   <a href="#rfc.section.10.8.1.1">Publication of New Signing Keys</a>
</li>
<li>10.8.1.2.   <a href="#rfc.section.10.8.1.2">Publication of New Client Secret</a>
</li>
</ul><li>10.8.2.   <a href="#rfc.section.10.8.2">Publication Requirements</a>
</li>
<ul><li>10.8.2.1.   <a href="#rfc.section.10.8.2.1">Consumption of New Signing Keys</a>
</li>
<li>10.8.2.2.   <a href="#rfc.section.10.8.2.2">Consumption of New Client Secret</a>
</li>
</ul></ul></ul><li>11.   <a href="#rfc.section.11">Interoperability Requirements</a>
</li>
<ul><li>11.1.   <a href="#rfc.section.11.1">Interoperability for OIDC 1.0</a>
</li>
<ul><li>11.1.1.   <a href="#rfc.section.11.1.1">Identity Provider Requirements</a>
</li>
<li>11.1.2.   <a href="#rfc.section.11.1.2">Application Provider Requirements</a>
</li>
</ul><li>11.2.   <a href="#rfc.section.11.2">Interoperability for SAML 2.0</a>
</li>
<ul><li>11.2.1.   <a href="#rfc.section.11.2.1">Identity Provider Requirements</a>
</li>
<li>11.2.2.   <a href="#rfc.section.11.2.2">Application Provider Requirements</a>
</li>
</ul><li>11.3.   <a href="#rfc.section.11.3">Interoperability for SCIM 2.0</a>
</li>
<ul><li>11.3.1.   <a href="#rfc.section.11.3.1">Identity Provider Requirements</a>
</li>
<li>11.3.2.   <a href="#rfc.section.11.3.2">Application Provider Requirements</a>
</li>
</ul></ul><li>12.   <a href="#rfc.section.12">FastFed Compatibility Descriptions</a>
</li>
<li>13.   <a href="#rfc.section.13">Security Considerations</a>
</li>
<li>14.   <a href="#rfc.section.14">IANA Considerations</a>
</li>
<li>15.   <a href="#rfc.references">Normative References</a>
</li>
<li>Appendix A.   <a href="#rfc.appendix.A">Acknowledgements</a>
</li>
<li>Appendix B.   <a href="#rfc.appendix.B">Notices</a>
</li>
<li>Appendix C.   <a href="#rfc.appendix.C">Document History</a>
</li>
<li><a href="#rfc.authors">Author's Address</a>
</li>


  </ul>

  <h1 id="rfc.section.1">
<a href="#rfc.section.1">1.</a> <a href="#Introduction" id="Introduction">Introduction</a>
</h1>
<p id="rfc.section.1.p.1">Despite the existence of well-established standards, identity federation remains difficult to configure and maintain.  </p>
<p id="rfc.section.1.p.2">One source of difficulty arises because the existing identity standards each solve a portion of the federation ecosystem, such as authentication, schema definition, or end-user information exchange; but without a clear recommendation on how to assemble the pieces into a whole. As a result, each hosted application may choose to assemble standards in different ways or even ignore them, such as by declaring their own user attribute schema. The resulting impact is that each hosted application can be an architectural one-off that an administrator must study and understand before beginning to configure a federation relationship.  </p>
<p id="rfc.section.1.p.3">Another area of difficulty arises because there is no standard mechanism for an identity provider and application provider to directly exchange metadata required by existing standards. Instead, a human administrator must copy-and-paste information between the two providers. This is typically done by opening a web page for each provider and following online instructions to copy information between them. Copy-and-paste errors, overlooked steps, or incomplete documentation can result in non-functional configuration that is difficult to debug.  </p>
<p id="rfc.section.1.p.4">Finally, a working configuration may cease to function when the configuration becomes stale, such as when certificates expire. The lack of a direct communication channel between the identity provider and application provider requires that human administrators remember to periodically refresh the configuration and rotate certificates. In some implementations, planned refresh activities such as certificate rotation can temporarily break the ability for federated users to sign-in to the hosted application.  </p>
<p id="rfc.section.1.p.5">As a result of these challenges, administrators find it necessary to acquire domain expertise in the identity standards and spend significant time configuring, debugging, and maintaining the federations.  </p>
<p id="rfc.section.1.p.6">The goal of FastFed is to simplify the administrator experience. An ecosystem of FastFed-enabled providers will enable administrators to instantiate new federation relationships with a few clicks in a web-based workflow, and without needing to understand the underlying technologies.  </p>
<p id="rfc.section.1.p.7">To encourage adoption and minimize intrusive changes, FastFed does not alter existing standards nor break existing implementations. Rather, FastFed aims to make existing standards easier to adopt.  </p>
<p id="rfc.section.1.p.8">To enable this, FastFed defines additional metadata documents, APIs, and flows that allow an administrator to quickly connect two providers that support the common identity standards. In addition, FastFed defines interoperability profiles which describe the subset of existing standards which must be implemented for a Provider to label themselves as FastFed Compatible.  </p>
<h1 id="rfc.section.1.1">
<a href="#rfc.section.1.1">1.1.</a> <a href="#rnc" id="rnc">Requirements Notation and Conventions</a>
</h1>
<p id="rfc.section.1.1.p.1">The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in <a href="#RFC2119" class="xref">RFC 2119</a>.  </p>
<p id="rfc.section.1.1.p.2">In the .txt version of this specification, values are quoted to indicate that they are to be taken literally.  When using these values in protocol messages, the quotes MUST NOT be used as part of the value.  In the HTML version of this specification, values to be taken literally are indicated by the use of <samp>this fixed-width font</samp>.  </p>
<h1 id="rfc.section.1.2">
<a href="#rfc.section.1.2">1.2.</a> <a href="#Terminology" id="Terminology">Terminology</a>
</h1>
<p id="rfc.section.1.2.p.1">FastFed acts as a high-level metadata description layer which references many different underlying standards. To avoid confusion of terminology, the FastFed specification will explicitly reference the relevent standards inline when using terminology from those standards.  </p>
<p id="rfc.section.1.2.p.2">In addition, this specification defines the following terms. When used in this document, the terms refer to the definitions here and not any of terminology from underlying standards: </p>

<dl>
<dt>Administrator</dt>
<dd style="margin-left: 8">A human end-user who is reponsible for establishing the federation between an Identity Provider and Application Provider. An Administrator is typically a member of an organization with privileges to enable single sign-on to hosted applications for other members of their organization.  </dd>
<dt>Application Provider</dt>
<dd style="margin-left: 8">An online service or website which requires end-user provisioning and authentication from an Identity Provider.  </dd>
<dt>FastFed URL</dt>
<dd style="margin-left: 8">A shorthand alias for the FastFed Provider Metadata Endpoint (<a href="#ProviderMetadataEndpoint" class="xref">Section 5.1</a>). Providers may advertise their "FastFed URL" in the documentation for enabling single sign-on.  </dd>
<dt>Identity Provider</dt>
<dd style="margin-left: 8">A service that is capable of authenticating end-users and providing information about the authentation event and the end-user to an Application Provider. May also be capable of pre-provisioning user information to the Application Provider.  </dd>
<dt>Multi-Tenant Provider</dt>
<dd style="margin-left: 8">A Provider who serves multiple customers from a single instance of a service. Each customer is logically isolated from other customers of the service.  <br> The FastFed specification treats all Providers as potentially Multi-Tenant.  </dd>
<dt>Provider</dt>
<dd style="margin-left: 8">An entity that can act as an Application Provider, an Identity Provider, or both.  </dd>
</dl>

<p> </p>
<h1 id="rfc.section.2">
<a href="#rfc.section.2">2.</a> <a href="#Abbreviations" id="Abbreviations">Abbreviations</a>
</h1>
<p id="rfc.section.2.p.1">The following abbreviations are used in this specification: </p>

<dl>
<dt>OIDC</dt>
<dd style="margin-left: 8">OpenID Connect, as defined in <a href="#OpenID.Core" class="xref">[OpenID.Core]</a> and related specifications.  </dd>
<dt>SAML</dt>
<dd style="margin-left: 8">Security Assertion Markup Language, as defined in <a href="#SAML.Profiles" class="xref">[SAML.Profiles]</a> and related specficiations.  </dd>
<dt>SCIM</dt>
<dd style="margin-left: 8">System for Cross-domain Identity Management, as defined in <a href="#RFC7643" class="xref">[RFC7643]</a> and related specifications.  </dd>
<dt>SSO</dt>
<dd style="margin-left: 8">Single sign-on, as enabled by protocols such as OIDC and SAML.  </dd>
</dl>

<p> </p>
<h1 id="rfc.section.3">
<a href="#rfc.section.3">3.</a> <a href="#Overview" id="Overview">Overview</a>
</h1>
<p id="rfc.section.3.p.1">This section provides an introductory overview of the key concepts in FastFed. The following concepts are explored: </p>

<dl>
<dt>Metadata</dt>
<dd style="margin-left: 8">Configuration that describes the capabilities and preferences of a Provider.  </dd>
<dt>Endpoints</dt>
<dd style="margin-left: 8">Locations where Metadata documents can be retrieved.  </dd>
<dt>Handshake</dt>
<dd style="margin-left: 8">Flows that describe how an Identity Provider and Application Provider share Metatdata documents with each other, thereby establishing the federation.  </dd>
<dt>Provider Authorization</dt>
<dd style="margin-left: 8">Enables access controls on Metadata exchanges.  </dd>
<dt>User Schema, Attribute Mapping, and Provisioning</dt>
<dd style="margin-left: 8">Describes how Providers agree on a common user schema, bind the schema to an SSO protocol, and declare capabilities for user provisioning.  </dd>
<dt>Recurring Activities</dt>
<dd style="margin-left: 8">Optional features to periodically refresh the information exchanged during a Handshake, including certificate rotations.  </dd>
</dl>

<p> </p>
<h1 id="rfc.section.3.1">
<a href="#rfc.section.3.1">3.1.</a> <a href="#OverviewMetadata" id="OverviewMetadata">Metadata</a>
</h1>
<p id="rfc.section.3.1.p.1">FastFed uses Metadata documents to enable Identity Providers and Application Providers to programmatically discover the capabilities of one other and exchange any configuration necessary to enable federation.  </p>
<p id="rfc.section.3.1.p.2">FastFed Metadata is split into two distinct document types: </p>

<ul>
<li>Provider Metadata</li>
<li>Instance Metadata</li>
</ul>

<p> </p>
<h1 id="rfc.section.3.1.1">
<a href="#rfc.section.3.1.1">3.1.1.</a> <a href="#OverviewProviderMetadata" id="OverviewProviderMetadata">Provider Metadata</a>
</h1>
<p id="rfc.section.3.1.1.p.1">Provider Metadata describes the capabilities and configurations of the Provider.  </p>
<p id="rfc.section.3.1.1.p.2">The primary purpose of Provider Metadata is to bootstrap the FastFed Handshake (<a href="#Handshake" class="xref">Section 7</a>). To do so, Provider Metadata describes the capabilities of providers so that compatibility can be evaluated when initiating the handshake; e.g. if an Application Provider requires SAML, the Identity Provider must also support SAML.  </p>
<p id="rfc.section.3.1.1.p.3">Provider Metadata also specifies the endpoints for performing the FastFed Handshake, plus optional values such as icon images that can aesthetically improve the handshake flows seen by Administrators.  </p>
<p id="rfc.section.3.1.1.p.4">Provider Metadata is segmented into blocks for <samp>identity_provider</samp> and <samp>application_provider</samp>. An entity can define one, or both blocks, depending on the roles they are capable of performing.  </p>
<p id="rfc.section.3.1.1.p.5">The following is a non-normative example of Provider Metadata: </p>
<pre>
 {
   "identity_provider": {
     "provider_uri": "https://idp.example.com",
     "name": "My Identity Provider",
     "icons": {
       "large_icon_uri": "https://idp.example.com/images/tile.png",
       "small_icon_uri": "https://idp.example.com/images/favicon.png"
     }
     capabilities: {
       "sso_protocols_supported": ["OIDC","SAML"],
       "user_schemas_supported": ["urn:ietf:params:scim:schemas:core:2.0:User"],
       "user_provisioning_modes_supported": ["SCIM","JIT","Custom","NoProvisioning"],
       "provider_authz_schemes_supported": ["OAuth"]
     }
     "fastfed_handshake_start_uri": "https://idp.example.com/fastfed/start",
     "fastfed_handshake_finish_uri": "https://idp.example.com/fastfed/finish"
 }
</pre>
<h1 id="rfc.section.3.1.2">
<a href="#rfc.section.3.1.2">3.1.2.</a> <a href="#OverviewInstanceMetadata" id="OverviewInstanceMetadata">Instance Metadata</a>
</h1>
<p id="rfc.section.3.1.2.p.1">Instance Metadata describes the configuration to be used when instantiating a specific instance of a federated relationship between the tenant of an Identity Provider and the tenant of an Application Provider. For example, if SAML is chosen as the SSO protocol, the Instance Metadata document will specify the URL of the SAML Metadata files, which may themselves include tenant-specific customizations such as vanity sign-in URLs.  </p>
<p id="rfc.section.3.1.2.p.2">Instance Metadata documents are exchanged during the Fast Fed Handshake, and are the means by which the Providers are able to programmatically share information without requiring an Administrator to copy-and-paste configuration between the two parties.  </p>
<p id="rfc.section.3.1.2.p.3">The following is a non-normative examples of Instance Metadata for an Identity Provider: </p>
<pre>
 {
   "identity_provider_instance": {
     "tenant_id": "k2lini4cj509ut09cj0jcjwee9gj0jeg",
     "sso_protocol": "SAML",
     "saml_metadata_uri": "https://tenant12345.example.com/saml-metadata.xml",
     "user_schema": "urn:ietf:params:scim:schemas:core:2.0:User",
     "user_provisioning_mode": "JIT"
     "provider_authz_scheme": "OAuth",
     "oauth_token_endpoint": "https://tenant12345.example.com/token",
 }
</pre>
<h1 id="rfc.section.3.2">
<a href="#rfc.section.3.2">3.2.</a> <a href="#OverviewEndpoints" id="OverviewEndpoints">Endpoints</a>
</h1>
<p id="rfc.section.3.2.p.1">Endpoints describe the semantics for exchanging information between the Providers.  </p>
<p id="rfc.section.3.2.p.2">FastFed defines two Endpoints for retrieving Metadata documents: </p>

<ul>
<li>Provider Metadata Endpoint (<a href="#ProviderMetadataEndpoint" class="xref">Section 5.1</a>)</li>
<li>Instance Metadata Endpoint (<a href="#InstanceMetadataEndpoint" class="xref">Section 5.2</a>)</li>
</ul>

<p> </p>
<p id="rfc.section.3.2.p.3">And, three Endpoints for the FastFed Handshake </p>

<ul>
<li>FastFed Handshake Start Endpoint (<a href="#HandshakeIdentityProviderRequest" class="xref">Section 7.2.1.1</a>)</li>
<li>FastFed Handshake Receive Endpoint (<a href="#HandshakeIdentityProviderResponse" class="xref">Section 7.2.1.7</a>)</li>
<li>FastFed Handshake Finish Endpoint (<a href="#HandshakeApplicationProviderResponse" class="xref">Section 7.2.2.8</a>)</li>
</ul>

<p> </p>
<h1 id="rfc.section.3.2.1">
<a href="#rfc.section.3.2.1">3.2.1.</a> <a href="#OverviewProviderMetadataEndpoint" id="OverviewProviderMetadataEndpoint">Provider Metadata Endpoint (abbr. "FastFed URL")</a>
</h1>
<p id="rfc.section.3.2.1.p.1">The Provider Metadata Endpoint, also referred to as the "FastFed URL", vends the Provider Metadata. This URL is the only attribute that Administrators need to copy and paste in order to initiate the FastFed Handshake flows.  </p>
<p id="rfc.section.3.2.1.p.2">Providers typically advertise their FastFed URL in their SSO documentation. In addition, catalogs of pre-configured FastFed URLs may further simplify the Administrator experience. For example, an Identity Provider may offer a catalog of Application Providers in which the FastFed URL for each Application Provider has been pre-configured.  </p>
<h1 id="rfc.section.3.2.2">
<a href="#rfc.section.3.2.2">3.2.2.</a> <a href="#OverviewOtherMetadataEndpoint" id="OverviewOtherMetadataEndpoint">Other Endpoints</a>
</h1>
<p id="rfc.section.3.2.2.p.1">All other FastFed Endpoints are either discoverable from the Provider Metadata document, or exchanged as part of the FastFed Handshake flows. From an Administrator perspective, these other Endpoints may be regarded as an implementation detail and not part of their visible experience.  </p>
<h1 id="rfc.section.3.3">
<a href="#rfc.section.3.3">3.3.</a> <a href="#OverviewFastFedHandshake" id="OverviewFastFedHandshake">FastFed Handshake</a>
</h1>
<p id="rfc.section.3.3.p.1">The FastFed Handshake flow is the means by which Metadata documents are exchanged and a federation relationship becomes established.  </p>
<p id="rfc.section.3.3.p.2">The FastFed Handshake is initiated by sending a request to the Identity Provider with a parameter containing the FastFed URL of the Application Provider.  </p>
<p id="rfc.section.3.3.p.3">The handshake may be initiated by the Identity Provider or the Application Provider. The flow is the same for each, only varying by whether the Handshake endpoint is invoked by the Identity Provider (by sending a request to itself) or by the Application Provider.  </p>
<p id="rfc.section.3.3.p.4">Upon receiving a handshake initiation request, the abstract flow follows these steps: </p>
<p></p>

<ol>
<li>Identity Provider authenticates the Administrator </li>
<li>Identity Provider reads the Application Provider Metadata and verifies compatibility </li>
<li>Identity Provider redirects the Administrator to the Application Provider </li>
<li>Application Provider authenticates the Administrator </li>
<li>Application Provider reads Instance Metadata from the Identity Provider </li>
<li>Application Provider stores the federation configuration </li>
<li>Application Provider redirects the Administrator back to the Identity Provider </li>
<li>Identity Provider reads Instance Metadata from the Application Provider </li>
<li>Identity Provider stores the federation configuration </li>
</ol>

<p> </p>
<pre>
   +----------+              +----------------+         .----.
   |   User   |&lt;-----(1)----&gt;|                |        |.____.|
   |   Agent  |              |    Identity    |--(9)--&gt;| Data |
   |      +---|------(3)-----|    Provider    |        | Store|
   |      | +-|-------------&gt;|                |         "----"
   |      | | |              +----------------+
   |      | | |                 |    ^    |
   |      | | |                 |    |    |
   |      | | |                 |    |    |
   |      | | |                (2)  (5)  (8)
   |      | | |                 |    |    |
   |      | | |                 |    |    |
   |      | | |                 V    |    V
   |      | | |              +----------------+         .----.
   |      | +-|------(7)-----|                |        |.____.|
   |      +---|-------------&gt;|  Application   |--(6)--&gt;| Data |
   |          |              |    Provider    |        | Store|
   |          |&lt;-----(4)----&gt;|                |         "----"
   +----------+              +----------------+

                 Figure 1: Abstract Handshake Flow
</pre>
<h1 id="rfc.section.3.4">
<a href="#rfc.section.3.4">3.4.</a> <a href="#OverviewProviderAuthorization" id="OverviewProviderAuthorization">Provider Authorization</a>
</h1>
<p id="rfc.section.3.4.p.1">For privacy reasons, Multi-Tenant Providers may be unwilling or prohibited from exposing tenant data to unauthorized audiences. In some cases, simply acknowledging the existence of a tenant may be prohibited. Such information can only be released with explicit authorization from the tenant.  </p>
<p id="rfc.section.3.4.p.2">To enable these privacy controls, FastFed includes the ability to select an authorization scheme for calls between Providers.  </p>
<p id="rfc.section.3.4.p.3">One scheme defined in this specificatin uses OAuth <a href="#RFC6749" class="xref">[RFC6749]</a>. The OAuth tokens are exchanged between Providers during the FastFed Handshake. The OAuth tokens demonstrate that an authorized Administrator has approved access to the tenant information. The tokens can be used to gate access to any resource that is used when configuring and maintaining a federation relationship.  (See <a href="#ProviderAuthzOAuth" class="xref">Section 8.1</a>) </p>
<h1 id="rfc.section.3.5">
<a href="#rfc.section.3.5">3.5.</a> <a href="#OverviewUser" id="OverviewUser">User Schemas and Provisioning</a>
</h1>
<p id="rfc.section.3.5.p.1">Federated Identity Management requires a common, agreed upon schema to describe user information, plus a mechanism to transmit user information across organizational boundaries.  </p>
<p id="rfc.section.3.5.p.2">While previous standards each define pieces of the solution, they lack guidance on assembling the pieces into an end-to-end flow. For example, the SCIM specification defines a User schema, but does not specify how to bind the schema into SAML or OIDC assertions. Alternatively, OIDC defines a schema for Standard Claims and a User Info Endpoint to retrieve them. However, the claims are weighted toward describing social media users and may lack attributes necessary to describe users from the enterprise sector or educational sector. In addition, the OIDC claims are bound to the OIDC protocol and it is unspecified how the same schema could be reused with an Application Provider that requires SAML instead of OIDC. Finally, it is not uncommon for an Application Provider to completely ignore all preexisting standards and define their own schema which federation partners must adhere to in SAML or OIDC messages.  </p>
<p id="rfc.section.3.5.p.3">Administrators bear the burden of this inconsistency. The lack of agreement amongst federation participants requires an Administrator to bridge the divide by defining schema transformation rules that map user attributes from an Identity Provider format into an Application Provider format. This mapping is unique for each Application Provider and must be defined for each federation. Understanding and defining these transformation rules is a major contributor to the friction of adopting federation.  </p>
<p id="rfc.section.3.5.p.4">To eliminate the burden from Administrators, Providers must agree upon a shared vocabulary for user attributes. This is accomplished by requiring both parties to share a common schema for use within the FastFed Metadata documents. This schema serves as a common lingua franca for communicating the user attributes to be exchanged.  </p>
<p id="rfc.section.3.5.p.5">FastFed also provides an Attribute Mapping capability so that Application Providers may declare how they would like user attributes communicated to them as part of a particular SSO protocol. By using the Attribute Mappings, a Provider can become FastFed-enabled while continuing to operate an existing federation endpoint that relies on non-standard schemas. This shifts the burden for attribute mapping from the Administrator to the Application Provider, and further improves the situation by only asking the Application Provider to define the mapping once, in the Metadata, where it can be reused across all FastFed-enabled relationships.  </p>
<h1 id="rfc.section.3.5.1">
<a href="#rfc.section.3.5.1">3.5.1.</a> <a href="#OverviewUserSchemaSelection" id="OverviewUserSchemaSelection">Schema Selection</a>
</h1>
<p id="rfc.section.3.5.1.p.1">FastFed Metadata allows Providers to declare the schemas they understand. Providers should choose schemas that are likely to be shared by federation partners. The lack of a common schema between an Identity Provider and Application Provider will be regarded as an incompatibility and the FastFed handshake will be halted before completion.  </p>
<p id="rfc.section.3.5.1.p.2">FastFed recommends the use of the SCIM User Resource Schema and the SCIM Enterprise User Schema Extension. This specification uses SCIM in examples and references. However, other schemas may be used.  </p>
<p id="rfc.section.3.5.1.p.3">The following is a non-normative example showing a snippet from a Provider Metadata with a list of schemas understood by an Identity Provider: </p>
<pre>
 {
   "identity_provider": {
     capabilities: {
       ...
       "user_schemas_supported": [
         "urn:ietf:params:scim:schemas:core:2.0:User",
         "urn:ietf:params:scim:schemas:enterprise:2.0:User"
       ],
     }
     ...
</pre>
<h1 id="rfc.section.3.5.2">
<a href="#rfc.section.3.5.2">3.5.2.</a> <a href="#OverviewUserAttributeFiltering" id="OverviewUserAttributeFiltering">Attribute Filtering</a>
</h1>
<p id="rfc.section.3.5.2.p.1">User schemas can potentially contain many pieces of information about a user. For example, the SCIM User Resource defines more than 25 different attribute types, some containing sensitive user information. It is typically unnecessary to share all user information with a hosted application. In recognition of this, FastFed provides a mechanism for Application Providers to define the subset of attributes needed to use the application.  </p>
<p id="rfc.section.3.5.2.p.2">Identity Providers display the list of requested attributes during the FastFed Handshake so that Administrators may review and approve the attributes to be released.  </p>
<p id="rfc.section.3.5.2.p.3">The following is a non-normative example showing a snippet of Instance Metadata for an Application Provider who desires 3 attributes from a SCIM User Resource.  </p>
<pre>
 {
   "application_provider_instance": {
     ...
     "user_schema": "urn:ietf:params:scim:schemas:core:2.0:User",
     "desired_user_attributes": [
       {"required": ["username", "emails[primary eq true]"],
        "optional": ["name.formatted"]
       }
     ],
     ...
</pre>
<h1 id="rfc.section.3.5.3">
<a href="#rfc.section.3.5.3">3.5.3.</a> <a href="#OverviewUserAttributeMapping" id="OverviewUserAttributeMapping">Attibute Mapping</a>
</h1>
<p id="rfc.section.3.5.3.p.1">Attribute Mapping is the process of copying user attributes from a schema into the specific structure required of an SSO protocol such as SAML or OIDC. This may include relabeling the name of the attribute.  </p>
<p id="rfc.section.3.5.3.p.2">Application Providers declare how they would like schema information transmitted to them for a given SSO protocol. Identity Providers are responsible for applying the mapping to outgoing SSO messages.  </p>
<p id="rfc.section.3.5.3.p.3">FastFed specifies mappings for SCIM-to-SAML and SCIM-to-OIDC. Application Providers may copy the reference examples, or define a custom mapping. Custom mappings allow an Application Provider to become FastFed compliant even if their SSO endpoint uses a non-standard format for user attributes.  </p>
<p id="rfc.section.3.5.3.p.4">The following is a non-normative example showing a snippet of Instance Metadata which contains a SCIM-to-SAML attribute mapping: </p>
<pre>
 {
   "application_provider_instance": {
     ...
     "sso_protocol": "SAML",
     "user_schema": "urn:ietf:params:scim:schemas:core:2.0:User",
     "user_attribute_mapping": {
       "mapping_syntax": "simple_scim_to_saml",
       "mapping_rules": {
         "name_id": {
           "format": "urn:oasis:names:tc:SAML:2.0:nameid-format:persistent",
           "value": "id",
         },
         "attributes": [
           {"name": "name",
            "value": "displayName"
           },
           {"name": "email",
            "value": "email[primary eq true].value"
           },
           {"name": "groups",
            "value": "groups.displayName"
           }
         ]
     },    
     ...
</pre>
<h1 id="rfc.section.3.5.4">
<a href="#rfc.section.3.5.4">3.5.4.</a> <a href="#OverviewUserProvisioning" id="OverviewUserProvisioning">User Provisioning</a>
</h1>
<p id="rfc.section.3.5.4.p.1">User Provisioning is the process of creating user accounts in the hosted application. Common patterns include the following: </p>
<p></p>

<ul class="empty">
<li>Pre-Provisioning <ul class="empty"><li>Accounts are pre-created in the application prior to an end-user signing into the application. In addition, updates to user information in the Identity Provider are automatically propagated to the application </li></ul>
<p> </p>
</li>
<li>Just In Time Provisioning (JIT) <ul class="empty"><li>Accounts are created when a user first signs-in. The user attributes for account creation are supplied as part of the sign-in protocol. If the account already exists, it is updated using the attributes supplied as part of the sign-in protocol. A consequence of JIT Provisioning is that user information is never updated unless a user signs-in. In addition, users that become deactivated in the Identity Provider may continue to exist in the Application Provider.  </li></ul>
<p> </p>
</li>
<li>Ephemeral Users <ul class="empty"><li>No long-lived user accounts exist in the application. User information is discarded when the session ends.  </li></ul>
<p> </p>
</li>
</ul>

<p> </p>
<p id="rfc.section.3.5.4.p.3">FastFed Metadata enables Providers to describe their provisioning requirements and capabilities. See <a href="#ProviderMetadataCapabilities" class="xref">Section 4.3.1</a> and <a href="#CommonInstanceMetadata" class="xref">Section 4.4.1</a>.  </p>
<h1 id="rfc.section.3.6">
<a href="#rfc.section.3.6">3.6.</a> <a href="#OverviewRecurringActivities" id="OverviewRecurringActivities">Recurring Activities</a>
</h1>
<p id="rfc.section.3.6.p.1">Some federation information needs to be updated on recurring basis. FastFed specifies the following recurring activities: </p>
<p></p>

<ul>
<li>SAML Certificate Rotation</li>
<li>Open ID Connect Key Rotation, including rotation of client_secret</li>
<li>Icon Image Refresh</li>
</ul>

<p> </p>
<p id="rfc.section.3.6.p.3">See section <a href="#RecurringActivities" class="xref">Section 10</a> for details.  </p>
<p id="rfc.section.3.6.p.4">The following is a non-normative example showing a snippet of Provider Metadata describing the supported recurring activities: </p>
<pre>
 {
   "identity_provider": {
     ...
     "recurring_activities": {
         "icon_refresh: ["publish", "consume"],
         "saml_certificate_rotation": ["publish"]
         "oidc_key_rotation": ["publish"]
     },
     ...	 
</pre>
<h1 id="rfc.section.4">
<a href="#rfc.section.4">4.</a> <a href="#Metadata" id="Metadata">Metadata</a>
</h1>
<h1 id="rfc.section.4.1">
<a href="#rfc.section.4.1">4.1.</a> <a href="#MetadataSerialization" id="MetadataSerialization">Metadata Serialization</a>
</h1>
<p id="rfc.section.4.1.p.1">All FastFed Metadata is represented in JSON format. Property names and string values are represented as JSON strings. Numerical values are represented as JSON numbers. Boolean values are represented as JSON Booleans. Lists are represented as JSON arrays. Complex structures are represented as JSON objects. Omitted properties and properties with no value SHOULD be omitted from the object and not represented by a JSON null value.  </p>
<h1 id="rfc.section.4.2">
<a href="#rfc.section.4.2">4.2.</a> <a href="#MetadataLanguages" id="MetadataLanguages">Metadata Languages and Scripts</a>
</h1>
<p id="rfc.section.4.2.p.1">Human-readable Metadata values and Metadata values that reference human-readable values MAY be represented in multiple languages and scripts. For example, values such as client_name and large_icon_uri might have multiple locale-specific values for some Providers.  </p>
<p id="rfc.section.4.2.p.2">To specify the languages and scripts, <a href="#RFC5646" class="xref">BCP47</a> [RFC5646] language tags are added to Client Metadata member names, delimited by a # character.  </p>
<p id="rfc.section.4.2.p.3">If such a human-readable field is sent without a language tag, parties using it MUST NOT make any assumptions about the language, character set, or script of the string value, and the string value MUST be used as-is wherever it is presented in a user interface. To facilitate interoperability, it is RECOMMENDED that any human-readable fields sent without language tags contain values suitable for display on a wide variety of systems.  </p>
<h1 id="rfc.section.4.3">
<a href="#rfc.section.4.3">4.3.</a> <a href="#ProviderMetadata" id="ProviderMetadata">Provider Metadata</a>
</h1>
<p id="rfc.section.4.3.p.1">Provider Metadata enables Providers to advertise their capabilities and evaluate compatibility with other Providers by comparing capabilities. The Provider Metadata also contains the endpoint configuration needed to perform the FastFed Handshake.  </p>
<p id="rfc.section.4.3.p.2">Provider Metadata is a structure with the following top-level attributes: </p>

<dl>
<dt>identity_provider</dt>
<dd style="margin-left: 8">OPTIONAL. Structure containing the attributes described by Identity Provider Metadata (<a href="#IdentityProviderMetadata" class="xref">Section 4.3.3</a>).  The existence of this element indicates the entity is capable of acting as an Identity Provider.  </dd>
<dt>application_provider</dt>
<dd style="margin-left: 8">OPTIONAL. Structure containing the attributes described by Application Provider Metadata (<a href="#ApplicationProviderMetadata" class="xref">Section 4.3.4</a>) The existence of this element indicates the entity is capable of acting as an Application Provider.  </dd>
</dl>

<p> </p>
<p id="rfc.section.4.3.p.3">If a single Provider is capable of acting as both an Identity Provider and an Application Provider, the Provider Metadata MAY contain both parts.  </p>
<p id="rfc.section.4.3.p.4">If neither part is specified, the FastFed Handshake will halt as per <a href="#HandshakeHalt" class="xref">Section 7.1.4</a>.  </p>
<h1 id="rfc.section.4.3.1">
<a href="#rfc.section.4.3.1">4.3.1.</a> <a href="#ProviderMetadataCapabilities" id="ProviderMetadataCapabilities">Capabilities</a>
</h1>
<p id="rfc.section.4.3.1.p.1">Capabilities describe the supported behaviors of a Provider.  They are included in the Metatdata for both Identity Providers and Application Providers and are the primary tool to evaluate if two Providers are compatible with one another.  </p>
<p id="rfc.section.4.3.1.p.2">Capabilities are represented as a structure with the following attributes: </p>

<dl>
<dt>sso_protocols_supported</dt>
<dd style="margin-left: 8">REQUIRED. A list of strings specifying the SSO protocols supported by the Provider. Valid values for this element include the following: <ul class="empty">
<li><samp>OIDC</samp></li>
<li><ul class="empty"><li>The Provider supports OpenID Connect as defined in <a href="#OIDCInteroperability" class="xref">Section 11.1</a> </li></ul></li>
<li><samp>SAML</samp></li>
<li><ul class="empty"><li>The Provider supports SAML as defined in <a href="#SAMLInteroperability" class="xref">Section 11.2</a> </li></ul></li>
</ul>
<p> </p>
</dd>
<dt>user_schemas_supported</dt>
<dd style="margin-left: 8">REQUIRED. A list of URNs specifying the user schemas understood by the Provider. FastFed does not mandate a specific schema, but RECOMMENDS the use of SCIM.  <br><br> If the SCIM User Schemas and Extensions defined in <a href="#RFC7643" class="xref">[RFC7643]</a> do not meet the needs of a Provider, the Provider SHOULD coordinate with other potential integration partners to agree upon a commonly understood schema with the necessary user attributes. The Provider SHOULD consider defining this schema as an extension of the core SCIM User Resource.  <br><br> If SCIM is used, the SCIM Core Schemas defined in <a href="#RFC7643" class="xref">[RFC7643]</a> MUST be represented using the following values: <ul class="empty">
<li><samp>urn:ietf:params:scim:schemas:core:2.0:User</samp></li>
<li><ul class="empty"><li>Indicates the Provider understands the core SCIM User Resource Schema specified in Section 4.1 of <a href="#RFC7643" class="xref">SCIM Core</a> [RFC7643] </li></ul></li>
<li><samp>urn:ietf:params:scim:schemas:enterprise:2.0:User</samp></li>
<li><ul class="empty"><li>Indicates the provider understands the SCIM Enterprise User Schema Extension specified in Section 4.3 of <a href="#RFC7643" class="xref">SCIM Core</a> [RFC7643] </li></ul></li>
</ul>
<p> When one schema extends another schema, Providers MUST list both schemas if they are capable of using either the extended or the base schema when integrating with federation partners. If the extended schema is mandatory, Providers MUST list only the extended schema.  </p>
</dd>
<dt>user_provisioning_modes_supported</dt>
<dd style="margin-left: 8">REQUIRED. A list of strings defining the requirements and capabilities for provisioning user accounts into an application. The list must contain at least one value. The following values are defined: <ul class="empty">
<li><samp>SCIM</samp></li>
<li>
<ul class="empty"><li>A Provider supports pre-provisioning of user accounts via the SCIM protocol, as defined in <a href="#MetadataSCIMExtensions" class="xref">Section 4.5.3</a> and <a href="#SCIMInteroperability" class="xref">Section 11.3</a>.  </li></ul>
<p> </p>
</li>
<li><samp>JIT</samp></li>
<li>
<ul class="empty">
<li>Application Providers who support Just In Time Provisioning (JIT) MUST create and update user accounts when an end-user signs-in to the application. The Application Provider MAY support non-standard out-of-band mechanisms to update or delete user accounts in the application, and MAY provide a URI to document the options for Administrators. The <samp>provisioning_documentation_uri</samp> is specified in <a href="#CommonInstanceMetadata" class="xref">Instance Metadata</a>.  </li>
<li>Identity Providers who support JIT provisioning MUST inform Administrators who are configuring single sign-on with the application that the application uses JIT provisioning; and while single sign-on will work, the application may hold a copy of user information that can become stale over time. The Identity Provider MAY point the Administrator to documentation for the Application Provider with more information if the Application Provider has specified the <samp>provisioning_documentation_uri</samp> in their <a href="#CommonInstanceMetadata" class="xref">Instance Metadata</a>.  </li>
</ul>
<p> </p>
</li>
<li><samp>Custom</samp></li>
<li>
<ul class="empty">
<li>Application Providers who use Custom provisioning MUST require that Administrators execute non-standard out-of-band mechanisms before end-users may sign-in to the application using SSO protocols. Application Providers MUST reject SSO attempts by end-users who have not been been provisioned through the custom process. The use of Custom provisioning SHOULD be avoided whenever possible, but may be appropriate for certain applications in which the benefits of using FastFed to configure the SSO relationship are desired, even though SSO will not function until other activities are performed by the Administrator.  <br> The Applicaton Provider MUST include a <samp>provisioning_documentation_uri</samp> in their <a href="#CommonInstanceMetadata" class="xref">Instance Metadata</a> which points to guidance for the Administrator to setup provisioning.  </li>
<li>Identity Providers who support Custom provisioning MUST inform Administrators who are configuring single sign-on with the application that SSO will not function until additional provisioning actions are taken. The Identity Provider MUST display a link, supplied by the Application Provider, to the documentation which describes the necessary actions for an Administrator to take. The documentation location is specified in the <samp>provisioning_documentation_uri</samp> within the Application Provider's <a href="#CommonInstanceMetadata" class="xref">Instance Metadata</a>.  </li>
</ul>
<p> </p>
</li>
<li><samp>NoProvisioning</samp></li>
<li>
<ul class="empty">
<li>Application Providers who use <samp>NoProvisioning</samp> MUST use ephemeral sessions or accounts that do not require pre-provisioning and do not rely upon long-lived data that persists after the user session has ended.  </li>
<li>Identity Providers who support <samp>NoProvisioning</samp> have no required responsibilities, but MAY inform Administrators who have finished configuring single sign-on with an application that no additional actions are necessary to use the application.  <br> An Identity Provider who includes <samp>NoProvisioning</samp> as the only value in their list of supported provisioning modes has effectively declared they support no user provisioning at all. This will cause the FastFed Handshake to halt when attempting to integrate with Application Providers who require one of the other provisioning modes.  </li>
</ul>
<p> </p>
</li>
</ul>
<p> </p>
</dd>
<dt>provider_authz_schemes_supported</dt>
<dd style="margin-left: 8">REQUIRED. A list of strings specifying the authorization schemes supported by the Provider. Valid values for this element include the following: <ul class="empty">
<li><samp>OAuth</samp></li>
<li>
<ul class="empty"><li>The Provider supports OAuth as defined in <a href="#ProviderAuthzOAuth" class="xref">Section 8.1</a> </li></ul>
<p> </p>
</li>
</ul>
<p> </p>
</dd>
</dl>

<p> </p>
<h1 id="rfc.section.4.3.2">
<a href="#rfc.section.4.3.2">4.3.2.</a> <a href="#CommonProviderMetadata" id="CommonProviderMetadata">Common Provider Metadata</a>
</h1>
<p id="rfc.section.4.3.2.p.1">Common Provider Metadata describes properties that are shared by both Identity Providers and Application Providers.  </p>
<p id="rfc.section.4.3.2.p.2">Common Provider Metadata is a structure with the following values: </p>

<dl>
<dt>provider_uri</dt>
<dd style="margin-left: 8">REQUIRED. A Uniform Resource Identifier <a href="#RFC3986" class="xref">[RFC3986]</a> which uniquely identifies a Provider. Typically used as the primary key for programmatic use cases that require storing and retrieving Provider information.  </dd>
<dt>name</dt>
<dd style="margin-left: 8">REQUIRED. The name of the Provider, suitable for display to end-users. The value SHOULD be the primary textual label by which this Provider is normally displayed when presenting it to end-users. If desired, representation of this value in different languages and scripts is represented as described in <a href="#MetadataLanguages" class="xref">Section 4.2</a>.  </dd>
<dt>icons</dt>
<dd style="margin-left: 8">OPTIONAL. A structure containing URLs that reference an icon for the Provider. The values must point to a valid image file. If defined, these image specifications supercede any overlapping image specification contained in the configuration metadata for underlying protocols referenced by the FastFed Metadata; e.g. the <samp>logo_uri</samp> defined in <a href="#OpenID.Registration" class="xref">OpenID Connect Dynamic Client Registration 1.0</a> [OpenID.Registration] <br><br> This structure has the following attributes: <dl>
<dt>large_icon_uri</dt>
<dd style="margin-left: 8">A URL that points to an image file that can be used as a tile in grid layouts or similar situations in which a larger icon delivers a preferable end-user experience. Image dimensions MUST NOT be smaller than 128x128 pixels and MUST NOT exceed 256x256 pixels. Images files SHOULD be in PNG format, but Providers MAY accept alternative formats. Providers who consume and display the image MAY resize the image to a smaller dimension and/or convert to alternative formats.  <br> If desired, representation of this value in different languages and scripts is represented as described in <a href="#MetadataLanguages" class="xref">Section 4.2</a>.  </dd>
<dt>small_icon_uri</dt>
<dd style="margin-left: 8">A URL that points to an image file for use in list layouts, as a favicon, or similar situations in which a small icon delivers a preferable end-user experience. Image dimensions MUST NOT be smaller than 16x16 pixels and MUST NOT exceed 32x32 pixels. Images files SHOULD be in PNG format, but Providers MAY accept alternative formats. Providers who consume and display the image MAY resize the image to a smaller dimension and/or convert to alternative formats.  <br> If desired, representation of this value in different languages and scripts is represented as described in <a href="#MetadataLanguages" class="xref">Section 4.2</a>.  </dd>
</dl>
<p> </p>
</dd>
<dt>capabilities</dt>
<dd style="margin-left: 8">REQUIRED. A structure describing the capabilities of the Provider, defined in <a href="#ProviderMetadataCapabilities" class="xref">Section 4.3.1</a>.  </dd>
</dl>

<p> </p>
<h1 id="rfc.section.4.3.3">
<a href="#rfc.section.4.3.3">4.3.3.</a> <a href="#IdentityProviderMetadata" id="IdentityProviderMetadata">Identity Provider Metadata</a>
</h1>
<p id="rfc.section.4.3.3.p.1">Identity Provider Metadata is a structure that includes all the elements defined in <a href="#CommonProviderMetadata" class="xref">Common Provider Metadata</a>, plus the following additional elements: </p>

<dl>
<dt>fastfed_handshake_start_uri</dt>
<dd style="margin-left: 8">REQUIRED. A URL which specifies the endpoint for starting a FastFed Handshake request with the Identity Provider. See <a href="#HandshakeIdentityProviderRequest" class="xref">Section 7.2.1.1</a>.  </dd>
<dt>fastfed_handshake_finish_uri</dt>
<dd style="margin-left: 8">REQUIRED. A URL which specifies the endpoint for finishing a FastFed Handshake with the Identity Provider. See <a href="#HandshakeApplicationProviderResponse" class="xref">Section 7.2.2.8</a>.  </dd>
</dl>

<p> </p>
<h1 id="rfc.section.4.3.4">
<a href="#rfc.section.4.3.4">4.3.4.</a> <a href="#ApplicationProviderMetadata" id="ApplicationProviderMetadata">Application Provider Metadata</a>
</h1>
<p id="rfc.section.4.3.4.p.1">Application Provider Metadata is a structure that includes all the elements defined in <a href="#CommonProviderMetadata" class="xref">Common Provider Metadata</a>, plus the following additional elements: </p>

<dl>
<dt>fastfed_handshake_receive_uri</dt>
<dd style="margin-left: 8">REQUIRED. A URL which specifies the endpoint for Application Providers to receive a FastFed Handshake request from an Identity Provider. See <a href="#HandshakeIdentityProviderResponse" class="xref">Section 7.2.1.7</a>.  </dd>
</dl>

<p> </p>
<h1 id="rfc.section.4.4">
<a href="#rfc.section.4.4">4.4.</a> <a href="#InstanceMetadata" id="InstanceMetadata">Instance Metadata</a>
</h1>
<p id="rfc.section.4.4.p.1">Instance Metadata represents the specific capabilities chosen by a Provider to use when establishing a federation relationship with another Provider.  </p>
<p id="rfc.section.4.4.p.2">Instance Metadata is a structure with the following top-level attributes: </p>

<dl>
<dt>identity_provider_instance</dt>
<dd style="margin-left: 8">OPTIONAL. A structure containing the attributes defined in <a href="#IdentityProviderInstanceMetadata" class="xref">Identity Provider Instance Metadata</a>. The existence of this element indicates the entity is acting as an Identity Provider in the federation relationship.  </dd>
<dt>application_provider_instance</dt>
<dd style="margin-left: 8">OPTIONAL. A structure containing the attributes defined in <a href="#ApplicationProviderInstanceMetadata" class="xref">Application Provider Instance Metadata</a>. The existence of this element indicates the entity is acting as an Application Provider in the federation relationship.  </dd>
</dl>

<p> </p>
<p id="rfc.section.4.4.p.3">A Provider MUST include one of either the <samp>identity_provider</samp> or <samp>application_provider</samp> elements, corresponding to the role it is playing in the federation relationship. A Provider MUST NOT include both elements.  </p>
<h1 id="rfc.section.4.4.1">
<a href="#rfc.section.4.4.1">4.4.1.</a> <a href="#CommonInstanceMetadata" id="CommonInstanceMetadata">Common Instance Metadata</a>
</h1>
<p id="rfc.section.4.4.1.p.1">Common Instance Metadata describes properties that are shared by both Identity Providers and Application Providers.  </p>
<p id="rfc.section.4.4.1.p.2">Common Instance Metadata contains the following values: </p>

<dl>
<dt>name</dt>
<dd style="margin-left: 8">OPTIONAL. If specified, this element overrides at an instance-level the name defined in the <a href="#CommonProviderMetadata" class="xref">Provider Metadata</a>.  </dd>
<dt>icons</dt>
<dd style="margin-left: 8">OPTIONAL. If specified, this element overrides at an instance-level the icons defined in the <a href="#CommonProviderMetadata" class="xref">Provider Metadata</a>.  If only a subset of icon structure members are specified in this override (e.g. <samp>large_icon_uri</samp>, but not <samp>small_icon_uri</samp>), any unspecified members retain the original definition defined at the Provider level.  </dd>
<dt>tenant_id</dt>
<dd style="margin-left: 8">REQUIRED. A string value which uniquely identifies the tenant of the Provider for whom the federation relationship is being configured. Used to detect duplicate attempts to create a federation relationship between a tenant in the Identity Provider and a tenant in the Application Provider.  <br> The combination of <samp>tenant_id</samp> plus <samp>provider_uri</samp> (defined in <a href="#ProviderMetadata" class="xref">Provider Metadata</a>) MUST be globally unique.  The <samp>tenant_id</samp> is case-sensitive and MAY be an opaque identifier.  </dd>
<dt>sso_protocol</dt>
<dd style="margin-left: 8">REQUIRED. A string value containing the SSO protocol to be used for sign-in between the Identity Provider and the Application Provider, chosen from the list of <samp>sso_protocols_supported</samp> defined in the <a href="#ProviderMetadataCapabilities" class="xref">Provider Capabilities</a>; e.g.  <samp>SAML</samp> or <samp>OIDC</samp>.  <br><br> Specific SSO protocols may extend the Instance Metadata with additional required attributes. See the requirements for specific SSO protocols in <a href="#MetadataExtensions" class="xref">Section 4.5</a>.  </dd>
<dt>user_schema</dt>
<dd style="margin-left: 8">REQUIRED. A string value containing the user schema to be used by the Identity Provider and Application Provider, chosen from the list of <samp>user_schemas_supported</samp> defined in the <a href="#ProviderMetadataCapabilities" class="xref">Provider Capabilities</a>; e.g.  <samp>["urn:ietf:params:scim:schemas:core:2.0:Schema"]</samp> </dd>
<dt>user_provisioning_mode</dt>
<dd style="margin-left: 8">REQUIRED. A string value containing the user provisioning mode to be used, chosen from the list of <samp>user_provisioning_modes_supported</samp> defined in the <a href="#ProviderMetadataCapabilities" class="xref">Provider Capabilities</a>; e.g. <samp>SCIM</samp>.  </dd>
<dt>provider_authz_scheme</dt>
<dd style="margin-left: 8">REQUIRED. A string value containing the authorization scheme to be used for communication between the Identity Provider and Application Provider, chosen from the list of <samp>provider_authz_schemes_supported</samp> defined in the <a href="#ProviderMetadataCapabilities" class="xref">Provider Capabilities</a>; e.g. <samp>OAuth</samp>.  <br><br> Specific authorization schemes may extend the Instance Metadata with additional required attributes. See the requirements for specific schemes in <a href="#ProviderAuthz" class="xref">Section 8</a>.  </dd>
</dl>

<p> </p>
<h1 id="rfc.section.4.4.2">
<a href="#rfc.section.4.4.2">4.4.2.</a> <a href="#IdentityProviderInstanceMetadata" id="IdentityProviderInstanceMetadata">Identity Provider Instance Metadata</a>
</h1>
<p id="rfc.section.4.4.2.p.1">Identity Provider Instance Metadata is a structure that includes all the elements defined in <a href="#CommonInstanceMetadata" class="xref">Common Instance Metadata</a>.  </p>
<p id="rfc.section.4.4.2.p.2">No additional elements are added to the Identity Provider Metadata.  </p>
<h1 id="rfc.section.4.4.3">
<a href="#rfc.section.4.4.3">4.4.3.</a> <a href="#ApplicationProviderInstanceMetadata" id="ApplicationProviderInstanceMetadata">Application Provider Instance Metadata</a>
</h1>
<p id="rfc.section.4.4.3.p.1">Application Provider Instance Metadata is a structure that includes all the elements defined in <a href="#CommonInstanceMetadata" class="xref">Common Instance Metadata</a>, plus the following attributes: </p>

<dl>
<dt>desired_user_attributes</dt>
<dd style="margin-left: 8">REQUIRED. A structure describing the end-user attributes that the Application Provider desires from the Identity Provider. During the FastFed Handshake, Administrators have an opportunity to review and consent to the release of the desired attributes.  <br><br> Attributes MUST be specified using the <a href="#AttributePath" class="xref">Attribute Path Syntax</a> for the chosen user schema. E.g., the Attribute Path for SCIM formatted name is <samp>name.formatted</samp>.  <br><br> The structure contains the following elements: <dl>
<dt>required_attributes</dt>
<dd style="margin-left: 8">A list of attributes, identified by their Attribute Paths, which the Identity Provider MUST release to the Application Provider.  </dd>
<dt>optional_attributes</dt>
<dd style="margin-left: 8">A list of attributes, identified by their Attribute Paths, which the Identity Provider MAY release to the Application Provider. The application MUST remain functional if the Identity Provider chooses not to release the <samp>optional_attributes</samp>, albeit with minor degradations in user experience; e.g. falling back to labeling end-users with an opaque <samp>userName</samp> instead of a human-readable <samp>displayName</samp>.  </dd>
</dl>
<p> </p>
</dd>
<dt>user_attribute_mapping</dt>
<dd style="margin-left: 8">OPTIONAL. A structure of type <a href="#AttributeMapping" class="xref">Attribute Mapping</a>. While this value is optional, it is REQUIRED to map user attributes from a user schema into the format of the chosen SSO protocol. If not specified, no user attributes will be provided within the sign-on assertions.  <br> The syntax of the mapping must be applicable to the selected user schema and SSO protocol. See <a href="#SimpleScimToSaml" class="xref">Section 9.3.2.1</a> for mapping SCIM-to-SAML and <a href="#SimpleScimToOidc" class="xref">Section 9.3.2.2</a> for mapping SCIM-to-OIDC.  </dd>
<dt>provisioning_documentation_uri</dt>
<dd style="margin-left: 8">OPTIONAL, but REQUIRED for certain provisioning modes. See detailed specifications for each provisioning mode in <a href="#ProviderMetadataCapabilities" class="xref">Section 4.3.1</a> under the definition of <samp>user_provisioning_modes_supported</samp>.  </dd>
</dl>

<p> </p>
<h1 id="rfc.section.4.5">
<a href="#rfc.section.4.5">4.5.</a> <a href="#MetadataExtensions" id="MetadataExtensions">Metadata Extensions for Specific Protocols</a>
</h1>
<p id="rfc.section.4.5.p.1">This section describes the additional values to be specified in Metadata documents when using certain protocols.  </p>
<h1 id="rfc.section.4.5.1">
<a href="#rfc.section.4.5.1">4.5.1.</a> <a href="#MetadataSAMLExtensions" id="MetadataSAMLExtensions">Extensions for SAML SSO</a>
</h1>
<p id="rfc.section.4.5.1.p.1">When using the <samp>SAML</samp> SSO protocol, the <a href="#CommonInstanceMetadata" class="xref">Common Instance Metadata</a> structure is extended with the following attributes: </p>

<dl>
<dt>saml_metadata_uri</dt>
<dd style="margin-left: 8">REQUIRED when using SAML. Contains the URL location of a SAML Metadata document as specified in <a href="#SAMLInteroperability" class="xref">Section 11.2</a>.  <br><br> Both the Identity Provider and Application Provider will include this value in their Instance Metadata, since each publishes their own SAML metadata.  </dd>
</dl>

<p> </p>
<p>The following is a non-normative example showing a snippet of Instance Metadata for an Identity Provider using SAML: </p>
<pre>
 "identity_provider_instance": {
   "tenant_id": "k2lini4cj509ut09cj0jcjwee9gj0jeg",
   "sso_protocol": "SAML",
   "saml_metadata_uri": "https://tenant12345.example.com/saml-metadata.xml",
   ...
</pre>
<p>The following is a non-normative example showing a snippet of Instance Metadata for an Application Provider using SAML: </p>
<pre>
 "application_provider_instance": {
   "tenant_id": "3jp2c2JaQ2c52f5hrWC",
   "sso_protocol": "SAML",
   "saml_metadata_uri": "https://tenant56789.example.com/saml-metadata.xml",
   ...
</pre>
<h1 id="rfc.section.4.5.2">
<a href="#rfc.section.4.5.2">4.5.2.</a> <a href="#MetadataOIDCExtensions" id="MetadataOIDCExtensions">Extensions for OIDC SSO</a>
</h1>
<p id="rfc.section.4.5.2.p.1">When using the <samp>OIDC</samp> SSO protocol, the specifications in <a href="#OIDCInteroperability" class="xref">Section 11.1</a> require that both parties support <a href="#OpenID.Discovery" class="xref">OpenID Connect Discovery 1.0</a> [OpenID.Discovery] and <a href="#OpenID.Registration" class="xref">OpenID Connect Dynamic Client Registration 1.0</a> [OpenID.Registration]. These specifications require that an Identity Provider share the location of an OpenID Provider Configuration Endpoint.  </p>
<p id="rfc.section.4.5.2.p.2">This is accomplished by extending the <a href="#IdentityProviderInstanceMetadata" class="xref">Identity Provider Instance Metadata</a> structure with the following attributes: </p>

<dl>
<dt>oidc_configuration_uri</dt>
<dd style="margin-left: 8">REQUIRED when using OIDC. Contains the Issuer location for OpenID Provider Configuration Information, as specified in Section 4 of <a href="#OpenID.Discovery" class="xref">OpenID Connect Discovery 1.0</a> [OpenID.Discovery] </dd>
</dl>

<p> </p>
<p id="rfc.section.4.5.2.p.3">The following is a non-normative example showing a snippet of Instance Metadata for an Identity Provider using OIDC: </p>
<pre>
 "identity_provider_instance": {
   "tenant_id": "k2lini4cj509ut09cj0jcjwee9gj0jeg",
   "sso_protocol": "OIDC",
   "oidc_configuration_uri": "https://tenant12345.example.com/oidc-configuration",
   ...
</pre>
<h1 id="rfc.section.4.5.3">
<a href="#rfc.section.4.5.3">4.5.3.</a> <a href="#MetadataSCIMExtensions" id="MetadataSCIMExtensions">Extensions for SCIM Provisoning</a>
</h1>
<p id="rfc.section.4.5.3.p.1">When using the <samp>SCIM</samp> user provisioning mode, the Application Provider needs to share the location of their SCIM endpoint.  </p>
<p id="rfc.section.4.5.3.p.2">To enable this, the <a href="#ApplicationProviderInstanceMetadata" class="xref">Application Provider Instance Metadata</a> structure is extended with the following attributes: </p>

<dl>
<dt>scim_service_uri</dt>
<dd style="margin-left: 8">REQUIRED when using SCIM provisioning. A string value containing the URL for SCIM endpoint as specified in Section 3.2 of the <a href="#RFC7644" class="xref">SCIM Protocol</a> [RFC7644].  </dd>
</dl>

<p> </p>
<p id="rfc.section.4.5.3.p.3">The following is a non-normative example showing a snippet of Instance Metadata for an Application Provider using SCIM provisioning: </p>
<pre>
 "application_provider_instance": {
   "tenant_id": "3jp2c2JaQ2c52f5hrWC",
   "sso_protocol": "SAML",
   "saml_metadata_uri": "https://tenant56789.example.com/saml-metadata.xml",
   "user_provisioning_mode": "SCIM",
   "scim_service_uri": "https://tenant56789.examole.com/scim"
   ...
</pre>
<h1 id="rfc.section.5">
<a href="#rfc.section.5">5.</a> <a href="#MetadataEndpoints" id="MetadataEndpoints">Metadata Endpoints</a>
</h1>
<p id="rfc.section.5.p.1">Metadata Endpoints describe the semantics for reading the Metadata documents.  </p>
<h1 id="rfc.section.5.1">
<a href="#rfc.section.5.1">5.1.</a> <a href="#ProviderMetadataEndpoint" id="ProviderMetadataEndpoint">Provider Metadata Endpoint</a>
</h1>
<p id="rfc.section.5.1.p.1">A request to this endpoint will return the Provider Metadata document defined in <a href="#ProviderMetadata" class="xref">Section 4.3</a>.  </p>
<p id="rfc.section.5.1.p.2">The Provider Metadata Endpoint MUST be accessible to other Providers who are permitted to initiate a FastFed Handhake Flow with the entity.  Access to the Endpoint SHOULD NOT require Administrators to perform preconfiguration or preregistration of any form between the two Providers, except the necessary act of inputting the URL for the Provider Metadata Endpoint (a.k.a. "FastFed URL") to initiate the FastFed Handshake. Requests to the endpoint may be rate-limited or otherwise limited to prevent a denial-of-service attack.  </p>
<h1 id="rfc.section.5.1.1">
<a href="#rfc.section.5.1.1">5.1.1.</a> <a href="#ProviderMetadataEndpointLocation" id="ProviderMetadataEndpointLocation">Location</a>
</h1>
<p id="rfc.section.5.1.1.p.1">The means of discovering the location of a Provider Metadata Endpoint for a specific Provider is out of scope of this specification.  </p>
<p id="rfc.section.5.1.1.p.2">As a reference to implementers, Providers typically include their Provider Metadata Endpoint (a.k.a. "FastFed URL") in their SSO documentation materials. Providers may also construct predefined catalogs of common integration partners with whom federations can be instantiated, where the FastFed URLs of the partners are part of the catalog.  </p>
<h1 id="rfc.section.5.1.2">
<a href="#rfc.section.5.1.2">5.1.2.</a> <a href="#ProviderMetadataEndpointRead" id="ProviderMetadataEndpointRead">Read Request</a>
</h1>
<p id="rfc.section.5.1.2.p.1">Provider Metadata can be read by making an HTTP GET request to the Provider Metadata Endpoint.  </p>
<p id="rfc.section.5.1.2.p.2">The following is a non-normative example read request: </p>
<pre>
  GET /fastfed/provider-metadata HTTP/1.1
  Accept: application/json
  Host: provider.example.com
</pre>
<h1 id="rfc.section.5.1.3">
<a href="#rfc.section.5.1.3">5.1.3.</a> <a href="#ProviderMetadataEndpointResponse" id="ProviderMetadataEndpointResponse">Read Response</a>
</h1>
<p id="rfc.section.5.1.3.p.1">Upon a successful read operation, the server SHOULD return all available Provider Metadata.  </p>
<p id="rfc.section.5.1.3.p.2">A successful response SHOULD use the HTTP 200 OK status code and return a JSON document <a href="#RFC4627" class="xref">[RFC4627]</a> using the application/json_content type with the Provider Metadata values as top-level members of the root JSON object.  </p>
<p id="rfc.section.5.1.3.p.3">The following is a non-normative example read response (with line wraps within values for display purposes only): </p>
<pre>
 HTTP/1.1 200 OK
 Content-Type: application/json
 {
   "identity_provider": {
     "provider_uri": "https://app.example.com",
     "name": "My Identity Provider",
     "icons": {
       "large_icon_uri": "https://idp.example.com/images/tile.png",
       "small_icon_uri": "https://idp.example.com/images/favicon.png"
     }
     capabilities: {
       "sso_protocols_supported": ["OIDC","SAML"],
       "user_schemas_supported": ["urn:ietf:params:scim:schemas:core:2.0:User"],
       "user_provisioning_modes_supported": ["JIT","Custom","NoProvisioning"],
       "provider_authz_schemes_supported": ["OAuth"]
     }
     "fastfed_handshake_start_uri": "https://idp.example.com/fastfed/start",
     "fastfed_handshake_finish_uri": "https://idp.example.com/fastfed/finish"
 } 
</pre>
<h1 id="rfc.section.5.2">
<a href="#rfc.section.5.2">5.2.</a> <a href="#InstanceMetadataEndpoint" id="InstanceMetadataEndpoint">Instance Metadata Endpoint</a>
</h1>
<p id="rfc.section.5.2.p.1">A request to this endpoint will return the Instance Metadata document defined in <a href="#InstanceMetadata" class="xref">Section 4.4</a>: </p>
<p id="rfc.section.5.2.p.2">If client authorization is required as per <a href="#ProviderAuthz" class="xref">Section 8</a>, the caller MUST use one of the authorization methods supported by the Provider when requesting Instance Metadata.  </p>
<h1 id="rfc.section.5.2.1">
<a href="#rfc.section.5.2.1">5.2.1.</a> <a href="#InstanceMetadataEndpointLocation" id="InstanceMetadataEndpointLocation">Location</a>
</h1>
<p id="rfc.section.5.2.1.p.1">The location of the Instance Metadata Endpoint is shared with Providers during the FastFed Handshake, as part of the request parameters. See <a href="#HandshakeIdentityProviderResponse" class="xref">7.2.1.7</a> and <a href="#HandshakeApplicationProviderResponse" class="xref">7.2.2.8</a>.  </p>
<h1 id="rfc.section.5.2.2">
<a href="#rfc.section.5.2.2">5.2.2.</a> <a href="#InstanceMetadataEndpointRead" id="InstanceMetadataEndpointRead">Read Request</a>
</h1>
<p id="rfc.section.5.2.2.p.1">Instance Metadata can be read by making an HTTP GET request to the Instance Metadata Endpoint.  The following is a non-normative example read request: </p>
<pre>
  GET /tenant12345/instance-metadata HTTP/1.1
  Accept: application/json
  Host: provider.example.com
</pre>
<h1 id="rfc.section.5.2.3">
<a href="#rfc.section.5.2.3">5.2.3.</a> <a href="#InstanceMetadataResponse" id="InstanceMetadataResponse">Read Response</a>
</h1>
<p id="rfc.section.5.2.3.p.1">Upon a successful read operation, the server SHOULD return all available Instance Metadata.  </p>
<p id="rfc.section.5.2.3.p.2">A successful response SHOULD use the HTTP 200 OK status code and return a JSON document [RFC4627] using the application/json_content type with the Provider Metadata values as top-level members of the root JSON object.  </p>
<p id="rfc.section.5.2.3.p.3">The following is a non-normative example read response (with line wraps within values for display purposes only): </p>
<pre>
 HTTP/1.1 200 OK
 Content-Type: application/json
 {
   "identity_provider_instance": {
     "tenant_id": "k2lini4cj509ut09cj0jcjwee9gj0jeg",
     "sso_protocol": "SAML",
     "saml_metadata_uri": "https://tenant12345.example.com/saml-metadata.xml",
     "user_schema": "urn:ietf:params:scim:schemas:core:2.0:User",
     "user_provisioning_mode": "JIT",
     "provider_authz_scheme": "OAuth",
     "oauth_token_endpoint": "https://tenant12345.example.com/token",
 } 
</pre>
<h1 id="rfc.section.5.2.4">
<a href="#rfc.section.5.2.4">5.2.4.</a> <a href="#InstanceMetadataErrorResponse" id="InstanceMetadataErrorResponse">Read Error Response</a>
</h1>
<p id="rfc.section.5.2.4.p.1">If authorization was required by the server and caller authorization was missing or invalid, the server MUST respond with the HTTP 401 Unauthorized status code. If the client does not have permission to read the record, the server MUST return an HTTP 403 Forbidden.  </p>
<p id="rfc.section.5.2.4.p.2">The following is a non-normative example error response: </p>
<pre>
  HTTP/1.1 401 Unauthorized
  WWW-Authenticate: Bearer error="invalid_token",
    error_description="The access token expired"
  Cache-Control: no-store
  Pragma: no-cache
</pre>
<h1 id="rfc.section.6">
<a href="#rfc.section.6">6.</a> <a href="#ProviderCompatibilityEvaluation" id="ProviderCompatibilityEvaluation">Provider Compatibility Evaluation</a>
</h1>
<p id="rfc.section.6.p.1">A compatibility evaluation is the act of comparing the abilities of two Providers to determine if they can interoperate. For FastFed, this is accomplished by examining the intersection of <a href="#ProviderMetadataCapabilities" class="xref">Provider Capabilities</a>. The process is specified below.  </p>
<p id="rfc.section.6.p.2">For reference, all FastFed Capabilities are represented as lists of strings. This includes the following attributes: </p>

<ul>
<li>sso_protocols_supported</li>
<li>user_schemas_supported</li>
<li>user_provisioning_modes_supported</li>
<li>provider_authz_schemes_supported</li>
</ul>

<p> </p>
<p id="rfc.section.6.p.3">Each list is evaluated for compatibility via the following steps: </p>

<ul>
<li>Missing or undefined lists MUST be treated as empty lists.  </li>
<li>If both Providers have empty lists for an element, they are compatible for that element.  </li>
<li>If at least one Provider has a non-empty list, the intersection is calculated between the list from the Identity Provider and the list from the Application Provider. If the intersection is non-empty, the Providers are compatible for that element.  </li>
<li>The resulting intersection of capabilities represents the compatible choices which a Provider can choose from when determining how to configure federation with another Provider.  </li>
</ul>

<p> </p>
<p id="rfc.section.6.p.4">If the Providers are incompatible for at least one list, then the Providers MUST be treated as incompatible.  </p>
<h1 id="rfc.section.7">
<a href="#rfc.section.7">7.</a> <a href="#Handshake" id="Handshake">FastFed Handshake</a>
</h1>
<h1 id="rfc.section.7.1">
<a href="#rfc.section.7.1">7.1.</a> <a href="#HandshakeCommon" id="HandshakeCommon">Common Considerations</a>
</h1>
<h1 id="rfc.section.7.1.1">
<a href="#rfc.section.7.1.1">7.1.1.</a> <a href="#HanshakeTLSRequirements" id="HanshakeTLSRequirements">TLS Requirments</a>
</h1>
<p id="rfc.section.7.1.1.p.1">The FastFed Handshake can include the exchange of secret materials and private tenant information. All implementations MUST require the use of TLS for all FastFed Endpoints, including the Metadata Endpoints and FastFed Handshake Endpoints. If an underlying protocol also exposes their own endpoints (e.g. SAML Metadata Files), those endpoints SHOULD use TLS, too.  </p>
<p id="rfc.section.7.1.1.p.2">Which TLS version(s) ought to be implemented will vary over time, and depends on the widespread deployment and known security vulnerabilities at the time of implementation. To protect against information disclosure and tampering, confidentiality protection MUST be applied using TLS with a ciphersuite that provides confidentiality and integrity protection.  </p>
<p id="rfc.section.7.1.1.p.3">Whenever TLS is used, a TLS server certificate check MUST be performed, per <a href="#RFC6125" class="xref">[RFC6125]</a>.  </p>
<h1 id="rfc.section.7.1.2">
<a href="#rfc.section.7.1.2">7.1.2.</a> <a href="#HandshakeHTTPRedirects" id="HandshakeHTTPRedirects">HTTP Redirects</a>
</h1>
<p id="rfc.section.7.1.2.p.1">This specification makes use of HTTP redirections, in which a Provider directs the Administrator's user-agent to another destination.  While the examples in this specification show the use of the HTTP 302 status code, any other method available via the user-agent to accomplish this redirection is allowed and is considered to be an implementation detail.  </p>
<h1 id="rfc.section.7.1.3">
<a href="#rfc.section.7.1.3">7.1.3.</a> <a href="#HandshakeSerialization" id="HandshakeSerialization">Serialization</a>
</h1>
<p id="rfc.section.7.1.3.p.1">The FastFed Handshake uses HTTP GET and POST to transmit requests. Request parameters may be serialized using the following methods: </p>

<ul>
<li>Query String Serialization</li>
<li>Form Serialization</li>
</ul>

<p> </p>
<h1 id="rfc.section.7.1.3.1">
<a href="#rfc.section.7.1.3.1">7.1.3.1.</a> <a href="#HandshakeQueryStringSerialization" id="HandshakeQueryStringSerialization">Query String Serialization</a>
</h1>
<p id="rfc.section.7.1.3.1.p.1">In order to serialize the parameters using the Query String Serialization, the Client constructs the string by adding the parameters and values to the query component of a URL using the application/x-www-form-urlencoded format as defined by <a href="#W3C.REC-html401-19991224" class="xref">[W3C.REC-html401-19991224]</a>. Query String Serialization is typically used in HTTP GET requests. The same serialization method is also used when adding parameters to the fragment component of a URL.  </p>
<h1 id="rfc.section.7.1.3.2">
<a href="#rfc.section.7.1.3.2">7.1.3.2.</a> <a href="#HandshakeFormSerialization" id="HandshakeFormSerialization">Form Serialization</a>
</h1>
<p id="rfc.section.7.1.3.2.p.1">Parameters and their values are Form Serialized by adding the parameter names and values to the entity body of the HTTP request using the application/x-www-form-urlencoded format as defined by <a href="#W3C.REC-html401-19991224" class="xref">[W3C.REC-html401-19991224]</a>. Form Serialization is typically used in HTTP POST requests.  </p>
<h1 id="rfc.section.7.1.4">
<a href="#rfc.section.7.1.4">7.1.4.</a> <a href="#HandshakeHalt" id="HandshakeHalt">Halting the Handshake</a>
</h1>
<p id="rfc.section.7.1.4.p.1">In certain circumstances, the FastFed Handshake cannot proceed and must be halted. This may occur, for example, if the Providers do not share common capabilities.  </p>
<p id="rfc.section.7.1.4.p.2">When halting the handshake, the Provider who decides to halt SHOULD display an informative message to the Administrator explaining why the action was halted and any steps that can be taken by the Administrator to correct the situation. The details of this communication to the Administrator are outside the scope of the specification.  </p>
<h1 id="rfc.section.7.2">
<a href="#rfc.section.7.2">7.2.</a> <a href="#HandshakeFlow" id="HandshakeFlow">Handshake Flow</a>
</h1>
<h1 id="rfc.section.7.2.1">
<a href="#rfc.section.7.2.1">7.2.1.</a> <a href="#HandshakeStart" id="HandshakeStart">Handshake Start at Identity Provider</a>
</h1>
<h1 id="rfc.section.7.2.1.1">
<a href="#rfc.section.7.2.1.1">7.2.1.1.</a> <a href="#HandshakeIdentityProviderRequest" id="HandshakeIdentityProviderRequest">Identity Provider Receives Start Request</a>
</h1>
<p id="rfc.section.7.2.1.1.p.1">The FastFed Handshake begins by sending an HTTP GET or POST to the Identity Provider's <samp>fastfed_handshake_start_uri</samp>, as defined within the Identity Provider Metadata per <a href="#IdentityProviderMetadata" class="xref">Section 4.3.3</a>.  </p>
<p id="rfc.section.7.2.1.1.p.2">The request contains the following parameters: </p>

<dl>
<dt>provider_metadata_uri</dt>
<dd style="margin-left: 8">REQUIRED. The URL of the <a href="#ProviderMetadataEndpoint" class="xref">Provider Metadata Endpoint</a> for the Application Provider with whom the handshake will be performed.  </dd>
</dl>

<p> </p>
<p id="rfc.section.7.2.1.1.p.3">Identity Providers MUST support the use of HTTP GET and POST.  Clients MAY use the HTTP GET or POST methods.  </p>
<p id="rfc.section.7.2.1.1.p.4">If using the HTTP GET method, the request parameters are serialized using <a href="#HandshakeQueryStringSerialization" class="xref">URI Query String Serialization</a>.  If using the HTTP POST method, the request parameters are serialized using <a href="#HandshakeFormSerialization" class="xref">Form Serialization</a>.  </p>
<p id="rfc.section.7.2.1.1.p.5">Any entity may initiate the FastFed Handshake. As a reference to implementers, an Identity Provider can initiate the handshake by sending a message to itself, using the <samp>fastfed_handshake_start_uri</samp> that is already known to the Identity Provider. Alternatively, an Application Provider can initiate the handshake by asking an Administrator for the FastFed URL of an Identity Provider and then querying the URL to retrieve the <a href="#IdentityProviderMetadata" class="xref">Identity Provider Metadata</a> document which contains the <samp>fastfed_handshake_start_uri</samp>.  </p>
<p id="rfc.section.7.2.1.1.p.6">The following is a non-normative example of a handshake initiation request using HTTP POST </p>
<pre>
 POST /fastfed/handshake/start
 Host: idp.example.com
 Content-Type: application/x-www-form-urlencoded
   
 provider_metadata_uri=https%3A%2F%2Fapp.example.com%2Ffastfed%2Fprovider-metadata
</pre>
<p id="rfc.section.7.2.1.1.p.7">The following is a non-normative example of a handshake initiation request using HTTP GET.  </p>
<pre>
 GET /fastfed/handshake/start?provider_metadata_uri=https%3A%2F%2Fapp.example.com%2Ffastfed%2Fprovider-metadata HTTP/1.1
 Host: idp.example.com
</pre>
<h1 id="rfc.section.7.2.1.2">
<a href="#rfc.section.7.2.1.2">7.2.1.2.</a> <a href="#HandshakeIdentityProviderAuthenticatesAdministrator" id="HandshakeIdentityProviderAuthenticatesAdministrator">Identity Provider Authenticates Administrator</a>
</h1>
<p id="rfc.section.7.2.1.2.p.1">Upon receiving the handshake initiation request, the Identity Provider MUST authenticate the Administrator and verify they are authorized to initiate the FastFed Handshake with the Application. The means of doing so are outside the scope of this specification.  </p>
<p id="rfc.section.7.2.1.2.p.2">If the Administrator cannot be authenticated, the FastFed Handshake MUST be halted.  </p>
<h1 id="rfc.section.7.2.1.3">
<a href="#rfc.section.7.2.1.3">7.2.1.3.</a> <a href="#HandshakeIdentityProviderReadsApplicationProviderMetadata" id="HandshakeIdentityProviderReadsApplicationProviderMetadata">Identity Provider Reads Application Provider Metadata</a>
</h1>
<p id="rfc.section.7.2.1.3.p.1">Using the <samp>provider_metadata_uri</samp> sent as a parameter in the handshake request, the Identity Provider queries the <a href="#ProviderMetadataEndpoint" class="xref">Application Provider Metadata Endpoint</a>.  </p>
<p id="rfc.section.7.2.1.3.p.2">If the Application Provider Metadata cannot be downloaded or is missing required elements, the FastFed Handshake MUST be halted.  </p>
<h1 id="rfc.section.7.2.1.4">
<a href="#rfc.section.7.2.1.4">7.2.1.4.</a> <a href="#HandshakeIdentityProviderVerifiesCompatibilityWithApplicationProvider" id="HandshakeIdentityProviderVerifiesCompatibilityWithApplicationProvider">Identity Provider Verifies Compatibility with Application Provider</a>
</h1>
<p id="rfc.section.7.2.1.4.p.1">The Identity Provider MUST compare its Provider Metadata against the Application Provider Metadata in order to verify compatibility, as described in <a href="#ProviderCompatibilityEvaluation" class="xref">Section 6</a>.  </p>
<p id="rfc.section.7.2.1.4.p.2">If the Providers are incompatible, the FastFed Handshake MUST be halted.  </p>
<h1 id="rfc.section.7.2.1.5">
<a href="#rfc.section.7.2.1.5">7.2.1.5.</a> <a href="#HandshakeIdentityProviderObtainsInitialConsentFromAdministrator" id="HandshakeIdentityProviderObtainsInitialConsentFromAdministrator">Identity Provider Obtains Initial Consent from Administrator</a>
</h1>
<p id="rfc.section.7.2.1.5.p.1">The Identity Provider MUST obtain explicit consent from an Administrator to share tenant information with the Application Provider, unless the Administrator has previously consented or the Identity Provider and Application Provider are hosted by the same party.  </p>
<p id="rfc.section.7.2.1.5.p.2">As a reference to implementers, consent could include displaying a confirmation page. The Identity Provider may also alert the Administrator of any potential risks with the Application Provider, including but not limited to invalid TLS certificates detected when querying Application Provider Endpoints, or matches against suspected phishing sites.  </p>
<h1 id="rfc.section.7.2.1.6">
<a href="#rfc.section.7.2.1.6">7.2.1.6.</a> <a href="#HandshakeIdentityProviderGeneratesInstanceMetadata" id="HandshakeIdentityProviderGeneratesInstanceMetadata">Identity Provider Generates Instance Metadata</a>
</h1>
<p id="rfc.section.7.2.1.6.p.1">The Identity Provider generates, or makes available, an Instance Metadata Endpoint containing the specific configuration and preferences for establishing a federated relationship with the Application Provider.  </p>
<p id="rfc.section.7.2.1.6.p.2">The chosen preferences MUST be valid Capabilities for both the Identity Provider and Application Provider; e.g. if both Providers support the <samp>SAML</samp> SSO protocol, then <samp>SAML</samp> is a valid choice for SSO protocol. On the other hand, if one or both Providers do not support <samp>SAML</samp>, it is not a valid choice.  </p>
<p id="rfc.section.7.2.1.6.p.3">It is possible for Providers to share multiple valid options for a Capability; e.g. both Providers may support <samp>SAML</samp> and <samp>OIDC</samp> as SSO protocols. If this occurs, the Identity Provider MUST choose one of the capabilities to use. The manner of determining a choice is considered an implementation detail and is outside the scope of the specification.  </p>
<p id="rfc.section.7.2.1.6.p.4">One of the preferences that can be chosen by the Identity Provider is the <samp>provider_authz_schemes_supported</samp>.  When the Identity Provider chooses an authorization scheme, it will be used for any interactions between Providers which mandate authorization. The chosen scheme is communicated in two ways: within the Instance Metadata, and also as a parameter in the handshake message to the Application Provider. Both values MUST be the same. The authorization details depend upon the chosen scheme and are described in <a href="#ProviderAuthz" class="xref">Section 8</a> </p>
<p id="rfc.section.7.2.1.6.p.5">It is possible for an Instance Metadata document to already exist for the given Application Provider, either because this is a duplicate request or a previous handshake was halted or abandoned. If this occurs, the existing Instance Metadata MUST NOT be altered. Doing so could cause inadvertently cause an existing federation relationship to be modified before the Administrator has consented to changes. Instead, a new Instance Metadata Endpoint MUST be instantiated at a new location.  </p>
<h1 id="rfc.section.7.2.1.7">
<a href="#rfc.section.7.2.1.7">7.2.1.7.</a> <a href="#HandshakeIdentityProviderResponse" id="HandshakeIdentityProviderResponse">Identity Provider Response</a>
</h1>
<p><strong>COMMENTS: </strong> <a id="CREF1" class="info">[CREF1]<span class="info">Darin McAdams: Want to discuss the security model with the group. If we assume any data that traverses through the User Agent is potentially compromised, should the following parameters be encapsualted inside a JWE when transmitting them to the Application Provider? The public keys could be shared as JWK elements in the Provider Metadata files.  This question becomes even more important when adding OAuth grants into handshake in Section 7.  </span></a> <a id="CREF2" class="info">[CREF2]<span class="info">Darin McAdams: In addition, the names of these attributes should probably be shortened to encourage a compact representation. Leaving as-is for now until the security discussion gives more confidence on the mechanisms for exchanging this data.  </span></a> </p>
<p id="rfc.section.7.2.1.7.p.2">If the preceding steps were successful, the Identity Provider responds by issuing a redirect to the Application Provider containing the following parameters: </p>

<dl>
<dt>provider_metadata_uri</dt>
<dd style="margin-left: 8">REQUIRED. The location of the Provider Metadata for the Identity Provider </dd>
<dt>instance_metadata_uri</dt>
<dd style="margin-left: 8">REQUIRED. The location of the Instance Metadata for the Identity Provider, created in the preceeding Step <a href="#HandshakeIdentityProviderGeneratesInstanceMetadata" class="xref">7.2.1.6</a>.  </dd>
<dt>provider_authz_scheme</dt>
<dd style="margin-left: 8">OPTIONAL. The authorization scheme chosen by the Identity Provider and required for any subsequent interactions between the Providers which mandate authorization. Depending upon the chosen scheme, this request may contain additional parameters necessary to enable authorization. Details depend upon the chosen scheme and are described in <a href="#ProviderAuthz" class="xref">Section 8</a>.  </dd>
<dt>state</dt>
<dd style="margin-left: 8">OPTIONAL. Opaque value used to maintain state between the request to the Application Provider and the callback to the Identity Provider. Typically, Cross-Site Request Forgery (CSRF, XSRF) mitigation is done by cryptographically binding the value of this parameter with a browser cookie.  </dd>
</dl>

<p> </p>
<p id="rfc.section.7.2.1.7.p.3">The following is a non-normative example of a response (with line wraps within values for display purposes only): </p>
<pre>
 HTTP/1.1 302 Found
 Location: https://app.example.com/fastfed/handshake/receive?
   provider_metadata_uri=https%3A%2F%2Fidp.example.com%2Ffastfed%2Fprovider-metadata
   &amp;instance_metadata_uri=https%3A%2F%2Ftenant12345.example.com%2Ffastfed%2Finstance-metadata
   &amp;state=vk2j35ijlkt2j2oij3ti2jtkltkl2n4kl2n
</pre>
<h1 id="rfc.section.7.2.2">
<a href="#rfc.section.7.2.2">7.2.2.</a> <a href="#HandshakeReceiptByApplicationProvider" id="HandshakeReceiptByApplicationProvider">Handshake Receipt by Application Provider</a>
</h1>
<h1 id="rfc.section.7.2.2.1">
<a href="#rfc.section.7.2.2.1">7.2.2.1.</a> <a href="#HandshakeApplicationProviderAuthenticatesAdministrator" id="HandshakeApplicationProviderAuthenticatesAdministrator">Application Provider Authenticates Administrator</a>
</h1>
<p id="rfc.section.7.2.2.1.p.1">Upon receiving a handshake message from the Identity Provider as specified in Step <a href="#HandshakeIdentityProviderResponse" class="xref">7.2.1.7</a>, the Application Provider MUST authenticate the Administrator and verify they are authorized to setup federation with the Identity Provider.  </p>
<p id="rfc.section.7.2.2.1.p.2">If the Administrator is a new customer without an existing account with the Application Provider, the Application Provider MAY lead the administrator through a sign-up workflow to subscribe to the Application. The means of doing so are outside the scope of this specification.  </p>
<p id="rfc.section.7.2.2.1.p.3">If the Administrator cannot be authenticated, the FastFed Handshake MUST be halted.  </p>
<h1 id="rfc.section.7.2.2.2">
<a href="#rfc.section.7.2.2.2">7.2.2.2.</a> <a href="#HandshakeApplicationProviderReadsProviderMetadata" id="HandshakeApplicationProviderReadsProviderMetadata">Application Provider Reads Provider Metadata</a>
</h1>
<p id="rfc.section.7.2.2.2.p.1">Using the <samp>provider_metadata_uri</samp> sent as a parameter in the handshake request, the Application Provider queries the <a href="#ProviderMetadataEndpoint" class="xref">Identity Provider Metadata Endpoint</a>.  </p>
<p id="rfc.section.7.2.2.2.p.2">If the Identity Provider Metadata cannot be downloaded or is missing required elements, the FastFed Handshake must be halted.  </p>
<h1 id="rfc.section.7.2.2.3">
<a href="#rfc.section.7.2.2.3">7.2.2.3.</a> <a href="#HandshakeApplicationProviderReadsInstanceMetadata" id="HandshakeApplicationProviderReadsInstanceMetadata">Application Provider Reads Instance Metadata</a>
</h1>
<p id="rfc.section.7.2.2.3.p.1">Using the <samp>instance_metadata_uri</samp> sent as a parameter in the handshake request, the Application Provider queries the Identity Provider's <a href="#InstanceMetadataEndpoint" class="xref">Instance Metadata Endpoint</a>.  </p>
<p id="rfc.section.7.2.2.3.p.2">If the handshake request contains a parameter for <samp>provider_authz_scheme</samp>, the Application Provider MUST use the authorization scheme when retrieving the Instance Metadata.  </p>
<p id="rfc.section.7.2.2.3.p.3">If the Instance Metadata cannot be downloaded or is missing required elements, the FastFed Handshake must be halted.  </p>
<h1 id="rfc.section.7.2.2.4">
<a href="#rfc.section.7.2.2.4">7.2.2.4.</a> <a href="#HandshakeApplicationProviderVerifiesCompatibility" id="HandshakeApplicationProviderVerifiesCompatibility">Application Provider Verifies Compatibility</a>
</h1>
<p id="rfc.section.7.2.2.4.p.1">The Instance Metadata provided by the Identity Provider will contain configuration and preferences for establishing a federated relationship with the Application Provider.  </p>
<p id="rfc.section.7.2.2.4.p.2">The Application Provider MUST verify that the choices within the Instance Metadata are valid Capabilities for the Application Provider; e.g. if the Application Provider supports <samp>SAML</samp> as an SSO protocol, then <samp>SAML</samp> is a valid choice for SSO protocol. On the other hand, if the Application Provider does not support <samp>SAML</samp> as a Capability, it is not a valid choice.  </p>
<p id="rfc.section.7.2.2.4.p.3">The FastFed Handshake must be halted if the Instance Metadata contains unsupported Capabilities.  </p>
<h1 id="rfc.section.7.2.2.5">
<a href="#rfc.section.7.2.2.5">7.2.2.5.</a> <a href="#HandshakeApplicationProviderGeneratesInstanceMetadata" id="HandshakeApplicationProviderGeneratesInstanceMetadata">Application Provider Generates Instance Metadata</a>
</h1>
<p id="rfc.section.7.2.2.5.p.1">The Application Provider generates, or makes available, an Instance Metadata Endpoint containing the specific configuration and preferences for establishing a federated relationship with the Identity Provider.  </p>
<p id="rfc.section.7.2.2.5.p.2">The chosen Capabilities MUST match those received from the Identity Provider, plus any additional properties specific to the Application Provider; e.g. if the Identity Provider specified <samp>SAML</samp> as the SSO protocol in its Instance Metadata, the Application Provider MUST also specify <samp>SAML</samp>, and will include any SAML-specific configurations that are required of an Application Provider. The details vary by protocol and are described in <a href="#MetadataExtensions" class="xref">Section 4.5</a>.  </p>
<h1 id="rfc.section.7.2.2.6">
<a href="#rfc.section.7.2.2.6">7.2.2.6.</a> <a href="#HandshakeApplicationProviderObtainsConsent" id="HandshakeApplicationProviderObtainsConsent">Application Provider Obtains Consent from Administrator</a>
</h1>
<p id="rfc.section.7.2.2.6.p.1">The Application Provider MUST obtain explicit consent from an Administrator to enable federation with the Identity Provider. The Application Provider MUST include CSRF protections when obtaining consent.  </p>
<p id="rfc.section.7.2.2.6.p.2">If a federation relationship was previously configured between the tenant of the Identity Provider and the txsenant of the Application Provider, the Application Provider MUST alert the Administrator that proceeding will modify an existing federation configuration.  </p>
<p id="rfc.section.7.2.2.6.p.3">The details of warning the Administrator are out of scope of the specification. Implementers SHOULD consider highlighting any changes that may temporarily break end-users during the FastFed Handshake flow; e.g. if the SSO protocol is being changed from SAML to OIDC, incoming sign-in attempts may fail until the handshake completes and the new configuration has been successfully applied by both Providers </p>
<h1 id="rfc.section.7.2.2.7">
<a href="#rfc.section.7.2.2.7">7.2.2.7.</a> <a href="#HandshakeApplicationProviderEnablesFederation" id="HandshakeApplicationProviderEnablesFederation">Application Provider Enables Federation with the Identity Provider</a>
</h1>
<p id="rfc.section.7.2.2.7.p.1">Upon receiving consent from the Administrator, the Application Provider MUST take any actions necessary to enable federation with the Identity Provider. This is an implementation detail. Actions typically include updating internal datastore records to allow SSO from the Identity Provider, performing any additional registration activities required by the SSO protocol, and potentially opening up endpoints for user provisioning.  </p>
<p id="rfc.section.7.2.2.7.p.2">If an authorization scheme is used, the Identity Provider MUST be granted access to all operations on the Application Provider necessary for the federated relationship to become active.  </p>
<h1 id="rfc.section.7.2.2.8">
<a href="#rfc.section.7.2.2.8">7.2.2.8.</a> <a href="#HandshakeApplicationProviderResponse" id="HandshakeApplicationProviderResponse">Application Provider Response</a>
</h1>
<p id="rfc.section.7.2.2.8.p.1">If the preceding steps were successful, the Application Provider responds by issuing a redirect to the Identity Provider.  </p>
<p id="rfc.section.7.2.2.8.p.2">The location to send the response is specified by the <samp>fastfed_handshake_finish_uri</samp> attribute within the <a href="#IdentityProviderMetadata" class="xref">Identity Provider Metadata</a>.  </p>
<p id="rfc.section.7.2.2.8.p.3">The response contains the following parameters: </p>

<dl>
<dt>instance_metadata_uri</dt>
<dd style="margin-left: 8">REQUIRED. The location of the Instance Metadata for the Application Provider, created in the preceeding Step <a href="#HandshakeApplicationProviderGeneratesInstanceMetadata" class="xref">7.2.2.5</a>.  </dd>
<dt>authz_scheme</dt>
<dd style="margin-left: 8">REQUIRED if the handshake request from the Identity Provider included the authz_scheme parameter. Set to the value received from the Identity Provider.  </dd>
<dt>state</dt>
<dd style="margin-left: 8">REQUIRED if the handshake request from the Identity Provider included the <samp>state</samp> parameter. Set to the value received from the Identity Provider.  </dd>
</dl>

<p> </p>
<p id="rfc.section.7.2.2.8.p.4">If an authorization scheme is used, the response may contain additional authorization parameters. The details vary by scheme and are described in <a href="#ProviderAuthz" class="xref">Section 8</a>.  </p>
<p id="rfc.section.7.2.2.8.p.5">The following is a non-normative example of a response: </p>
<pre>
 HTTP/1.1 302 Found
 Location: https://idp.example.com/fastfed/handshake/finish?
   instance_metadata_uri=https%3A%2F%2Ftenant67890.example.com%2Ffastfed%2Finstance-metadata
   &amp;state=vk2j35ijlkt2j2oij3ti2jtkltkl2n4kl2
</pre>
<h1 id="rfc.section.7.2.3">
<a href="#rfc.section.7.2.3">7.2.3.</a> <a href="#HandshakeIdentityProviderCompletion" id="HandshakeIdentityProviderCompletion">Handshake Completion by Identity Provider</a>
</h1>
<h1 id="rfc.section.7.2.3.1">
<a href="#rfc.section.7.2.3.1">7.2.3.1.</a> <a href="#HandshakeIdentityProviderAuthenticatesStateParamater" id="HandshakeIdentityProviderAuthenticatesStateParamater">Identity Provider Authenticates State Paramater</a>
</h1>
<p id="rfc.section.7.2.3.1.p.1">If the Identity Provider included the <samp>state</samp> parameter when issuing the handshake request to the Application Provider, the Identity Provider MUST verify that the state parameter received in the response is equal to the value sent in the request.  </p>
<h1 id="rfc.section.7.2.3.2">
<a href="#rfc.section.7.2.3.2">7.2.3.2.</a> <a href="#HandshakeIdentityProviderReadsInstanceMetadata" id="HandshakeIdentityProviderReadsInstanceMetadata">Identity Provider Reads Instance Metadata</a>
</h1>
<p id="rfc.section.7.2.3.2.p.1">Using the <samp>instance_metadata_uri</samp> received as a parameter in handshake response, the Identity Provider queries the Application Provider Metadata Endpoint, as per <a href="#ProviderMetadataEndpoint" class="xref">Section 5.1</a>.  </p>
<p id="rfc.section.7.2.3.2.p.2">If the Identity Provider included the <samp>authz_scheme</samp> parameter in the handshake request, the Identity Provider MUST use the authorization scheme when retrieving the Instance Metadata from the Application Provider.  </p>
<p id="rfc.section.7.2.3.2.p.3">If the Instance Metadata cannot be downloaded or is missing required elements, the FastFed Handshake must be halted.  </p>
<h1 id="rfc.section.7.2.3.3">
<a href="#rfc.section.7.2.3.3">7.2.3.3.</a> <a href="#HandshakeIdentityProviderVerifiesCompatibilityWithInstanceMetadata" id="HandshakeIdentityProviderVerifiesCompatibilityWithInstanceMetadata">Identity Provider Verifies Compatibility with Instance Metadata</a>
</h1>
<p id="rfc.section.7.2.3.3.p.1">The Identity Provider MUST verify that the chosen Capabilities in the Instance Metadata vended by the Application Provider match those chosen by the Identity Provider; e.g. if the Identity Provider specified <samp>SAML</samp> as the SSO protocol in its Instance Metadata, the Application Provider MUST also specify <samp>SAML</samp>.  </p>
<h1 id="rfc.section.7.2.3.4">
<a href="#rfc.section.7.2.3.4">7.2.3.4.</a> <a href="#HandshakeIdentityProviderObtainsFinalConsentFromAdministrator" id="HandshakeIdentityProviderObtainsFinalConsentFromAdministrator">Identity Provider Obtains Final Consent from Administrator</a>
</h1>
<p id="rfc.section.7.2.3.4.p.1">The Identity Provider MUST obtain explicit consent from an Administrator to enable federation with the Application Provider.  </p>
<p id="rfc.section.7.2.3.4.p.2">Obtaining consent MUST include displaying the user attributes that will be released to the Application Provider, as specified in the <samp>desired_user_attributes</samp> declared by the Application Provider in their <a href="#ApplicationProviderInstanceMetadata" class="xref">Instance Metadata</a>. The user attributes SHOULD be displayed to Administrators in a human-readable format that can be easily understood.  </p>
<p id="rfc.section.7.2.3.4.p.3">The Identity Provider MUST include CSRF protections when obtaining consent.  </p>
<p id="rfc.section.7.2.3.4.p.4">If a federation relationship was previously configured between the tenant of the Identity Provider and the tenant of the Application Provider, then completing the handshake SHOULD update the preexisting federation configuration with the newly exchanged values. The Identity Provider SHOULD inform the Administrator of the changes that will be made to the previously defined configuration.  </p>
<h1 id="rfc.section.7.2.3.5">
<a href="#rfc.section.7.2.3.5">7.2.3.5.</a> <a href="#HandshakeIdentityProviderEnablesFederation" id="HandshakeIdentityProviderEnablesFederation">Identity Provider Enables Federation</a>
</h1>
<p id="rfc.section.7.2.3.5.p.1">Upon receiving consent from the Administrator, the Identity Provider MUST take any actions necessary to enable federation with the Application Provider. This is an implementation detail. Actions typically include updating internal datastore records to allow SSO to the Application Provider, and potentially initiating user provisioning.  </p>
<p id="rfc.section.7.2.3.5.p.2">If a provider authorization scheme is used, the Application Provider MUST now be granted access to all operations on the Identity Provider necessary for the federated relationship to become active.  </p>
<h1 id="rfc.section.8">
<a href="#rfc.section.8">8.</a> <a href="#ProviderAuthz" id="ProviderAuthz">Provider Authorization</a>
</h1>
<p id="rfc.section.8.p.1">Provider Authorization enables an Identity Provider and Application Provider to agree on an authorization scheme and use that scheme to protect access to any endpoints shared with the other party. Supported schemes are communicated via the <samp>provider_authz_schemes_supported</samp> property within <a href="#ProviderMetadataCapabilities" class="xref">Provider Metadata</a>.  </p>
<p id="rfc.section.8.p.2">This specification describes one authorization scheme using OAuth.  </p>
<h1 id="rfc.section.8.1">
<a href="#rfc.section.8.1">8.1.</a> <a href="#ProviderAuthzOAuth" id="ProviderAuthzOAuth">OAuth Scheme</a>
</h1>
<h1 id="rfc.section.8.1.1">
<a href="#rfc.section.8.1.1">8.1.1.</a> <a href="#ProviderAuthzOAuthGrantType" id="ProviderAuthzOAuthGrantType">FastFed Grant Type</a>
</h1>
<p id="rfc.section.8.1.1.p.1">FastFed defines an OAuth Extension Grant Type (Section 4.5 of <a href="#RFC6749" class="xref">RFC 6749</a>) with URI <samp>urn:ietf:params:oauth:grant-type:fastfed</samp>.  </p>
<p id="rfc.section.8.1.1.p.2">The FastFed grant type uses access codes exchanged by Providers during the FastFed Handshake. These initial access codes are redeemed for an OAuth <samp>access_token</samp> and <samp>refresh_token</samp> using the OAuth Extension Grant Flow (Section 4.5 of <a href="#RFC6749" class="xref">RFC 6749</a>). The resulting OAuth tokens are Bearer Tokens <a href="#RFC6750" class="xref">[RFC6750]</a> that are subsequently used for accessing any FastFed endpoints which require authorization.  </p>
<p id="rfc.section.8.1.1.p.3">The FastFed initial access codes are redeemed by making a request to the token endpoint of an OAuth authorization server with the following parameters: </p>

<dl>
<dt>grant_type</dt>
<dd style="margin-left: 8">REQUIRED. The value <samp>urn:ietf:params:oauth:grant-type:fastfed</samp> </dd>
<dt>initial_access_code</dt>
<dd style="margin-left: 8">REQUIRED.  The initial access code vended by one Provider to another Provider during the FastFed Handshake. The access code MUST expire shortly after it is issued to mitigate the risk of leaks.  A maximum authorization code lifetime of 10 minutes is RECOMMENDED.  The client MUST NOT use the access code more than once.  If an access code is used more than once, the OAuth authorization server MUST deny the request and SHOULD revoke (when possible) all tokens previously issued based on that access code.  </dd>
</dl>

<p> </p>
<p id="rfc.section.8.1.1.p.4">The following is a non-normative example of using the OAuth Extension Grant with the FastFed <samp>initial_access_code</samp>: </p>
<pre>
  POST /token HTTP/1.1
  Host: idp.example.com
  Content-Type: application/x-www-form-urlencoded

  grant_type=urn%3Aietf%3Aparams%3Aoauth%3Agrant-type%3fastfed
  &amp;initial_access_code=PEFzc2VydGlvbiBJc3N1ZUluc3RhbnQ9IjIwMTEtMDUk2k2
</pre>
<h1 id="rfc.section.8.1.2">
<a href="#rfc.section.8.1.2">8.1.2.</a> <a href="#ProviderAuthzOAuthExtProviderMetadata" id="ProviderAuthzOAuthExtProviderMetadata">OAuth Extensions to Provider Metadata</a>
</h1>
<p id="rfc.section.8.1.2.p.1">Support for OAuth is specified in FastFed by including the string <samp>OAuth</samp> in the <samp>provider_authz_schemes_supported</samp> property in <a href="#ProviderMetadataCapabilities" class="xref">Provider Metadata</a>.  </p>
<h1 id="rfc.section.8.1.3">
<a href="#rfc.section.8.1.3">8.1.3.</a> <a href="#ProviderAuthzOAuthExtInstanceMetadata" id="ProviderAuthzOAuthExtInstanceMetadata">OAuth Extensions to Instance Metadata</a>
</h1>
<p id="rfc.section.8.1.3.p.1">OAuth is selected as an authorization scheme by using the string <samp>OAuth</samp> as the value of the <samp>provider_authz_schemes_supported</samp> in <a href="#CommonInstanceMetadata" class="xref">Instance Metadata</a>.  </p>
<p id="rfc.section.8.1.3.p.2">When using OAuth, both Providers need to share the location of the OAuth token endpoint.  </p>
<p id="rfc.section.8.1.3.p.3">To enable this, the <a href="#CommonInstanceMetadata" class="xref">Common Instance Metadata</a> structure is extended with the following attributes: </p>

<dl>
<dt>oauth_token_endpoint</dt>
<dd style="margin-left: 8">REQUIRED when using OAuth. Contains the URL of the Provider's OAuth 2.0 Token Endpoint, as specified in Section 3.2 of <a href="#RFC6749" class="xref">[RFC6749]</a>.  </dd>
</dl>

<p> </p>
<p id="rfc.section.8.1.3.p.4">The following is a non-normative snippet of Instance Metadata showing the use of OAuth: </p>
<pre>
 {
 "identity_provider_instance": {
   "tenant_id": "k2lini4cj509ut09cj0jcjwee9gj0jeg",
   ...
   "provider_authz_scheme": "OAuth",
   "oauth_token_endpoint": "https://tenant12345.example.com/token",
   ...
</pre>
<h1 id="rfc.section.8.1.4">
<a href="#rfc.section.8.1.4">8.1.4.</a> <a href="#ProviderAuthzOAuthExtHandshake1" id="ProviderAuthzOAuthExtHandshake1">OAuth Extensions to Handshake Flows</a>
</h1>
<p id="rfc.section.8.1.4.p.1">The use of the OAuth scheme extends the FastFed Handshake flows with additional parameters and requirements. These extensions are described below.  </p>
<h1 id="rfc.section.8.1.4.1">
<a href="#rfc.section.8.1.4.1">8.1.4.1.</a> <a href="#ProviderAuthzOAuthExtHandshake2" id="ProviderAuthzOAuthExtHandshake2">Extension to Step 6.2.1.7 - Identity Provider Response</a>
</h1>
<p id="rfc.section.8.1.4.1.p.1">The request from the Identity Provider to the Application Provider is extended with the following parameters: </p>

<dl>
<dt>initial_access_code</dt>
<dd style="margin-left: 8">REQUIRED. The initial code for use with the <a href="#ProviderAuthzOAuth" class="xref">FastFed OAuth Extension Grant Type</a>.  </dd>
<dt>oauth_token_endpoint</dt>
<dd style="margin-left: 8">REQUIRED. URL of the Provider's OAuth 2.0 Token Endpoint, as specified in Section 3.2 of <a href="#RFC6749" class="xref">[RFC6749]</a>.  </dd>
<dt></dt>
<dd style="margin-left: 8">The following is a non-normative example showing the usage of OAuth with the additional parameters: </dd>
</dl>

<p> </p>
<pre>
 HTTP/1.1 302 Found
 Location: https://app.example.com/fastfed/handshake/receive?
   provider_metadata_uri=https%3A%2F%2Fidp.example.com%2Ffastfed%2Fprovider-metadata
   &amp;instance_metadata_uri=https%3A%2F%2Ftenant12345.example.com%2Ffastfed%2Finstance-metadata
   &amp;state=vk2j35ijlkt2j2oij3ti2jtkltkl2n4kl2n
   &amp;authz_scheme=OAuth
   &amp;oauth_token_endpoint=https%3A%2F%2Fidp.example.com%2Foauth%2Ftoken
   &amp;initial_access_code=p3kN2ko1Ho2439cmDs5
</pre>
<p id="rfc.section.8.1.4.1.p.2">The Identity Provider MUST perform the following: </p>

<ul>
<li>Generate an initial_access_code for the Application Provider </li>
<li>Populate the request to the Application Provider with the <samp>authz_scheme</samp>, <samp>oauth_token_endpoint</samp>, and <samp>initial_access_code</samp>.  </li>
</ul>

<p> </p>
<p id="rfc.section.8.1.4.1.p.3">The Application Provider MUST perform the following: </p>

<ul><li>Capture the <samp>authz_scheme</samp>, <samp>oauth_token_endpoint</samp>, and <samp>initial_access_code</samp> for use in subsequent steps.  </li></ul>

<p> </p>
<h1 id="rfc.section.8.1.4.2">
<a href="#rfc.section.8.1.4.2">8.1.4.2.</a> <a href="#ProviderAuthzOAuthExtHandshake3" id="ProviderAuthzOAuthExtHandshake3">Extension to Step 6.2.2.3 - Application Provider Reads Instance Metadata</a>
</h1>
<p id="rfc.section.8.1.4.2.p.1">Prior to reading Instance Metadata, the Application Provider MUST exchange the <samp>initial_access_code</samp> for an OAuth <samp>access_token</samp> and <samp>refresh_token</samp>. This is accomplished by using the OAuth Extended Grant flow with the <samp>oauth_token_endpoint</samp> and <samp>initial_access_code</samp> supplied by the Identity Provider.  </p>
<p id="rfc.section.8.1.4.2.p.2">The resulting <samp>access_token</samp> MUST be presented as a Bearer Token <a href="#RFC6750" class="xref">[RFC6750]</a> when calling the Instance Metadata Endpoint on the Identity Provider </p>
<p id="rfc.section.8.1.4.2.p.3">The following is a non-normative example of a request and response using the OAuth Extension Grant with FastFed: </p>
<pre>
 POST /token HTTP/1.1
 Host: idp.example.com
 Content-Type: application/x-www-form-urlencoded

 grant_type=urn%3Aietf%3Aparams%3Aoauth%3Agrant-type%3fastfed
 &amp;initial_access_code=PEFzc2VydGlvbiBJc3N1ZUluc3RhbnQ9IjIwMTEtMDUk2k2
</pre>
<pre>
 HTTP/1.1 200 OK
 Content-Type: application/json;charset=UTF-8
 Cache-Control: no-store
 Pragma: no-cache

 {
   "access_token":"Lj2kj3ujwlkdnl2ip42i2o",
   "token_type":"Bearer",
   "expires_in":3600,
   "refresh_token":"ztdyt86vgljyfJRq0vDJ676"
 }
</pre>
<p id="rfc.section.8.1.4.2.p.4">The following is a non-normative example of using the <samp>access_token</samp> to query Instance Metadata: </p>
<pre>
  GET /tenant12345/instance-metadata HTTP/1.1
  Accept: application/json
  Host: provider.example.com
  Authorization: Bearer Lj2kj3ujwlkdnl2ip42i2o
</pre>
<p id="rfc.section.8.1.4.2.p.5">The Identity Provider MUST perform the following for this step: </p>

<ul>
<li>Operate an OAuth authorization server that supports the FastFed Grant Type, as defined in <a href="#ProviderAuthzOAuth" class="xref">Section 8.1</a>.  </li>
<li>Issue an <samp>access_token</samp> and <samp>refresh_token</samp> as a result of a valid token request using the FastFed Grant.  </li>
<li>Authorize calls to the Instance Metadata Endpoint using the <samp>access_token</samp> presented as a Bearer Token <a href="#RFC6750" class="xref">[RFC6750]</a>.  The <samp>access_token</samp> MUST give access to query the Instance Metadata Endpoint and any resources referenced by the Instance Metadata.  </li>
</ul>

<p> </p>
<p id="rfc.section.8.1.4.2.p.6">The Application Provider MUST perform the following: </p>

<ul>
<li>Call the Identity Provider's token endpoint to exchange the FastFed <samp>initial_access_code</samp> for an OAuth <samp>access_token</samp> and <samp>refresh_token</samp>.  </li>
<li>Capture the <samp>access_token</samp> and <samp>refresh_token</samp> for subsequent steps </li>
<li>Present the <samp>access_token</samp> as a Bearer Token <a href="#RFC6750" class="xref">[RFC6750]</a> when querying the Instance Metadata Endpoint.  </li>
</ul>

<p> </p>
<h1 id="rfc.section.8.1.4.3">
<a href="#rfc.section.8.1.4.3">8.1.4.3.</a> <a href="#ProviderAuthzOAuthExtHandshake4" id="ProviderAuthzOAuthExtHandshake4">Extension to Step 6.2.2.8 - Application Provider Response</a>
</h1>
<p id="rfc.section.8.1.4.3.p.1">The response from the Application Provider to the Identity Provider is extended with the following parameters: </p>

<dl>
<dt>initial_access_code</dt>
<dd style="margin-left: 8">REQUIRED. The initial code for use with the FastFed OAuth Extension Grant Type, as per <a href="#ProviderAuthzOAuth" class="xref">Section 8.1</a> </dd>
<dt>oauth_token_endpoint</dt>
<dd style="margin-left: 8">REQUIRED. URL of the Provider's OAuth 2.0 Token Endpoint, as specified in Section 3.2 in <a href="#RFC6749" class="xref">[RFC6749]</a>.  </dd>
</dl>

<p> </p>
<p id="rfc.section.8.1.4.3.p.2">The following is a non-normative example showing the usage of OAuth with the additional parameters: </p>
<pre>
 HTTP/1.1 302 Found
 Location: https://ipd.example.com/fastfed/handshake/finish?
   instance_metadata_uri=https%3A%2F%2Ftenant67890.example.com%2Ffastfed%2Finstance-metadata
   &amp;state=vk2j35ijlkt2j2oij3ti2jtkltkl2n4kl2n
   &amp;authz_scheme=OAuth
   &amp;oauth_token_endpoint=https%3A%2F%2Fapp.example.com%2Foauth%2Ftoken
   &amp;initial_access_code=k6i49yjo93jPklqlsj
</pre>
<p id="rfc.section.8.1.4.3.p.3">The Application Provider MUST perform the following: </p>

<ul>
<li>Generate an <samp>initial_access_code</samp> for the Application Provider </li>
<li>Populate the response to the Identity Provider with the <samp>authz_scheme</samp>, <samp>oauth_token_endpoint</samp>, and <samp>initial_access_code</samp>.  </li>
</ul>

<p> </p>
<p id="rfc.section.8.1.4.3.p.4">The Identity Provider MUST perform the following for this step: </p>

<ul><li>Capture the <samp>authz_scheme</samp>, <samp>oauth_token_endpoint</samp>, and <samp>initial_access_code</samp> for use in subsequent steps.  </li></ul>

<p> </p>
<h1 id="rfc.section.8.1.4.4">
<a href="#rfc.section.8.1.4.4">8.1.4.4.</a> <a href="#ProviderAuthzOAuthExtHandshake5" id="ProviderAuthzOAuthExtHandshake5">Extension to Step 6.2.3.2 - Identity Provider Reads Instance Metadata</a>
</h1>
<p id="rfc.section.8.1.4.4.p.1">This extension is similar to Step <a href="#ProviderAuthzOAuthExtHandshake3" class="xref">8.1.4.2</a> with the roles of the Identity Provider and Application Provider swapped.  </p>
<p id="rfc.section.8.1.4.4.p.2">Prior to querying the Instance Metadata from the Application Provider, the Identity Provider MUST exchange the <samp>initial_access_code</samp> for an OAuth <samp>access_token</samp> and refresh_token. This is accomplished by using the OAuth Extended Grant flow with the token endpoint and <samp>initial_access_code</samp> supplied by the Application Provider, as per <a href="#ProviderAuthzOAuth" class="xref">Section 8.1</a> </p>
<p id="rfc.section.8.1.4.4.p.3">The resulting access_token MUST be presented as a Bearer Token <a href="#RFC6750" class="xref">[RFC6750]</a> when calling the Instance Metadata Endpoint on the Application Provider.  </p>
<h1 id="rfc.section.8.1.4.5">
<a href="#rfc.section.8.1.4.5">8.1.4.5.</a> <a href="#ProviderAuthzOAuthExtHandshake6" id="ProviderAuthzOAuthExtHandshake6">Extension to Step 6.2.3.5 - Identity Provider Enables Federations</a>
</h1>
<p id="rfc.section.8.1.4.5.p.1">When enabling federation and completing the handshake, the Identity Provider MUST grant access to the Application Provider for all operations necessary for the federated relationship to become active. This MAY be accomplished by including the new permissions the next time the Application Provider uses their <samp>refresh_token</samp> to fetch a new <samp>access_token</samp>.  </p>
<h1 id="rfc.section.8.1.5">
<a href="#rfc.section.8.1.5">8.1.5.</a> <a href="#ProviderAuthzOAuthForOIDC" id="ProviderAuthzOAuthForOIDC">Applicability to OIDC</a>
</h1>
<p id="rfc.section.8.1.5.p.1">If the Identity Provider supports <a href="#OpenID.Registration" class="xref">OpenID Connect Dynamic Client Registration 1.0</a> [OpenID.Registration], the FastFed Application Provider MUST present the <samp>access_token</samp> as the Initial Access Token when calling the Client Registration Endpoint.  The Identity Provider SHOULD authorize the caller using the presented token.  </p>
<p id="rfc.section.8.1.5.p.2">In addition, the Application Provider MUST present the <samp>access_token</samp> as a Bearer Token <a href="#RFC6750" class="xref">[RFC6750]</a> when querying any OpenID Connect endpoints hosted by the Identity Provider, including OpenID Provider Configuration Requests as specified in <a href="#OpenID.Registration" class="xref">OpenID Connect Dynamic Client Registration 1.0</a> [OpenID.Registration]. The Identity Provider SHOULD authorize the Application Provider using the presented token.  </p>
<h1 id="rfc.section.8.1.6">
<a href="#rfc.section.8.1.6">8.1.6.</a> <a href="#ProviderAuthzOAuthForSAML" id="ProviderAuthzOAuthForSAML">Applicability to SAML</a>
</h1>
<p id="rfc.section.8.1.6.p.1">When reading SAML Metadata from an endpoint specified by a Provider, the caller MUST present the <samp>access_token</samp> as a Bearer Token <a href="#RFC6750" class="xref">[RFC6750]</a> when querying the endpoint. The endpoint owner SHOULD authorize the caller using the presented token.  </p>
<h1 id="rfc.section.8.1.7">
<a href="#rfc.section.8.1.7">8.1.7.</a> <a href="#ProviderAuthzOAuthForSCIM" id="ProviderAuthzOAuthForSCIM">Applicability to SCIM</a>
</h1>
<p id="rfc.section.8.1.7.p.1">When calling a SCIM endpoint as part of user provisioning activities, the caller MUST present the <samp>access_token</samp> as a Bearer Token <a href="#RFC6750" class="xref">[RFC6750]</a>. The endpoint owner SHOULD authorize the caller using the presented token.  </p>
<h1 id="rfc.section.9">
<a href="#rfc.section.9">9.</a> <a href="#UserSchemas" id="UserSchemas">User Schemas</a>
</h1>
<p id="rfc.section.9.p.1">FastFed requires that an Identity Provider and Application Provider share a common user schema. FastFed RECOMMENDS the use of the SCIM specification for defining schemas <a href="#RFC7643" class="xref">[RFC7643]</a>. Any schema specified under the path <samp>urn:ietf:params:scim:schemas</samp> will be presumed to be a SCIM schema definition for the purposes of this specification.  </p>
<p id="rfc.section.9.p.2">For each schema, the following properties must be specified: </p>

<ul>
<li>Attribute Path Syntax</li>
<li>Attribute Mapping Syntax</li>
</ul>

<p> </p>
<h1 id="rfc.section.9.1">
<a href="#rfc.section.9.1">9.1.</a> <a href="#AttributePath" id="AttributePath">Attribute Path</a>
</h1>
<p id="rfc.section.9.1.p.1">Attribute Path is a string whose contents reference a specific user attribute within the schema.  </p>
<p id="rfc.section.9.1.p.2">Attribute Path Syntax describes the format of the string and varies by schema type. <a href="#ScimMAttributePathSyntax" class="xref">Section 9.3.1</a> describes the Attribute Path Syntax for SCIM.  </p>
<h1 id="rfc.section.9.2">
<a href="#rfc.section.9.2">9.2.</a> <a href="#AttributeMapping" id="AttributeMapping">Attribute Mapping</a>
</h1>
<p id="rfc.section.9.2.p.1">Attribute Mapping is a structure containing the following elements: </p>

<dl>
<dt>mapping_syntax</dt>
<dd style="margin-left: 8">REQUIRED. A string which defines the Attribute Mapping Syntax to use when interpreting the mapping rules. A mapping syntax is bound to a particular schema type and SSO protocol. See <a href="#SimpleScimToSaml" class="xref">Section 9.3.2.1</a> for mapping SCIM-to-SAML and <a href="#SimpleScimToOidc" class="xref">Section 9.3.2.2</a> for mapping SCIM-to-OIDC.  </dd>
<dt>mapping_rules</dt>
<dd style="margin-left: 8">REQUIRED. A structure containing a description of mapping rules, expressed in the Attribute Mapping Syntax.  </dd>
</dl>

<p> </p>
<p id="rfc.section.9.2.p.2">When performing an attribute mapping based upon the <samp>mapping_rules</samp>, Identity Providers MUST ignore and omit any attributes in the <samp>mapping_rules</samp> which were not explicitly approved for release by the Administrator in Step <a href="#HandshakeIdentityProviderObtainsFinalConsentFromAdministrator" class="xref">7.2.3.4</a> of the FastFed Handshake.  </p>
<h1 id="rfc.section.9.3">
<a href="#rfc.section.9.3">9.3.</a> <a href="#ScimSpecifications" id="ScimSpecifications">SCIM Specifications for FastFed</a>
</h1>
<h1 id="rfc.section.9.3.1">
<a href="#rfc.section.9.3.1">9.3.1.</a> <a href="#ScimMAttributePathSyntax" id="ScimMAttributePathSyntax">SCIM Attribute Path Syntax</a>
</h1>
<p id="rfc.section.9.3.1.p.1">FastFed uses the SCIM PATH specification as defined in section Section 3.5.2 of the <a href="#RFC7643" class="xref">SCIM Core Specification</a> [RFC7643].  </p>
<p id="rfc.section.9.3.1.p.2">The following are non-normative examples of SCIM PATH definitions: </p>
<pre>
 userName
 name.familyName
 addresses[primary eq true].formatted
</pre>
<p id="rfc.section.9.3.1.p.3">When used with FastFed, a SCIM PATH expression MUST point to an attribute with one of the following Data Types as defined in Section 3 of the <a href="#RFC7643" class="xref">SCIM Core Specification</a> [RFC7643].  </p>

<ul>
<li>String</li>
<li>Boolean</li>
<li>Decimal</li>
<li>Integer</li>
<li>DateTime</li>
<li>Binary</li>
<li>Reference</li>
</ul>

<p> </p>
<p id="rfc.section.9.3.1.p.4">The SCIM PATH expression MUST NOT point to an attribute with a Complex Data Type. If information is needed from a Complex attribute, each piece of information should be referenced by explicitly specifying unique paths to the members of a Complex attribute.  </p>
<p id="rfc.section.9.3.1.p.5">The following is a non-normative example of an invalid path which MUST NOT be used because it references a Complex attribute: </p>
<pre>
 addresses[primary eq true]     # Invalid. Points to Complex attribute.
</pre>
<p id="rfc.section.9.3.1.p.6">The SCIM PATH expression MAY match multiple attributes. Each matching attribute MUST be one of the supported Data Types.  </p>
<p id="rfc.section.9.3.1.p.7">The following are non-normative examples of paths which may match multiple attributes: </p>
<pre>
 groups.displayName             # List of group displayNames
 emails.value                   # List of email values
 emails[value co ".com"].value  # List of email values containing ".com"
</pre>
<h1 id="rfc.section.9.3.2">
<a href="#rfc.section.9.3.2">9.3.2.</a> <a href="#ScimMAttributeMappingSyntax" id="ScimMAttributeMappingSyntax">SCIM Attribute Mapping Syntax</a>
</h1>
<h1 id="rfc.section.9.3.2.1">
<a href="#rfc.section.9.3.2.1">9.3.2.1.</a> <a href="#SimpleScimToSaml" id="SimpleScimToSaml">Simple SCIM to SAML</a>
</h1>
<p id="rfc.section.9.3.2.1.p.1">This syntax maps between SCIM 2.0 schemas <a href="#RFC7643" class="xref">[RFC7643]</a> and SAML 2.0 assertions <a href="#SAML.Assertions" class="xref">[SAML.Assertions]</a>.  </p>
<p id="rfc.section.9.3.2.1.p.2">The syntax is referenced by specifying the string <samp>simple_scim_to_saml</samp> as the value of the <samp>mapping_syntax</samp> attribute in the <a href="#AttributeMapping" class="xref">Attribute Mapping</a> structure.  </p>
<p id="rfc.section.9.3.2.1.p.3">This syntax defines a transformation based on simple string copying. No formatting or alterations of the strings are supported. Instead, values are simply copied from the user schema and inserted into the SSO protocol with the specified labels and properties.  </p>
<p id="rfc.section.9.3.2.1.p.4">The mapping rules are defined by a structure containing the following attributes: </p>

<dl>
<dt>name_id</dt>
<dd style="margin-left: 8">REQUIRED. A structure which defines how to populate the Subject NameID element in the SAML assertion. It contains the following attributes: <dl>
<dt>format</dt>
<dd style="margin-left: 8">REQUIRED. A string value to use as the NameID Format.  </dd>
<dt>value</dt>
<dd style="margin-left: 8">REQUIRED. The SCIM Attribute Path pointing to a value to be used as the SCIM NameID. The Attribute Path MUST reference a single value, not a list.  </dd>
</dl>
<p> </p>
</dd>
<dt>attributes</dt>
<dd style="margin-left: 8">OPTIONAL. A list of structures, where each structure contains the following attributes: <dl>
<dt>name</dt>
<dd style="margin-left: 8">REQUIRED. A string value to use as the SAML Attribute Name </dd>
<dt>format</dt>
<dd style="margin-left: 8">OPTIONAL. A string value to use as the SAML Attribute Format.  Defaults to <samp>urn:oasis:names:tc:SAML:2.0:attrname-format:unspecified</samp> </dd>
<dt>value</dt>
<dd style="margin-left: 8">REQUIRED. The SCIM Attribute Path pointing to a value to be used as the SAML Attribute Value. The Attribute Path MAY reference a single value or a list of values.  If an attribute value is undefined or empty for an end-user, the Identity Provider MUST omit the attribute when building the SAML assertion.  </dd>
</dl>
<p> </p>
</dd>
</dl>

<p> </p>
<p id="rfc.section.9.3.2.1.p.5">The following non-normative example shows a SCIM User, a SCIM Attribute Mapping definition, and the resulting SAML assertion.  </p>
<p>Example SCIM User:</p>
<pre>
 {
   "schemas":
     ["urn:ietf:params:scim:schemas:core:2.0:User"],
   "id": "2819c223-7f76-453a-919d-413861904646",
   "userName": "bjensen",
   "name": {
     "formatted": "Ms. Barbara J Jensen, III",
   },
   "displayName": "Babs Jensen",
   "emails": [
     {
       "value": "bjensen@example.com",
       "type": "work",
       "primary": true
     },
     {
       "value": "babs@jensen.org",
       "type": "home"
     }
   ],
   "groups": [
     {
       "displayName": "Employees"
     },
     {
       "displayName": "US Employees"
     }
   ]
 }
</pre>
<p>Example Attribute Mapping:</p>
<pre>
 "user_attribute_mapping": {
     "mapping_syntax": "simple_scim_to_saml",
     "mapping_rules": {
         "name_id": {
             "format": "urn:oasis:names:tc:SAML:2.0:nameid-format:persistent",
             "value": "id",
         },
         "attributes": [
             {"name": "name",
              "value": "displayName"
             },
             {"name": "email",
              "value": "email[primary eq true].value"
             },
             {"name": "groups",
              "value": "groups.displayName"
             }
         ]
     }    
 }
</pre>
<p>Example of Resulting SAML Document:</p>
<pre>
    ...
    &lt;saml:Subject&gt;
      &lt;saml:NameID Format="urn:oasis:names:tc:SAML:2.0:nameid-format:persistent"&gt;2819c223-7f76-453a-919d-413861904646&lt;/saml:NameID&gt;
    &lt;/saml:Subject&gt;
    ...
    &lt;saml:AttributeStatement&gt;
      &lt;saml:Attribute Name="name" NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:unspecified"&gt;
        &lt;saml:AttributeValue"&gt;Babs Jenson&lt;/saml:AttributeValue&gt;
      &lt;/saml:Attribute&gt;
      &lt;saml:Attribute Name="email" NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:unspecified"&gt;
        &lt;saml:AttributeValue"&gt;bjenson@example.com&lt;/saml:AttributeValue&gt;
      &lt;/saml:Attribute&gt;
      &lt;saml:Attribute Name="groups" NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:unspecified"&gt;
        &lt;saml:AttributeValue"&gt;Employees&lt;/saml:AttributeValue&gt;
        &lt;saml:AttributeValue"&gt;US Employees&lt;/saml:AttributeValue&gt;
      &lt;/saml:Attribute&gt;
    &lt;/saml:AttributeStatement&gt;
   ...
</pre>
<h1 id="rfc.section.9.3.2.2">
<a href="#rfc.section.9.3.2.2">9.3.2.2.</a> <a href="#SimpleScimToOidc" id="SimpleScimToOidc">Simple SCIM to OIDC</a>
</h1>
<p id="rfc.section.9.3.2.2.p.1">This syntax maps between SCIM schemas <a href="#RFC7643" class="xref">[RFC7643]</a> and OpenID Connect claims <a href="#OpenID.Core" class="xref">[OpenID.Core]</a>.  </p>
<p id="rfc.section.9.3.2.2.p.2">The syntax is used by specifying the string <samp>simple_scim_to_oidc</samp> as the value of the <samp>mapping_syntax</samp> attribute in the <a href="#AttributeMapping" class="xref">Attribute Mapping</a> structure.  </p>
<p id="rfc.section.9.3.2.2.p.3">This syntax defines a transformation based on simple string copying. No formatting or alterations of the strings are supported. Instead, values are simply copied from the user schema and inserted into the SSO protocol with specified labels.  </p>
<p id="rfc.section.9.3.2.2.p.4">The mapping rules are defined by a structure containing key-value pairs, where the key is the name of an OpenID Connect claim and the value is a SCIM Attribute Path.  </p>
<p id="rfc.section.9.3.2.2.p.5">The following is a non-normative example of <samp>simple_scim_to_oidc</samp> mapping rules: </p>
<pre>
 "mapping_rules": {
     "sub": "id",
     "name": "displayName",
     "email": "email[primary eq true].value",
     "groups": "groups.displayName"
 }
</pre>
<p id="rfc.section.9.3.2.2.p.6">If an attribute value is undefined or empty for an end-user, the Identity Provider MUST omit the claim from OIDC responses.  </p>
<p id="rfc.section.9.3.2.2.p.7">The following non-normative example shows a sample SCIM User, a SCIM Attribute Mapping definition, and the resulting OIDC claims.  </p>
<p>Example SCIM User:</p>
<pre>
 {
   "schemas":
     ["urn:ietf:params:scim:schemas:core:2.0:User"],
   "id": "2819c223-7f76-453a-919d-413861904646",
   "userName": "bjensen",
   "name": {
     "formatted": "Ms. Barbara J Jensen, III",
   },
   "displayName": "Babs Jensen",
   "emails": [
     {
       "value": "bjensen@example.com",
       "type": "work",
       "primary": true
     },
     {
       "value": "babs@jensen.org",
       "type": "home"
     }
   ],
   "groups": [
     {
       "displayName": "Employees"
     },
     {
       "displayName": "US Employees"
     }
   ]
 }
</pre>
<p>Example Attribute Mapping:</p>
<pre>
 "user_attribute_mapping": {
     "mapping_syntax": "simple_scim_to_oidc",
     "mapping_rules": {
         "sub": "userName",
         "name": "displayName",
         "email": "email[primary eq true].value",
         "groups": "groups.displayName"
     }
 }
</pre>
<p>Example of Resulting OIDC Claims:</p>
<pre>
 "sub": "bjensen",
 "name": "Babs Jenson"
 "email": "bjenson@example.com"
 "groups": ["Employees", "US Employees"]
</pre>
<h1 id="rfc.section.10">
<a href="#rfc.section.10">10.</a> <a href="#RecurringActivities" id="RecurringActivities">Recurring Activities</a>
</h1>
<p id="rfc.section.10.p.1">Recurring Activities are optional capabilities that continue after the initial FastFed Handshake is completed. Typically, they are used to communicate changes in Metadata that are safe to share between Providers automatically, without explicit consent from an Administrator.  </p>
<p id="rfc.section.10.p.2">This specification defines recurring activities for key rotation and icon image updates.  </p>
<h1 id="rfc.section.10.1">
<a href="#rfc.section.10.1">10.1.</a> <a href="#RecurringActivitiesCapabilities" id="RecurringActivitiesCapabilities">Recurring Activities Capabilities</a>
</h1>
<p id="rfc.section.10.1.p.1">Recurring Activities Capabilities is a structure containing the following attributes: </p>

<dl>
<dt>icon_refresh</dt>
<dd style="margin-left: 8">OPTIONAL. A list of strings which describes the Provider capabilities for refreshing icon images. Valid values are <samp>publish</samp> and <samp>consume</samp>. The value <samp>publish</samp> indicates the Provider can publish icon updates as specified in <a href="#IconRefreshPublishRequirements" class="xref">Section 10.6.1</a>. The value <samp>consume</samp> indicates the Provider can consume icon updates from others as specified as specified in <a href="#IconRefreshConsumptionRequirements" class="xref">Section 10.6.2</a>.  </dd>
<dt>saml_certificate_rotation</dt>
<dd style="margin-left: 8">OPTIONAL. A list of strings which describes the Provider capabilities for rotating certificates used by the SAML SSO protocol. Valid values are <samp>publish</samp> and <samp>consume</samp>. The value <samp>publish</samp> indicates the Provider can publish new certificates as specified in <a href="#SAMLCertificatePublishRequirements" class="xref">Section 10.7.1</a>. The value <samp>consume</samp> indicates the Provider can consume new certificates as specified as specified in <a href="#SAMLCertificateConsumptionRequirements" class="xref">Section 10.7.2</a> </dd>
<dt>oidc_key_rotation</dt>
<dd style="margin-left: 8">OPTIONAL. A list of strings which describes the Provider capabilities for rotating keys and secrets used by the OpenID Connect SSO protocol. Valid values are <samp>publish</samp> and <samp>consume</samp>. The value <samp>publish</samp> indicates the Provider can publish new secrets as specified in <a href="#OIDCKeyPublicationRequirements" class="xref">Section 10.8.1</a>. The value <samp>consume</samp> indicates the Provider can consume new secrets as specified as specified in <a href="#OIDCKeyConsumptionRequirements" class="xref">Section 10.8.2</a>.  </dd>
</dl>

<p> </p>
<h1 id="rfc.section.10.2">
<a href="#rfc.section.10.2">10.2.</a> <a href="#RecurringActivitiesProviderMetadata" id="RecurringActivitiesProviderMetadata">Extensions to Provider Metadata</a>
</h1>
<p id="rfc.section.10.2.p.1">The Common Provider Metadata structure defined in <a href="#CommonProviderMetadata" class="xref">Section 4.3.2</a> is extended with the following attribute: </p>

<dl>
<dt>recurring_activities_supported</dt>
<dd style="margin-left: 8">OPTIONAL. A structure containing the Recurring Activities Capabilities supported by the Provider.  </dd>
</dl>

<p> </p>
<p id="rfc.section.10.2.p.2">The following is a non-normative example of Provider Metadata containing recurring activities: </p>
<pre>
 "application_provider": {
     ...
     "recurring_activities_supported": {
         "icon_refresh": ["publish","consume"],
         "saml_certificate_rotation": ["consume"],
         "oidc_key_rotation": ["consume"],
     }
     ...	 
 }
</pre>
<h1 id="rfc.section.10.3">
<a href="#rfc.section.10.3">10.3.</a> <a href="#RecurringActivitiesInstanceMetadata" id="RecurringActivitiesInstanceMetadata">Extensions to Instance Metadata</a>
</h1>
<p id="rfc.section.10.3.p.1">The Common Instance Metadata structure defined in <a href="#CommonInstanceMetadata" class="xref">Section 4.4.1</a> is extended with the following attribute: </p>

<dl>
<dt>recurring_activities</dt>
<dd style="margin-left: 8">OPTIONAL. A structure containing the Recurring Activities Capabilities that will be enabled for the specific relationshp between an Identity Provider and Application Provider.  </dd>
</dl>

<p> </p>
<pre>
 "application_provider_instance": {
     ...
     "recurring_activities": {
         "icon_refresh": ["publish"],
         "saml_certificate_rotation": ["consume"],
     }
     ...	 
 }
</pre>
<h1 id="rfc.section.10.4">
<a href="#rfc.section.10.4">10.4.</a> <a href="#RecurringActivitiesProviderCompatibility" id="RecurringActivitiesProviderCompatibility">Extensions to Provider Compatiblity Evaluation</a>
</h1>
<p id="rfc.section.10.4.p.1">There are no changes to the Provider Compatibility Evaluation defined in <a href="#ProviderCompatibilityEvaluation" class="xref">Section 6</a>. This is because Recurring Activities are optional. If one Provider supports an activity, but the other doesn't, then the activity will simply not be executed.  </p>
<h1 id="rfc.section.10.5">
<a href="#rfc.section.10.5">10.5.</a> <a href="#RecurringActivitiesInstanceValidation" id="RecurringActivitiesInstanceValidation">Extensions to Instance Metadata Validation</a>
</h1>
<p id="rfc.section.10.5.p.1">When constructing an Instance Metadata document, the following process MUST be used to select the Recurring Activities Capabilities that can be enabled for a specific federation.  </p>
<p></p>

<ul>
<li>If a Provider supports <samp>publish</samp>, and the other Provider supports <samp>consume</samp>, then the Provider MUST include <samp>publish</samp> in their Instance Metadata choices.  </li>
<li>If a Provider supports <samp>consume</samp>, and the other Provider supports <samp>publish</samp>, then the Provider MUST include <samp>consume</samp> in their Instance Metadata choices.  </li>
</ul>

<p> </p>
<p id="rfc.section.10.5.p.3">In addition, during the FastFed Handshake, each Provider MUST validate that the Instance Metadata vended by the other Provider conforms to this selection process.  </p>
<p id="rfc.section.10.5.p.4">The following is a non-normative example showing the Provider Metadata and resulting Instance Metadata for a federation between an Identity Provider and Application Provider: </p>
<p>Example of Provider Metadata:</p>
<pre>
 "identity_provider": {
     ...
     "recurring_activities": {
         "icon_refresh": ["publish", "consume"],
         "saml_certificate_rotation": ["publish"]
         "oidc_key_rotation": ["publish"]
     }
     ... 
 }
</pre>
<pre>
 "application_provider": {
     ...
     "recurring_activities": {
         "icon_refresh": ["publish"],
         "saml_certificate_rotation": ["consume"]
     }
     ...
 }
</pre>
<p>Example of resulting Instance Metadata:</p>
<pre>
 "identity_provider_instance": {
     ....
     "recurring_activities": {
         "icon_refresh": ["consume"],
         "saml_certificate_rotation": ["publish"]
     }
     ...	 
 }
</pre>
<pre>
 "application_provider_instance": {
     ...
     "recurring_activities": {
         "icon_refresh": ["publish"],
         "saml_certificate_rotation": ["consume"]
     }
     ...
 }
</pre>
<h1 id="rfc.section.10.6">
<a href="#rfc.section.10.6">10.6.</a> <a href="#IconRefreshRequirements" id="IconRefreshRequirements">Requirements for Icon Refresh</a>
</h1>
<h1 id="rfc.section.10.6.1">
<a href="#rfc.section.10.6.1">10.6.1.</a> <a href="#IconRefreshPublishRequirements" id="IconRefreshPublishRequirements">Publication Requirements</a>
</h1>
<p id="rfc.section.10.6.1.p.1">To publish updated icon images, the following requirements apply to a Provider: </p>

<ul>
<li>MAY periodically alter the image files referenced by the icon URLs defined in the Provider Metadata and Instance Metadata.  </li>
<li>MAY return an HTTP 301 response code to indicate if the icon image has moved to a new location.  </li>
<li>MUST support the HTTP 1.1 ETag semantics <a href="#RFC2616" class="xref">[RFC2616]</a> for all requests to the icon URLs, including: <ul>
<li>Returning an ETag response header </li>
<li>Accepting an If-None-Match request header, and returning an HTTP 304 response if the icon image is unmodified.  </li>
</ul>
<p> </p>
</li>
</ul>

<p> </p>
<p id="rfc.section.10.6.1.p.2">If these requirements are met, the Provider SHOULD specify <samp>publish</samp> as a value in their list of icon_refresh capabilities.  </p>
<h1 id="rfc.section.10.6.2">
<a href="#rfc.section.10.6.2">10.6.2.</a> <a href="#IconRefreshConsumptionRequirements" id="IconRefreshConsumptionRequirements">Consumption Requirements</a>
</h1>
<p id="rfc.section.10.6.2.p.1">To consume updated icon images, the following requirements apply to a Provider: </p>

<ul>
<li>MUST capture a local copy of an image from the icon URLs defined in the Provider Metadata and Instance Metadata. Otherwise, there is nothing to refresh and the icon refresh activity is unnecessary.  </li>
<li>MUST re-query the icon image urls at least once every 24 hours to check if a new image is available to replace a local copy.  </li>
<li>MUST include the If-None-Match header in the request to read the icon, populated with the value of the ETag response header received when initially downloading the image.  </li>
<li>MUST handle an HTTP 304 response code which indicates that the image is unchanged.  </li>
<li>MUST handle an HTTP 301 response code and use the new location for all future image downloads.  </li>
</ul>

<p> </p>
<p id="rfc.section.10.6.2.p.2">If these requirements are met, the Provider SHOULD specify <samp>consume</samp> as a value in their list of icon_refresh capabilities.  </p>
<h1 id="rfc.section.10.7">
<a href="#rfc.section.10.7">10.7.</a> <a href="#SAMLCertificateRotationRequirements" id="SAMLCertificateRotationRequirements">Requirements for SAML Certificate Rotation</a>
</h1>
<p id="rfc.section.10.7.p.1">While the full SAML specification supports a variety of key usages, the <a href="#Interoperability" class="xref">FastFed Interoperability Requirements</a> restrict Providers to only X509 Keys for signing SAML Assertions in Web Browser SSO response messages from the Identity Provider.  </p>
<p id="rfc.section.10.7.p.2">As such, the following constraints apply to <samp>saml_key_rotation</samp> specifications: </p>

<ul>
<li>Identity Providers MAY include <samp>publish</samp> as a valid <samp>saml_key_rotation</samp> capability if they meet the Publication Requirements described in this section. Any other values MUST be ignored and SHOULD NOT be included.  </li>
<li>Application Providers MAY include <samp>consume</samp> as a valid <samp>saml_key_rotation</samp> capability if they meet the Consumption Requirements described in this section. Any other values MUST be ignored and SHOULD NOT be included.  </li>
</ul>

<p> </p>
<h1 id="rfc.section.10.7.1">
<a href="#rfc.section.10.7.1">10.7.1.</a> <a href="#SAMLCertificatePublishRequirements" id="SAMLCertificatePublishRequirements">Publication Requirements</a>
</h1>
<p id="rfc.section.10.7.1.p.1">To rotate and publish new SAML signing certificates, the following requirements apply to the Identity Provider: </p>

<ul>
<li>MUST include new certificates in the response to queries against the SAML Metadata URL. This URL was specified in the Identity Provider Instance Metadata during the FastFed Handshake.  </li>
<li>MUST publish the new certificate in the SAML Metadata at least 14 days before the currently active certificate will expire or be revoked, where the expiration date is specified by the <samp>notAfter</samp> attribute within the X.509 certificate.  </li>
<li>MUST include the new certificate in the SAML Metadata, alongside the currently active certificate, using the recommended technique for multiple certificates defined in the <a href="#SAML.Interoperability" class="xref">SAML Metadata Interoperability Profile</a>. As a reference, this Interopability Profile specifies that each certificate MUST be placed within its own <samp>&lt;KeyDescriptor&gt;</samp> element.  </li>
<li>SHOULD continue using the original key for signing SAML Assertions for at least 7 days after publishing the new certificate, to give consumers time to read the new certificate from the SAML Metadata and be ready to receive the new key.  </li>
<li>SHOULD begin signing assertions with the new key if less than 7 days remains until the old certificate expires. MAY continue using the old key if problems arise with the new key, to give time for diagnosis of the problems.  </li>
<li>SHOULD stop using the old key for signing assertions when less than 1 day remains until the old certificate expires.  </li>
<li>MUST support HTTP 1.1 ETag semantics <a href="#RFC2616" class="xref">[RFC2616]</a> for all requests to the SAML Metadata URL, including: <ul>
<li>Returning an ETag response header </li>
<li>Accepting an If-None-Match request header, and returning an HTTP 304 response if the SAML Metadata is unmodified.  </li>
</ul>
<p> </p>
</li>
<li>MAY return an HTTP 301 response code to indicate the SAML Metadata has moved to a new location.  </li>
</ul>

<p> </p>
<p id="rfc.section.10.7.1.p.2">If these requirements are met, the Identity Provider MAY specify <samp>publish</samp> as a value in their list of <samp>saml_key_rotation</samp> capabilities.  </p>
<h1 id="rfc.section.10.7.2">
<a href="#rfc.section.10.7.2">10.7.2.</a> <a href="#SAMLCertificateConsumptionRequirements" id="SAMLCertificateConsumptionRequirements">Consumption Requirements</a>
</h1>
<p id="rfc.section.10.7.2.p.1">To consume rotated SAML signing keys, the following requirements apply to the Application Provider: </p>

<ul>
<li>MUST re-query the Identity Provider's SAML Metadata URL to check for new certificates at least once every 24 hours. Because certificates can be rotated at any time, the Application Provider MUST NOT wait for the expiration date to check for updated certificates.  for updates.  </li>
<li>MUST include the If-None-Match header in the request to download the SAML Metadata, populated with the value of the ETag response header received when previously downloading the SAML Metadata.  </li>
<li>MUST handle an HTTP 304 response code which indicates that the SAML Metadata is unchanged.  </li>
<li>MUST handle an HTTP 301 response code and use the new location for all future downloads of the Identity Provider's SAML Metadata.  </li>
<li>MUST support the consumption of multiple certificates using the recommended techniques defined in the <a href="#SAML.Interoperability" class="xref">SAML Metadata Interoperability Profile</a>. As a reference, this Interopability Profile specifies that each certificate MUST be placed within its own <samp>&lt;KeyDescriptor&gt;</samp> element.  </li>
<li>MUST ignore any changes in the SAML Metadata except for <samp>&lt;KeyDescriptor&gt;</samp> elements.  </li>
<li>MUST accept SAML assertions signed using any of the valid certificates specified within the <samp>&lt;KeyDescriptor&gt;</samp> elements of the Identity Provider SAML Metadata.  </li>
<li>SHOULD alert the Administrator if the Identity Provider has not published a new certificate and less than 14 days remains until expiration of the current certificate. The alert mechanism is an implementation detail that is outside the scope of the specification.  </li>
</ul>

<p> </p>
<p id="rfc.section.10.7.2.p.2">If these requirements are met, the Application Provider MAY specify <samp>consume</samp> as a value in their list of saml_key_rotation capabilities.  </p>
<h1 id="rfc.section.10.8">
<a href="#rfc.section.10.8">10.8.</a> <a href="#OIDCKeyRotationRequirements" id="OIDCKeyRotationRequirements">Requirements for OIDC Key Rotation</a>
</h1>
<p id="rfc.section.10.8.p.1">Open ID Connect describes a variety of keys and secrets that are managed by both Identity Providers and Application Providers. The <a href="#Interoperability" class="xref">FastFed Interoperability Requirements</a> permit use of the following: </p>

<ul>
<li>Asymmetric Signing Keys as defined Section 10 of <a href="#OpenID.Core" class="xref">OpenID Connect Core 1.0</a> [OpenID.Core], consisting of the following: <ul>
<li>A private key used by the Identity Provider to sign ID Tokens issued to the Application Provider.  </li>
<li>A public key used by the Application Provider to verify ID Token signatures. The Identity Provider publishes the public keys in the location described by the <samp>jwks_uri</samp> in the Identity Provider's <a href="#OpenID.Discovery" class="xref">OpenID Connect Discovery</a> configuration.  </li>
</ul>
<p> </p>
</li>
<li>Values for <samp>client_secret</samp> and <samp>client_secret_expires_at</samp> that are vended from the Identity Provider to the Application Provider as described in Section 3.2 of <a href="#OpenID.Registration" class="xref">OpenID Connect Dynamic Client Registration 1.0</a> [OpenID.Registration]. FastFed Interoperability requires that <samp>client_secret</samp> be of type <samp>client_secret_basic</samp> as defined in the HTTP Basic Authentication Scheme specified in Section 2.3.1 of OAuth 2.0 <a href="#RFC6749" class="xref">[RFC6749]</a>.  </li>
</ul>

<p> </p>
<p id="rfc.section.10.8.p.2">Since all permitted keys are generated and vended by the Identity Provider, the following constraints apply to <samp>oidc_key_rotation</samp> specifications: </p>

<ul>
<li>Identity Providers MAY include <samp>publish</samp> as a valid <samp>oid_key_rotation</samp> capability if they meet the Publication Requirements described in this section. Any other values MUST be ignored and SHOULD NOT be included.  </li>
<li>Application Providers MAY include <samp>consume</samp> as a valid <samp>oid_key_rotation</samp> capability if they meet the Consumption Requirements described in this section. Any other values MUST be ignored and SHOULD NOT be included.  </li>
</ul>

<p> </p>
<h1 id="rfc.section.10.8.1">
<a href="#rfc.section.10.8.1">10.8.1.</a> <a href="#OIDCKeyPublicationRequirements" id="OIDCKeyPublicationRequirements">Publication Requirements</a>
</h1>
<p id="rfc.section.10.8.1.p.1">If the Identity Provider meets all the requirements described below in Publication of New Signing Keys and Publication of New Client Secret, the Identity Provider SHOULD specify <samp>publish</samp> as a value in their list of <samp>oidc_key_rotation</samp> capabilities.  </p>
<h1 id="rfc.section.10.8.1.1">
<a href="#rfc.section.10.8.1.1">10.8.1.1.</a> <a href="#OIDCSigningKeyPublicationRequirements" id="OIDCSigningKeyPublicationRequirements">Publication of New Signing Keys</a>
</h1>
<p id="rfc.section.10.8.1.1.p.1">To publish new signing keys, the following requirements apply to the Identity Provider: </p>

<ul>
<li>MUST add a new key to the response value from the <samp>jwks_uri</samp> at least 14 days before prior keys expire.  </li>
<li>SHOULD wait at least 7 days after publishing a new key before using it for signing ID Tokens, to give consumers time to read the new key. MAY continue using the previous key if problems arise with the new key, to give time for diagnosis of the problems.  </li>
<li>SHOULD stop using the older key for signing ID Tokens when less than 1 day remains before the key expires.  </li>
<li>MUST support HTTP 1.1 ETag semantics <a href="#RFC2616" class="xref">[RFC2616]</a> for all requests to the <samp>jwks_uri</samp>, including: <ul>
<li>Returning an ETag response header </li>
<li>Accepting an If-None-Match request header, and returning an HTTP 304 response if the SAML Metadata is unmodified, </li>
</ul>
<p> </p>
</li>
<li>MAY return an HTTP 301 response code to indicate the <samp>jwks_uri</samp> has moved to a new location.  </li>
</ul>

<p> </p>
<h1 id="rfc.section.10.8.1.2">
<a href="#rfc.section.10.8.1.2">10.8.1.2.</a> <a href="#OIDCClientSecretPublicationRequirements" id="OIDCClientSecretPublicationRequirements">Publication of New Client Secret</a>
</h1>
<p id="rfc.section.10.8.1.2.p.1">To publish a new client_secret, the following requirements apply to the Identity Provider: </p>

<ul>
<li>MUST return a new <samp>client_secret</samp> in the response to queries against the <samp>registration_client_uri</samp>, as defined in Section 4 of <a href="#OpenID.Registration" class="xref">OpenID Connect Dynamic Client Registration 1.0</a> [OpenID.Registration].  </li>
<li>MUST make the new <samp>client_secret</samp> available for consumption at least 14 days before the prior <samp>client_secret</samp> is scheduled to expire.  </li>
<li>MUST continue accepting the previous <samp>client_secret</samp> until the expiration date.  </li>
<li>SHOULD alert the Administrator if the previous client_secret continues to be used and less than 7 days remains until expiration. The alert mechanism is an implementation detail that is outside the scope of the specification.  </li>
<li>MUST support HTTP 1.1 ETag semantics <a href="#RFC2616" class="xref">[RFC2616]</a> for all requests to the "registration_client_uri", including: <ul>
<li>Returning an ETag response header </li>
<li>Accepting an If-None-Match request header, and returning an HTTP 304 response if the SAML Metadata is unmodified, </li>
</ul>
<p> </p>
</li>
<li>MAY return an HTTP 301 response code to indicate the <samp>registration_client_uri</samp> has moved to a new location.  </li>
</ul>

<p> </p>
<h1 id="rfc.section.10.8.2">
<a href="#rfc.section.10.8.2">10.8.2.</a> <a href="#OIDCKeyConsumptionRequirements" id="OIDCKeyConsumptionRequirements">Publication Requirements</a>
</h1>
<p id="rfc.section.10.8.2.p.1">If the Application Provider meets all the requirements described below in Consumption of New Public Signing Keys and Consumption of New Client Secret, the Application Provider SHOULD specify <samp>consume</samp> as a value in their list of <samp>oidc_key_rotation</samp> capabilities.  </p>
<h1 id="rfc.section.10.8.2.1">
<a href="#rfc.section.10.8.2.1">10.8.2.1.</a> <a href="#OIDCSigningKeyConsumptionRequirements" id="OIDCSigningKeyConsumptionRequirements">Consumption of New Signing Keys</a>
</h1>
<p id="rfc.section.10.8.2.1.p.1">To consume new public signing keys, the following requirements apply to the Application Provider: </p>

<ul>
<li>MAY re-retrieve keys on demand by following the specifications defined in Section 10.1.1 <a href="#OpenID.Core" class="xref">OpenID Connect Core 1.0</a> [OpenID.Core].  </li>
<li>Alternatively, MAY preemptively re-retrieve keys by querying the <samp>jwks_uri</samp> on a recurring basis to check for updates. If this approach is taken, the Application Provider MUST re-retrieve the keys at least once every 24 hours. Because keys can be rotated at any time, the Application Provider MUST NOT wait for the expiration date to check for updated keys.  </li>
</ul>

<p> </p>
<p id="rfc.section.10.8.2.1.p.2">At least one of the above methods MUST be used to re-retrieve keys from the <samp>jwks_uri</samp>. Both methods MAY be used concurrently. In addition, the following requirements apply to the Application Provider: </p>

<ul>
<li>MUST include the If-None-Match header in the request to the <samp>jwks_uri</samp>, populated with the value of the ETag response header received when previously querying the <samp>jwks_uri</samp>.  </li>
<li>MUST handle an HTTP 304 response code which indicates that the content at the <samp>jwks_uri</samp> is unchanged.  </li>
<li>MUST handle an HTTP 301 response code and use the new location for all future queries against the <samp>jwks_uri</samp>.  </li>
<li>MUST accept OIDC ID Tokens signed using any of the valid keys contained in the response from the <samp>jwks_uri</samp>.  </li>
</ul>

<p> </p>
<h1 id="rfc.section.10.8.2.2">
<a href="#rfc.section.10.8.2.2">10.8.2.2.</a> <a href="#OIDCClientSecretConsumptionRequirements" id="OIDCClientSecretConsumptionRequirements">Consumption of New Client Secret</a>
</h1>
<p id="rfc.section.10.8.2.2.p.1">As background, when an Application Provider initially registers with an Identity Provider using OpenID Connect Dynamic Client Registration <a href="#OpenID.Registration" class="xref">[OpenID.Registration]</a>, the registration response contains the following attributes: </p>

<ul>
<li>client_secret </li>
<li>client_secret_expires_at </li>
<li>registration_client_uri </li>
</ul>

<p> </p>
<p id="rfc.section.10.8.2.2.p.2">To rotate the <samp>client_secret</samp>, the Application Provider will periodically re-query the Client Configuration Endpoint (located at the <samp>registration_client_uri</samp>) in order to re-read the current configuration. If a new <samp>client_secret</samp> has been issued, the new <samp>client_secret</samp> will appear in the response. The specifications for querying the Client Configuration Endpoint are described in Section 4 of <a href="#OpenID.Registration" class="xref">OpenID Connect Dynamic Client Registration 1.0</a> [OpenID.Registration].  </p>
<p id="rfc.section.10.8.2.2.p.3">To consume new values of <samp>client_secret</samp>, the following requirements apply to the Application Provider: </p>

<ul>
<li>MUST re-retrieve the client_secret from the <samp>registration_client_uri</samp> at least once every 24 hours.  Because secrets can be rotated at any time, the Application Provider MUST NOT wait for the expiration date to check for updated secrets.  </li>
<li>MUST include the If-None-Match header in the request to the <samp>registration_client_uri</samp>, populated with the value of the ETag response header received when previously querying the <samp>registration_client_uri</samp>.  </li>
<li>MUST handle an HTTP 304 response code which indicates that the content at the <samp>registration_client_uri</samp> is unchanged.  </li>
<li>MUST handle an HTTP 301 response code and use the new location for all future queries against the <samp>registration_client_uri</samp>.  </li>
<li>SHOULD use the new <samp>client_secret</samp> for OpenID Connect flows upon receiving an updated value. MAY temporarily revert to using the prior <samp>client_secret</samp> if the prior secret has not expired and unexpected problems arise from the new <samp>client_secret</samp>. This allows time for diagnosis of problems.  </li>
</ul>

<p> </p>
<h1 id="rfc.section.11">
<a href="#rfc.section.11">11.</a> <a href="#Interoperability" id="Interoperability">Interoperability Requirements</a>
</h1>
<p id="rfc.section.11.p.1">Each of the existing identity standards defines a set of optional features to enable usage in a wide variety of circumstances.  </p>
<p id="rfc.section.11.p.2">However, a consequence of the flexibility is that two Providers may find themselves incompabitible despite sharing the same protocols. For example, if an Application Provider chooses to require signed SAML Authentication requests, but the Identity Provider doesn't support this feature of SAML, the Providers are incompatible even though both use SAML.  </p>
<p id="rfc.section.11.p.3">To deliver the simplified Administrator experience that is the goal of FastFed, it is important that two FastFed-enabled Providers have confidence that they can interoperate when sharing the same protocols. To provide this confidence, this section describes the interoperability requirements for different protocols that a Provider must satisfy to be FastFed Compatible.  </p>
<h1 id="rfc.section.11.1">
<a href="#rfc.section.11.1">11.1.</a> <a href="#OIDCInteroperability" id="OIDCInteroperability">Interoperability for OIDC 1.0</a>
</h1>
<p id="rfc.section.11.1.p.1">A Provider who includes the value <samp>OIDC</samp> in the  <samp>sso_protocols_supported</samp> within their <a href="#ProviderMetadataCapabilities" class="xref">Metadata</a> will use the OpenID Connect authentication flows as defined in Section 3 of <a href="#OpenID.Core" class="xref">[OpenID.Core]</a>.  </p>
<p id="rfc.section.11.1.p.2">The following sections describe the subset of the OIDC specifications that Providers MUST implement to be FastFed Combatible for the OIDC SSO protocol. Providers MAY support additional functionality, but MUST NOT require the additional functionality when configuring federation with another Provider using the FastFed specifications.  </p>
<h1 id="rfc.section.11.1.1">
<a href="#rfc.section.11.1.1">11.1.1.</a> <a href="#OIDCInteroperabilityIdentityProviderReqs" id="OIDCInteroperabilityIdentityProviderReqs">Identity Provider Requirements</a>
</h1>
<p></p>

<ul>
<li>MUST implement the required functionality of an OpenID Provider as defined in the <a href="#OpenID.Core" class="xref">OpenID Connect Core 1.0</a> [OpenID.Core].  </li>
<li>MUST support the following flows: <ul>
<li>Authorization Code Flow (Section 3.1 of <a href="#OpenID.Core" class="xref">[OpenID.Core]</a>)</li>
<li>Implicit Flow (Section 3.2 of <a href="#OpenID.Core" class="xref">[OpenID.Core]</a>)</li>
<li>Hybrid Flow (Section 3.3 of <a href="#OpenID.Core" class="xref">[OpenID.Core]</a>
</li>
</ul>
<p> </p>
</li>
<li>MUST support returning OIDC Claims through the UserInfo Response and the ID Token (Section 5 of <a href="#OpenID.Core" class="xref">[OpenID.Core]</a>).  </li>
<li>MUST support the OIDC Client Authentication method <samp>client_secret_basic</samp> as defined in Section 9 of <a href="#OpenID.Core" class="xref">[OpenID.Core]</a>.  </li>
<li>MUST support ID Token signing using Asymetric Signatures with an <samp>alg</samp> value of <samp>RS256</samp>, as defined in Section 10.1 of <a href="#OpenID.Core" class="xref">[OpenID.Core]</a>.  </li>
<li>MUST support Initiating Login from a Third Party, as defined in Section 4 of <a href="#OpenID.Core" class="xref">[OpenID.Core]</a>.  </li>
<li>MUST implement the required functionality of an OpenID Provider as defined in <a href="#OpenID.Registration" class="xref">OpenID Connect Dynamic Client Registration 1.0</a> [OpenID.Registration].  </li>
<li>MUST implement the required functionality of an Open ID Provider as defined in Section 3 and Section 4 of <a href="#OpenID.Discovery" class="xref">OpenID Connect Discovery 1.0</a> [OpenID.Discovery] <ul>
<li>The property <samp>registration_endpoint</samp> in the OpenID Provider Metadata MUST contain the URL of the OP's Dynamic Client Registration Endpoint <a href="#OpenID.Registration" class="xref">[OpenID.Registration]</a>.  </li>
<li>The property <samp>token_endpoint_auth_methods_supported</samp> in the OpenID Provider Metadata must contain the value <samp>client_secret_basic</samp>.  </li>
</ul>
<p> </p>
</li>
<li>MUST specify all values in the OpenID Provider Configuration (Section 4 of <a href="#OpenID.Discovery" class="xref">[OpenID.Discovery]</a> that are necessary to implement the functionality described in this section.  </li>
<li>MUST specify the Issuer location for the OpenID Provider Configuration Information (as specified in Section 4 of <a href="#OpenID.Discovery" class="xref">[OpenID.Discovery]</a>) in the <samp>oidc_configuration_uri</samp> attribute in the Identity Provider's <a href="#MetadataOIDCExtensions" class="xref">Instance Metadata</a>.  </li>
</ul>

<p> </p>
<h1 id="rfc.section.11.1.2">
<a href="#rfc.section.11.1.2">11.1.2.</a> <a href="#OIDCInteroperabilityApplicationProviderReqs" id="OIDCInteroperabilityApplicationProviderReqs">Application Provider Requirements</a>
</h1>
<p></p>

<ul>
<li>MUST implement the required functionality of an OpenID Relying Party as defined in the <a href="#OpenID.Core" class="xref">OpenID Connect Core 1.0</a> [OpenID.Core].  </li>
<li>MAY use any of the following flows: <ul>
<li>Authorization Code Flow (Section 3.1 of <a href="#OpenID.Core" class="xref">[OpenID.Core]</a>)</li>
<li>Implicit Flow (Section 3.2 of <a href="#OpenID.Core" class="xref">[OpenID.Core]</a>)</li>
<li>Hybrid Flow (Section 3.3 of <a href="#OpenID.Core" class="xref">[OpenID.Core]</a>)</li>
</ul>
<p> </p>
</li>
<li>MAY retrieve Claims via the UserInfo Response or ID Token (Section 5 of <a href="#OpenID.Core" class="xref">[OpenID.Core]</a>) </li>
<li>MUST support the OIDC Client Authentication method <samp>client_secret_basic</samp> as defined in Section 9 of <a href="#OpenID.Core" class="xref">[OpenID.Core]</a>.  </li>
<li>MUST support ID Token signing using Asymetric Signatures with an <samp>alg</samp> value of <samp>RS256</samp>, as defined in Section 10.1 of <a href="#OpenID.Core" class="xref">[OpenID.Core]</a>.  </li>
<li>MAY support Initiating Login from a Third Party, as defined in Section 4 of <a href="#OpenID.Core" class="xref">[OpenID.Core]</a>.  </li>
<li>MUST dynamically register with the Identity Provider when enabling federation during the FastFed Handshake. To do so, the entity MUST implement the required functionality of an Open ID Client as defined in Section 3 of <a href="#OpenID.Registration" class="xref">[OpenID.Registration]</a>.  </li>
<li>MUST support the OAuth scheme for Provider Authorization as defined in <a href="#ProviderAuthzOAuth" class="xref">8.1</a>, and MUST present the OAuth 2.0 Access Token as a Bearer Token in the registration request, as defined in Section 3 of <a href="#OpenID.Discovery" class="xref">[OpenID.Discovery]</a>.  </li>
<li>MUST read the OpenID Provider Configuration (Section 4 of <a href="#OpenID.Discovery" class="xref">[OpenID.Discovery]</a> using the provided in the <samp>oidc_configuration_uri</samp> attribute in the Identity Provider's <a href="#MetadataOIDCExtensions" class="xref">Instance Metadata</a>.  <ul>
<li>MUST use the value of the <samp>registration_endpoint</samp> in the OpenID Provider Configuration <a href="#OpenID.Discovery" class="xref">[OpenID.Discovery]</a> when initiating dynamic registration with the Identity Provider <a href="#OpenID.Registration" class="xref">[OpenID.Registration]</a>.  </li>
<li>MAY use the information in the OpenID Provider Configuration <a href="#OpenID.Discovery" class="xref">[OpenID.Discovery]</a> to decide whether to use additional OpenID capabilities, above and beyond the FastFed minimum interoperablity requirements. The additional capabilities must be optional and the federation MUST still succeed if one Provider does not support the additional capabilities.  </li>
</ul>
<p> </p>
</li>
</ul>

<p> </p>
<h1 id="rfc.section.11.2">
<a href="#rfc.section.11.2">11.2.</a> <a href="#SAMLInteroperability" id="SAMLInteroperability">Interoperability for SAML 2.0</a>
</h1>
<p id="rfc.section.11.2.p.1">A Provider who includes the value <samp>SAML</samp> in the  <samp>sso_protocols_supported</samp> within their <a href="#ProviderMetadataCapabilities" class="xref">Metadata</a> will use the SAML 2.0 Web Browser SSO Profile as defined in Section 4.1 of <a href="#SAML.Profiles" class="xref">[SAML.Profiles]</a>.  </p>
<p id="rfc.section.11.2.p.2">The following sections describe the subset of the SAML specifications that Providers MUST implement to be FastFed Compatible for the SAML SSO protocol. Providers MAY support additional functionality, but MUST NOT require the additional functionality when configuring federation with another Provider using the FastFed specifications.  </p>
<h1 id="rfc.section.11.2.1">
<a href="#rfc.section.11.2.1">11.2.1.</a> <a href="#SAMLInteroperabilityIdentityProviderReqs" id="SAMLInteroperabilityIdentityProviderReqs">Identity Provider Requirements</a>
</h1>
<p id="rfc.section.11.2.1.p.1">SAML Requirements for Identity Providers: </p>

<ul>
<li>MUST implement the required functionality of a SAML Identity Provider as defined in the SAML Web Browser SSO Profile (Section 4.1 of <a href="#SAML.Profiles" class="xref">[SAML.Profiles]</a>).  </li>
<li>MUST support the HTTP Redirect and HTTP POST bindings for the Web Browswer SSO Profile.  </li>
<li>MUST use X509 Certificates for the Signature element containined within the Assertion element of the SAML Response object. As background, this response is returned from the SAML Identity Provider to the SAML Service Provider as part of the SAML Web Browser SSO Profile.  </li>
<li>MUST host a SAML Metadata document at the location specified by the <samp>saml_metadata_uri</samp> attribute within the Identity Provider <a href="#MetadataSAMLExtensions" class="xref">Instance Metadata</a> document.  </li>
<li>MUST include an IDPSSODescriptor element in the SAML Metadata document as specified in <a href="#SAML.Metadata" class="xref">[SAML.Metadata]</a>.  </li>
<li>MUST populate the IDPSSODescriptor element with all values needed by a SAML Service Provider to integrate with this SAML Identity Provider using the capabilities described in this section.  </li>
</ul>

<p> </p>
<h1 id="rfc.section.11.2.2">
<a href="#rfc.section.11.2.2">11.2.2.</a> <a href="#SAMLInteroperabilityApplicationProviderReqs" id="SAMLInteroperabilityApplicationProviderReqs">Application Provider Requirements</a>
</h1>
<p id="rfc.section.11.2.2.p.1">SAML Requirements for Application Providers: </p>

<ul>
<li>MUST implement the required functionality of a SAML Service Provider as defined in the SAML Web Browser SSO Profile (Section 4.1 of <a href="#SAML.Profiles" class="xref">[SAML.Profiles]</a>).  </li>
<li>MUST use either the HTTP Redirect or HTTP POST binding for the Web Browswer SSO Profile.  </li>
<li>MUST accept X509 Certificates for the Signature element containined within the Assertion element of the SAML Response object. As background, this response is returned from the SAML Identity Provider to the SAML Service Provider as part of the SAML Web Browser SSO Profile.  </li>
<li>MUST host a SAML Metadata document at the location specified by the <samp>saml_metadata_uri</samp> attribute within the Identity Provider <a href="#MetadataSAMLExtensions" class="xref">Instance Metadata</a> document.  </li>
<li>MUST include an SPSSODescriptor element in the SAML Metadata document as specified in <a href="#SAML.Metadata" class="xref">[SAML.Metadata]</a>.  </li>
<li>MUST populate the SPSSODescriptor with all values needed by a SAML Identity Provider to integrate with this SAML Service Provider using the capabilities described in this section.  </li>
<li>MAY use the information in the Identity Provider's corresponding SAML Metadata document to decide whether to use additional SAML capabilities, above and beyond the FastFed minimum interoperablity requirements. The additional capabilities must be optional and the federation MUST still succeed if one Provider does not support the additional capabilities.  </li>
</ul>

<p> </p>
<h1 id="rfc.section.11.3">
<a href="#rfc.section.11.3">11.3.</a> <a href="#SCIMInteroperability" id="SCIMInteroperability">Interoperability for SCIM 2.0</a>
</h1>
<p><strong>SEE COMMENT: </strong> <a id="CREF3" class="info">[CREF3]<span class="info">Darin McAdams: This section is weak. Primarely borrowed from the existing implementations of IDaaS providers. Seeking input on the best current practices for user provisioning into hosted applications.  </span></a> </p>
<p id="rfc.section.11.3.p.2">A Provider who includes the value <samp>SCIM</samp> in the  <samp>user_provisioning_modes_supported</samp> within their <a href="#ProviderMetadataCapabilities" class="xref">Provider Metadata</a> will use the SCIM Protocol as defined in <a href="#RFC7644" class="xref">[RFC7644]</a>.  </p>
<p id="rfc.section.11.3.p.3">The following sections describe the subset of the SCIM Protocol specifications that Providers MUST implement to be FastFed Combatible for SCIM provisioning. Providers MAY support additional functionality, but MUST NOT require the additional functionality when configuring federation with another Provider using the FastFed specifications.  </p>
<h1 id="rfc.section.11.3.1">
<a href="#rfc.section.11.3.1">11.3.1.</a> <a href="#SCIMInteroperabilityIdentityProviderReqs" id="SCIMInteroperabilityIdentityProviderReqs">Identity Provider Requirements</a>
</h1>
<p id="rfc.section.11.3.1.p.1">SCIM requirements for Identity Providers: </p>

<ul>
<li>MUST implement the required functionality of a SCIM Client as defined in <a href="#RFC7643" class="xref">[RFC7643]</a> and <a href="#RFC7644" class="xref">[RFC7644]</a>.  </li>
<li>For each end-user that is authorized to access the Application: <ul>
<li>MUST replicate end-user information to the Application Provider within 60 minutes of an active end-user being created or updated.  <br><br> The Identity Provider MAY use any combination of the following operations to provision user information: <ul>
<li>Create account via <em>POST /Users</em>
</li>
<li>Update account details via <em>PUT /Users/{id}</em>
</li>
<li>Read list of accounts via <em>GET /Users</em>
</li>
<li>Read account details via <em>GET /Users/{id}</em>
</li>
<li>Filtering on <em>userName eq</em>
</li>
</ul>
<p> </p>
</li>
<li>MUST replicate end-user deactivation to the Application within 5 minutes of the user being deactivated within the Identity Provider.  <br><br> The Identity Provider MAY use any combination of the following operations to deactivate users in the Application: <ul>
<li>Deactivate account via <em>PATCH /Users{id}</em>
</li>
<li>Read list of accounts via <em>GET /Users</em>
</li>
<li>Read account details via <em>GET /Users/{id}</em>
</li>
<li>Filtering on <em>userName eq</em>
</li>
</ul>
<p> </p>
</li>
</ul>
<p> </p>
</li>
</ul>

<p> </p>
<h1 id="rfc.section.11.3.2">
<a href="#rfc.section.11.3.2">11.3.2.</a> <a href="#SCIMInteroperabilityApplicationProviderReqs" id="SCIMInteroperabilityApplicationProviderReqs">Application Provider Requirements</a>
</h1>
<p id="rfc.section.11.3.2.p.1">SCIM requirements for Application Providers: </p>

<ul>
<li>MUST implement the required functionality of a SCIM Service Provider as defined in <a href="#RFC7643" class="xref">[RFC7643]</a> and <a href="#RFC7644" class="xref">[RFC7644]</a>.  </li>
<li>MUST support the following operations: <ul>
<li>Create account via <em>POST /Users</em>
</li>
<li>Update account details via <em>PUT /Users/{id}</em>
</li>
<li>Deactivate account via <em>PATCH /Users{id}</em>
</li>
<li>Read list of accounts via <em>GET /Users</em>
</li>
<li>Read account details via <em>GET /Users/{id}</em>
</li>
<li>Filtering on <em>userName eq</em>
</li>
</ul>
<p> </p>
</li>
<li>SHOULD respond to account deactivation by revoking the ability for the end-user to use the Application, even if that end-user has an active session with an expiration date in the future. The means of revocation are an implementation detail and outside the scope of this specification. Revocation should occur within 5 minutes of receiving the deactivation.  </li>
</ul>

<p> </p>
<h1 id="rfc.section.12">
<a href="#rfc.section.12">12.</a> <a href="#FastFedCompatibilityDescriptions" id="FastFedCompatibilityDescriptions">FastFed Compatibility Descriptions</a>
</h1>
<p id="rfc.section.12.p.1">A Provider who meets the requirements defined in this specification MAY describe themselves as "FastFed Compatible".  </p>
<p id="rfc.section.12.p.2">Since FastFed allows Providers to pick-and-choose from a variety of different protocols, Providers SHOULD include the supported protocols when describing their compatibility.  </p>
<p>The following is a non-normative example of a FastFed Compatibility description for an Application Provider: </p>
<pre>
 This application is FastFed Compatible with Identity Providers who support
 the following:
   * SSO Protocol: SAML
   * User Schema: SCIM User
   * Provisioning Mode: Just In Time (JIT) provisoning
   
 In addition, this application supports automatic SAML certificate rotation if
 enabled by the Identity Provider.
</pre>
<p>The following is a non-normative example of a FastFed Compatibility description for an Identity Provider: </p>
<pre>
 This Identity Provider is FastFed Compatible with the following:
   * Any of the following SSO Protocols
     - SAML
     - OpenID Connect
   * Any of the following User Schemas:
     - SCIM User
     - SCIM Enterprise User
   * Any of the following User Provisioning Modes:
     - SCIM provisioning
     - Just In Time provisioning
     - Custom provisioning
     - No provisioning

 In addition, if supported by an application, this Identity Provider will
 automatically perform SAML certificate rotation and OIDC key rotation.
</pre>
<h1 id="rfc.section.13">
<a href="#rfc.section.13">13.</a> <a href="#Security" id="Security">Security Considerations</a>
</h1>
<p id="rfc.section.13.p.1">TODO. See comments in <a href="#HandshakeIdentityProviderResponse" class="xref">7.2.1.7</a> </p>
<h1 id="rfc.section.14">
<a href="#rfc.section.14">14.</a> <a href="#IANA" id="IANA">IANA Considerations</a>
</h1>
<p id="rfc.section.14.p.1">TODO </p>
<h1 id="rfc.references">
<a href="#rfc.references">15.</a> Normative References</h1>
<table><tbody>
<tr>
<td class="reference"><b id="OpenID.Core">[OpenID.Core]</b></td>
<td class="top">
<a title="Nomura Research Institute, Ltd.">Sakimura, N.</a>, <a title="Ping Identity">Bradley, J.</a>, <a title="Microsoft">Jones, M.</a>, <a title="Google">de Medeiros, B.</a> and <a title="Salesforce">C. Mortimore</a>, "<a href="http://openid.net/specs/openid-connect-core-1_0.html">OpenID Connect Core 1.0</a>", November 2014.</td>
</tr>
<tr>
<td class="reference"><b id="OpenID.Discovery">[OpenID.Discovery]</b></td>
<td class="top">
<a title="Nomura Research Institute, Ltd.">Sakimura, N.</a>, <a title="Ping Identity">Bradley, J.</a>, <a title="Microsoft">Jones, M.</a> and <a title="Illumila">E. Jay</a>, "<a href="http://openid.net/specs/openid-connect-discovery-1_0.html">OpenID Connect Discovery 1.0</a>", November 2014.</td>
</tr>
<tr>
<td class="reference"><b id="OpenID.Registration">[OpenID.Registration]</b></td>
<td class="top">
<a title="Nomura Research Institute, Ltd.">Sakimura, N.</a>, <a title="Ping Identity">Bradley, J.</a> and <a title="Microsoft">M. Jones</a>, "<a href="http://openid.net/specs/openid-connect-registration-1_0.html">OpenID Connect Dynamic Client Registration 1.0</a>", November 2014.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2119">[RFC2119]</b></td>
<td class="top">
<a>Bradner, S.</a>, "<a href="https://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>", BCP 14, RFC 2119, DOI 10.17487/RFC2119, March 1997.</td>
</tr>
<tr>
<td class="reference"><b id="RFC2616">[RFC2616]</b></td>
<td class="top">
<a>Fielding, R.</a>, <a>Gettys, J.</a>, <a>Mogul, J.</a>, <a>Frystyk, H.</a>, <a>Masinter, L.</a>, <a>Leach, P.</a> and <a>T. Berners-Lee</a>, "<a href="https://tools.ietf.org/html/rfc2616">Hypertext Transfer Protocol -- HTTP/1.1</a>", RFC 2616, DOI 10.17487/RFC2616, June 1999.</td>
</tr>
<tr>
<td class="reference"><b id="RFC3986">[RFC3986]</b></td>
<td class="top">
<a>Berners-Lee, T.</a>, <a>Fielding, R.</a> and <a>L. Masinter</a>, "<a href="https://tools.ietf.org/html/rfc3986">Uniform Resource Identifier (URI): Generic Syntax</a>", STD 66, RFC 3986, DOI 10.17487/RFC3986, January 2005.</td>
</tr>
<tr>
<td class="reference"><b id="RFC4627">[RFC4627]</b></td>
<td class="top">
<a>Crockford, D.</a>, "<a href="https://tools.ietf.org/html/rfc4627">The application/json Media Type for JavaScript Object Notation (JSON)</a>", RFC 4627, DOI 10.17487/RFC4627, July 2006.</td>
</tr>
<tr>
<td class="reference"><b id="RFC5646">[RFC5646]</b></td>
<td class="top">
<a>Phillips, A.</a> and <a>M. Davis</a>, "<a href="https://tools.ietf.org/html/rfc5646">Tags for Identifying Languages</a>", BCP 47, RFC 5646, DOI 10.17487/RFC5646, September 2009.</td>
</tr>
<tr>
<td class="reference"><b id="RFC6125">[RFC6125]</b></td>
<td class="top">
<a>Saint-Andre, P.</a> and <a>J. Hodges</a>, "<a href="https://tools.ietf.org/html/rfc6125">Representation and Verification of Domain-Based Application Service Identity within Internet Public Key Infrastructure Using X.509 (PKIX) Certificates in the Context of Transport Layer Security (TLS)</a>", RFC 6125, DOI 10.17487/RFC6125, March 2011.</td>
</tr>
<tr>
<td class="reference"><b id="RFC6749">[RFC6749]</b></td>
<td class="top">
<a>Hardt, D.</a>, "<a href="https://tools.ietf.org/html/rfc6749">The OAuth 2.0 Authorization Framework</a>", RFC 6749, DOI 10.17487/RFC6749, October 2012.</td>
</tr>
<tr>
<td class="reference"><b id="RFC6750">[RFC6750]</b></td>
<td class="top">
<a>Jones, M.</a> and <a>D. Hardt</a>, "<a href="https://tools.ietf.org/html/rfc6750">The OAuth 2.0 Authorization Framework: Bearer Token Usage</a>", RFC 6750, DOI 10.17487/RFC6750, October 2012.</td>
</tr>
<tr>
<td class="reference"><b id="RFC7643">[RFC7643]</b></td>
<td class="top">
<a>Hunt, P.</a>, <a>Grizzle, K.</a>, <a>Wahlstroem, E.</a> and <a>C. Mortimore</a>, "<a href="https://tools.ietf.org/html/rfc7643">System for Cross-domain Identity Management: Core Schema</a>", RFC 7643, DOI 10.17487/RFC7643, September 2015.</td>
</tr>
<tr>
<td class="reference"><b id="RFC7644">[RFC7644]</b></td>
<td class="top">
<a>Hunt, P.</a>, <a>Grizzle, K.</a>, <a>Ansari, M.</a>, <a>Wahlstroem, E.</a> and <a>C. Mortimore</a>, "<a href="https://tools.ietf.org/html/rfc7644">System for Cross-domain Identity Management: Protocol</a>", RFC 7644, DOI 10.17487/RFC7644, September 2015.</td>
</tr>
<tr>
<td class="reference"><b id="SAML.Assertions">[SAML.Assertions]</b></td>
<td class="top">
<a title="Internet2">Cantor, S.</a>, <a title="Nokia">Kemp, J.</a>, <a title="RSA Security">Philpott, R.</a> and <a title="Sun Microsystems">E. Maler</a>, "<a href="http://docs.oasis-open.org/security/saml/v2.0/saml-core-2.0-os.pdf">Assertions and Protocols for the OASIS Security Assertion Markup Language (SAML) V2.0</a>", March 2005.</td>
</tr>
<tr>
<td class="reference"><b id="SAML.Interoperability">[SAML.Interoperability]</b></td>
<td class="top">
<a title="Internet2">Cantor, S.</a>, <a title="Nokia">Kemp, J.</a>, <a title="RSA Security">Philpott, R.</a> and <a title="Sun Microsystems">E. Maler</a>, "<a href="https://www.oasis-open.org/committees/download.php/36645/draft-sstc-metadata-iop-2.0-01.pdf">SAML V2.0 Metadata Interoperability Profile Version 1.0</a>", August 2009.</td>
</tr>
<tr>
<td class="reference"><b id="SAML.Metadata">[SAML.Metadata]</b></td>
<td class="top">
<a title="Internet2">Cantor, S.</a>, <a title="Sigaba">Moreh, J.</a>, <a title="RSA Security">Philpott, R.</a> and <a title="Sun Microsystems">E. Maler</a>, "<a href="http://docs.oasis-open.org/security/saml/v2.0/saml-metadata-2.0-os.pdf">Metadata for the OASIS Security Assertion Markup Language (SAML) V2.0</a>", March 2005.</td>
</tr>
<tr>
<td class="reference"><b id="SAML.Profiles">[SAML.Profiles]</b></td>
<td class="top">
<a title="Atos Origin">Hughes, J.</a>, <a title="Internet2">Cantor, S.</a>, <a title="Neustar">Hodges, J.</a>, <a title="Nokia">Hirsch, F.</a>, <a title="Principal Identity">Mishra, P.</a>, <a title="RSA Security">Philpott, R.</a> and <a title="Sun Microsystems">E. Maler</a>, "<a href="http://docs.oasis-open.org/security/saml/v2.0/saml-profiles-2.0-os.pdf">Profiles for the OASIS Security Assertion Markup Language (SAML) V2.0"</a>", March 2005.</td>
</tr>
<tr>
<td class="reference"><b id="W3C.REC-html401-19991224">[W3C.REC-html401-19991224]</b></td>
<td class="top">
<a title="W3C">Raggett, D.</a>, <a title="W3C">Hors, A.</a> and <a title="W3C">I. Jacobs</a>, "<a href="https://www.w3.org/TR/1999/REC-html401-19991224">HTML 4.01 Specification</a>", December 1999.</td>
</tr>
</tbody></table>
<h1 id="rfc.appendix.A">
<a href="#rfc.appendix.A">Appendix A.</a> <a href="#Acknowledgements" id="Acknowledgements">Acknowledgements</a>
</h1>
<p id="rfc.section.A.p.1">The OpenID Community would like to thank the following people for their contributions to this specification: </p>
<p></p>

<ul class="empty"><li>TODO</li></ul>

<p> </p>
<h1 id="rfc.appendix.B">
<a href="#rfc.appendix.B">Appendix B.</a> <a href="#Notices" id="Notices">Notices</a>
</h1>
<p id="rfc.section.B.p.1">Copyright (c) 2017 The OpenID Foundation.</p>
<p id="rfc.section.B.p.2">The OpenID Foundation (OIDF) grants to any Contributor, developer, implementer, or other interested party a non-exclusive, royalty free, worldwide copyright license to reproduce, prepare derivative works from, distribute, perform and display, this Implementers Draft or Final Specification solely for the purposes of (i) developing specifications, and (ii) implementing Implementers Drafts and Final Specifications based on such documents, provided that attribution be made to the OIDF as the source of the material, but that such attribution does not indicate an endorsement by the OIDF.</p>
<p id="rfc.section.B.p.3">The technology described in this specification was made available from contributions from various sources, including members of the OpenID Foundation and others. Although the OpenID Foundation has taken steps to help ensure that the technology is available for distribution, it takes no position regarding the validity or scope of any intellectual property or other rights that might be claimed to pertain to the implementation or use of the technology described in this specification or the extent to which any license under such rights might or might not be available; neither does it represent that it has made any independent effort to identify any such rights. The OpenID Foundation and the contributors to this specification make no (and hereby expressly disclaim any) warranties (express, implied, or otherwise), including implied warranties of merchantability, non-infringement, fitness for a particular purpose, or title, related to this specification, and the entire risk as to implementing this specification is assumed by the implementer. The OpenID Intellectual Property Rights policy requires contributors to offer a patent promise not to assert certain patent claims against other contributors and against implementers. The OpenID Foundation invites any interested party to bring to its attention any copyrights, patents, patent applications, or other proprietary rights that may cover technology that may be required to practice this specification.</p>
<h1 id="rfc.appendix.C">
<a href="#rfc.appendix.C">Appendix C.</a> <a href="#History" id="History">Document History</a>
</h1>
<p id="rfc.section.C.p.1">[[ To be removed from the final specification ]]</p>
<h1 id="rfc.authors"><a href="#rfc.authors">Author's Address</a></h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Darin K. McAdams</span> 
	  <span class="n hidden">
		<span class="family-name">McAdams</span>
	  </span>
	</span>
	<span class="org vcardline">Amazon</span>
	<span class="adr">
	  
	  <span class="vcardline">
		<span class="locality"></span> 
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline"></span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:darinm@amazon.com">darinm@amazon.com</a></span>

  </address>
</div>

</body>
</html>
